---
twocol: FALSE  #  Use FALSE for submission. 
title: Title here
author1: 
  name: Elio Campitelli
  email: elio.campitelli@cima.fcen.uba.ar
author2: 
  name: Leandro DÃ­az
affiliation: "CIMA UBA blablabla"
extra_authors: 
  - name: Carolina Vera
abstract: |
  Enter the text of your abstract here. This is a sample American Meteorological Society (AMS) \LaTeX\ template.  This document provides authors with instructions on the use of the AMS \LaTeX\ template.  Authors should refer to the file amspaper.tex to review the actual \LaTeX\ code used to create this document. The template.tex file should be modified by authors for their own manuscript.
statement: |
  This is significant becasue I wrote it.
bibliography: AsymSAM.bib
output: 
  rticles::ams_article:
    latex_engine: "xelatex"
header-includes: 
 - \usepackage{gensymb}
 - \usepackage{subfig}
 - \usepackage[inline]{showlabels}
---

```{r setup, echo = FALSE,warning=FALSE, message = FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  fig.path = "",
  message = FALSE,
  warning = FALSE,
  cache = TRUE,
  cache.extra = 42,
  cache.path = "../cache/",
  collapse = TRUE,
  comment = "#>",
  dpi = 300,
  out.extra = ""
)
library(metR)
library(data.table)
library(ggplot2)
library(magrittr)
library(ggperiodic)
library(asymsam)
library(latex2exp)
library(tagger)

theme_set(theme_asymsam(base_size = 9))
ZeroBreaks <- AnchorBreaks(0, NULL, 0)
axis_labs_smol <- theme(axis.text = element_text(size = 6))
lev.lab <- AddSuffix(" hPa")
no_grid <- theme(panel.grid = element_blank()) 

guide_colorstrip_bottom <- function(width = 25, height = 0.5, ...) {
  guide_colorstrip(title.position = "top", title.hjust = 0.5,
                   barheight = height,
                   barwidth = width, ...)
}


knitr::opts_hooks$set(invisible = function(options) {
  options$include = FALSE
  options
})

main_levs <- c(700, 300, 30, 50)

combine_lists <- function(...) {
  # browser(expr = length(x) != length(y))
  X <- list(...)
  names <- names(X[[1]])
  names(names) <- names
  lapply(names, function(n) {
    unlist(lapply(X, function(x) x[[n]]))
  })
}

lab_sam <-  c(full = "Full", 
              asym = "Asymmetric",
              sym  = "Symmetric")
```


<!-- The actual document text starts here: -->

# Introduction 

yada yada SAM yada yada circulation.. yada yada so important. yada yada many impacts. 


@fogt2012 studied the characteristics of the asymmetric structure of the SAM. It computed the zonally anomalous component of mean sea level pressure (MSLP) composites for positive and negative SAM events and created two indices by projecting MSLP fields ontno them. However, the use of composites leads to some issues that affects the interpretability of the results. First, they can be dependent on the choice of threshold used to define positive and negative events. Secondly, by discarting data that don't meet the threshold, they don't use all the information avaiable. Due to the realtive short timeframe used, this leads to some composites being composed of as little as 4 years. Third, the resulting composites corresponding to each polarity and season are derived from the average of different amount of fields and from different years. This last issue is particularly important in light of the changing structure of the SAM before and after 1980 [@silvestri2009]. In @fogt2012, the DJF SAM+ composite uses only 7 years, 5 of which are later than 1988, whereas all of the 8 years used for their DJF SAM- composite are from earlier than 1988. 


```{r read-hgt}
hgt <- ReadNetCDF(ERA5(), 
                  subset = list(time = c("1979-01-01", "2018-12-31"),
                                latitude = c(-90, 10),
                                level = as.list(main_levs)),
                  vars = c(hgt = "z")) %>% 
  normalise_coords() %>% 
  .[, hgt := hgt/9.8] %>% 
  .[, hgt_a := hgt - mean(hgt), by = .(lon, lat, lev, month(time))]
```

```{r compute-SAM}
SAM <- hgt[lat <= -20] %>% 
  .[lev == 700] %>% 
  .[, hgt := hgt_a*sqrt(cos(lat*pi/180))] %>% 
  .[, .(eof = list(EOF(hgt ~ time | lon + lat, n = 1, data = .SD))), 
    by = .(lev)]

dims <- hgt[lat <= -20] %>% 
  .[, .(x = uniqueN(lon), y = uniqueN(lat), t = uniqueN(time))]
```

# Methods

### Definition of indices

We defined the Southern Annular Mode (SAM) as the leading EOF of the monthly anomalies of geopotential field at 700 hPa south of 20\degree S (citation?). The EOF was performed by computing the Singular Value Decomposition of the data matrix consisting in `r dims$t` rows and  `r dims$x*dims$y` columns (`r dims$x` points of longitude and `r dims$y` points of latitude). The values where weighted by the square root of the cosine of latitude to account for the non-equal area of each gridpoint [@chung1999]. This same method was used at the rest of the levels considered in this paper. 

To separate between the zonally symmetric and asymmetric components of the SAM, we computed the zonal mean and anomalies of the full SAM spatial pattern. The results are shown in Figure\ \ref{fig:method} for 700hPa. The full spatial signal ($\mathrm{EOF_1}(\lambda, \phi)$) is the sum of the zonally asymmetric ($\mathrm{EOF_1^*}(\lambda, \phi)$) and symmetric ($[\mathrm{EOF_1}](\lambda, \phi)$) components. We then compute the "Full", "Asymmetric" and "Symmetric" indices, by regressing each geopotential field on these patterns (weighting by the cosine of latitude).

The three indices are normalised by dividing them by the standard deviation of the "Full" index at each level. This means that comparing the magnitude between indices is meaningful, but it also means that not every index will have unit standard deviation. 

```{r method, fig.cap = "Spatial patterns of the first EOF of 700 hPa geopotential height. Full field (left), zonally asymmetric component (middle) and zonally symmetric component (right). Arbitrary units.", fig.width=6, fig.height=2.5, fig.env="figure*"}
sam_sep <- SAM[, eof[[1]]$right, by = .(lev)] %>% 
  setnames("hgt", "full") %>% 
  .[, c("sym", "asym") := list(mean(full), Anomaly(full)), by = .(lat, lev)] 


lab_eof <- c(full = TeX("$\\mathrm{EOF_1}(\\lambda, \\phi)$"),
             asym = TeX("$\\mathrm{EOF_1}^*(\\lambda, \\phi)$"), 
             sym  = TeX("$\\[\\mathrm{EOF_1}\\](\\lambda, \\phi)$"))

sam_plot <- sam_sep %>% 
  .[lev %in% c(700)] %>%
  rm_singleton() %>% 
  melt(id.vars = c("lon", "lat")) %>% 
  .[, value := value + rnorm(.N, sd = 1e-6)] %>% 
  .[, variable := factor(variable, levels = names(lab_sam), ordered = TRUE)] 

levels(sam_plot$variable) <- lab_eof

sam_plot %>% 
  periodic(lon = c(0, 360)) %>%
  ggplot(aes(lon, lat)) +
  # geom_contour(aes(z = value, linetype = factor(-sign(..level..))), global.breaks = FALSE) +
  geom_contour_fill(aes(z = value), global.breaks = FALSE, breaks = ZeroBreaks) +
  geom_contour_tanaka(aes(z = value), global.breaks = FALSE, breaks = ZeroBreaks) +
  geom_qmap() +
  scale_x_longitude() +
  scale_y_latitude(limits = c(NA, -20), labels = NULL) +
  scale_fill_divergent(guide = "none", high = "#731C1F", low = "#323071") +
  scale_fill_divergent(guide = "none") +
  coord_polar() +
  facet_grid(.~variable, labeller = labeller(variable = label_parsed, lev = lev.lab)) +
  axis_labs_smol +
  no_grid +
  tag_facets()
```



### Data 

We used monthly geopotential height at 2.5 longitude by 2.5 latitude resolution from ERA5 [@hersbach2020.] for the period 1979 to 2018.

Monthly temperature NOAA Global Surface Temperature (NOAAGlobalTemp) 5.0 degree latitude x 5.0 degree longitude global grid [@vose2012; @smith2008]. The same analysis was carried out using CRUTEM4 [@osborn2014] (not shown). 

We used monthly precipitation data from CPC Merged Analysis of Precipitation [@xie1997] 2.5 degree latitude x 2.5 degree longitude. CPCC: [schneider2015]  #FIXME


### Regressions

Explain multiple regression interpretation #FIXME.

We adjusted p-values for False Detection Rate following @wilks2016. 


# Results


## Temporal evolution

```{r compute-asymsam}
indices_file <- data_path("derived", "indices.Rds")
if (file.exists(indices_file)) {
  indices <- readRDS(indices_file)
  indices[, `:=`(estimate = -estimate, estimate_norm = -estimate_norm)]
} else {
  stop("Run 02-compute-eofs.R")
}

indices_wide <- dcast(indices, + lev + time ~ term, value.var = "estimate_norm")
```

```{r test-aao}
# test that my indices hace the correct sign. The Full index needs to be **positively** correlated
# with the AAO index.
aao <- rsoi::download_aao(TRUE, data_path("raw", "aao.csv")) %>% 
  as.data.table() %>% 
  .[, .(time = lubridate::as_datetime(Date), aao = AAO)]

cor_aao <- indices[term == "full" & lev == 700] %>% 
  .[aao, on = .NATURAL] %>% 
  na.omit() %>% 
  .[, cor(estimate, aao)] 

if (sign(cor_aao) != 1) {
  stop("AAO and full index are not positively correlated!")
}
```


```{r asymsam-timeseries, fig.cap = "Time series for the asymmetric SAM and symmetric SAM and density estimates.", fig.width=6, fig.height=3, fig.env="figure*"}
indices %>% 
  .[lev %in% c(50, 700) & term != "full"] %>% 
  # .[, estimate_norm := estimate_norm/sd(estimate_norm), by = .(lev, term)] %>% 
  ggplot(aes(time, estimate_norm)) +
  geom_line(aes(color = term)) +
  ggridges::geom_vridgeline(stat="ydensity", scale = -4e8, fill = NA,
                            aes(color = term, width = ..density.., x = min(time - 1e7))) +
  # geom_smooth(aes(color = term), method = "loess", n = 481, span = 10*12/481, method.args = list(degree = 1)) +
  # geom_point(data = ~.x[lev == 50][time == as.Date("1987-11-01") & term == "sym" | 
  #                         time == as.Date("1987-08-01") & term == "asym"]) +
  ggforce::geom_mark_circle(data = ~.x[lev == 50][time == as.Date("1987-11-01") & term == "sym" | 
                                                    time == as.Date("1987-08-01") & term == "asym"],
                            expand = unit(2, "mm")) +
  scale_color_brewer(NULL, palette = "Dark2", labels = lab_sam) +
  scale_y_continuous(NULL) +
  # scale_x_datetime(NULL, expand = c(0, 0)) +
  facet_grid(lev~., labeller = labeller(lev = lev.lab)) +
  tag_facets()
```


Figure \ref{fig:asymsam-timeseries} shows the Asymmetric and Symmetric time series corresponding to 700 and 50hPa. At first glance the series can be distinguished by their distributions. Whereas the tropospheric incides are aproximately normally distributed, the stratospheric indices are more long-tailed; that is, extreme values (both negative and positive) abound. The Asymmetric series have both more variability in the higher frequencies than the Symmetric series.

The stratospheric Symmetric SAM varies strongly witha two-year period, which can be seen using spectral methods (Figure A3) or in the autocorrelation structure (Figure A4). There is a local peak at 2 years in the periodigram of the tropospheric Symmetric SAM also, although it's not statistically significant. In the troposphere the most significant peak of variability is found in the Asymmetric index at around `r 12*.3` months. 

```{r compute-cors}
ccf_dt <- function(..., plot = FALSE) {
  stat <- ccf(..., plot = plot)
  list(lag = stat$lag[, 1, 1], 
       acf = stat$acf[, 1, 1])
}

cors <- indices_wide %>% 
  .[, ccf_dt(asym, sym, lag.max = 5), by = .(lev)]
```

From Figure \ref{fig:asymsam-timeseries} we can see that the Asymemtric and Symmetric time series appear to be correlated. Moreover, looking at the extremes in the stratosphere, the Symmetric serie appears to lag the Asymmetric series (see, for example, the positive events on late 1987 marked with a circle). We show these correlations, across all the levels of the reanalysis and for zero and -1 lag (Asymmetric index leading the Symmetric index), in Figure \ref{fig:cor-lev}. 

```{r cor-lev, fig.cap = "Correlation between the Symmetric and Asymmetric SAM at each level for lag zero and lag -1 (Asymmetric leads Symmetric).", fig.width=3, fig.height=3}
cors %>% 
  .[lag %in% c(0, -1)] %>% 
  ggplot(aes(lev, acf)) +
  geom_line(aes(color = factor(lag, levels = c(0, -1), ordered = TRUE),
                linetype = factor(lag, levels = c(0, -1), ordered = TRUE))) +
  scale_x_level() +
  scale_y_continuous("Correlation", limits = c(0, 1)) + 
  scale_linetype_manual(NULL, values = c(1, 5), labels = c("0" = "Zero-lag", 
                                                           "-1" = "Asymmetric leads\nSymmetric (1 month)")) +
  scale_color_brewer(NULL, palette = "Dark2", labels = c("0" = "Zero-lag", 
                                                         "-1" = "Asymmetric leads\nSymmetric (1 month)")) +
  coord_flip()
```


Zero-lag correlations between the Asymmetric and Symmetric series are relatively constant throught the troposphere, fluctiating between `r signif(cors[lag == 0 & lev >= 100, min(acf)], 2)` and `r signif(cors[lag == 0 & lev >= 100, max(acf)], 2)`. One-month-lag correlations are similarly constant but significantly reduced, hovering around `r signif(cors[lag == -1 &lev > 500][, mean(acf)], 2)`. In the stratosphere, zero-lag correlations drop to a minimum of `r signif(cors[lag == 0 & lev < 100][which.min(acf)]$acf, 2)` at `r cors[lag == 0 & lev < 100][which.min(acf)]$lev` hPa and then it increases again monotonically with height up to the uppermost level of the reanalysis. At the same time, one-month-lag correlations increase with height. 

```{r cross-correlation, fig.cap = "Cross correlation between levels of the Full, Asymmetric and Symmetric SAM.", fig.width = 6, fig.height=3, fig.env="figure*"}
tri <- matrix(c(1000, 1000, 1000, 1, 1, 1, 1000, 1000), ncol = 2, byrow = TRUE) %>% 
  as.data.table() %>% 
  setnames(., colnames(.), c("item1", "item2"))

logbreaks <- function(range) {
  ticks <- ggplot2:::calc_logticks(minpow = log10(min(range)), maxpow = log10(max(range)))
  ticks$value[ticks$end == 0.2]
}

crosscor <- indices %>% 
  copy() %>% 
  .[, widyr::pairwise_cor(.SD, lev, time, estimate, diag = TRUE), by = .(term)] 
crosscor %>% 
  ggplot(aes(item2, item1)) +
  geom_contour_fill(aes(z = correlation), breaks = MakeBreaks(binwidth = 0.1)) +
  geom_contour_tanaka(aes(z = correlation), size = 0.1, na.fill = .99, breaks = MakeBreaks(binwidth = 0.1)) +
  geom_text_contour(aes(z = correlation), breaks = MakeBreaks(binwidth = 0.1), 
                    color = "white", rotate = FALSE, stroke.color = "black", stroke = 0.2, 
                    skip = 1, size = 2, 
                    data = ~.x[item2 > item1]) +
  geom_polygon(data = tri, fill = "white") +
  scale_fill_divergent("Cross-correlation", 
                       breaks = MakeBreaks(binwidth = 0.1),
                       guide = guide_colorstrip_bottom()) +
  scale_x_level(minor_breaks = logbreaks, position = "top") +
  scale_y_level(minor_breaks = logbreaks) +
  coord_equal() +
  facet_grid(. ~ term, labeller = labeller(term = lab_sam)) +
  theme(panel.spacing.x = unit(2, "lines"), strip.placement = "outside") +
  tag_facets(position = "br")
```


Figure \ref{fig:cross-correlation}a) shows (zero-lag) cross-correlation across levels for the Full, Symmetric and Asymmetric SAM indices. For the Full SAM (panel a), high values below 100 hPa reflect the vertical (zero-lag) coherency throughout the troposfere. Above 100 hPa correlation between levels falls off more rapidly, indicating less coherent (zero-lag) variability. Still there is a non negligible correlation between the troposphere and the lower-to-middle stratosphere. Examining panels b and c, we see that the Asymemtric and Symmetric SAM  share the same high level of coherency in the troposphere but they differ in their stratospheric behaviour. As evidenced by the wider dark red areas near the diagonal in Figure \ref{fig:cross-correlation}b) vs.  Figure \ref{fig:cross-correlation}c), stratospheric coherency is stronger for the Asymmetric SAM than the Symemtric SAM. The stratospheric Symmetric SAM seems to connect more strongly to the trosposphere than the Asymmetric SAM; this can be seen by the lower correlation values in the top right left of Figure \ref{fig:cross-correlation}b) in comparison with Figure \ref{fig:cross-correlation}c).


<!-- ```{r} -->
<!-- indices_wide %>%  -->
<!--   .[, FitLm(as.numeric(time), asym, sym, se = TRUE), by = .(lev)] %>%  -->
<!--   rm_intercept() %>%  -->
<!--   # .[, term := NULL] %>%  -->
<!--   .[, estimate := estimate/(3600*24*365*10)] %>% -->
<!--   .[, std.error := std.error/(3600*24*365*10)] %>% -->
<!--   # setnames("type", "term") %>%  -->
<!--   ggplot(aes(lev, estimate)) + -->
<!--   geom_ribbon(aes(ymax = estimate + std.error*1.96, ymin = estimate - std.error*1.96), alpha = 0.3) + -->
<!--   geom_line() + -->
<!--   scale_fill_brewer(palette = "Dark2", aesthetics = c("color", "fill")) + -->
<!--   geom_hline(yintercept = 0) + -->
<!--   scale_x_level() + -->
<!--   scale_y_continuous("Standard deviations per decade") + -->
<!--   coord_flip() + -->
<!--   facet_grid(~ term,labeller = labeller(term = lab_sam)) + -->
<!--   tag_facets()  -->
<!-- ``` -->




```{r trends, fig.cap = "Decadal normalised trends for each index at each level for annual (row a) and seasonal values (rows b-e) for the period 1979-2018. Shading indicates the 95\\% confidence interval.", fig.width = 6, fig.height=4, fig.env="figure*"}
annual_trend <- indices %>%
  copy() %>% 
  .[, estimate_norm := estimate_norm/sd(estimate_norm), by = .(lev, term)] %>%
  .[, FitLm(estimate_norm, time, se = TRUE), by = .(lev, type = term)] %>% 
  rm_intercept() %>% 
  .[, term := NULL] %>% 
  .[, season := "Annual"]


indices %>% 
  copy() %>% 
  # .[time > as.Date("1990-01-01")] %>%
  .[, season := season(time)] %>% 
  .[, estimate_norm := estimate_norm/sd(estimate_norm), by = .(lev, term)] %>% 
  .[, FitLm(estimate_norm, time, se = TRUE), by = .(type = term, lev, season)] %>% 
  rm_intercept() %>% 
  .[, term := NULL] %>% 
  rbind(annual_trend) %>% 
  .[, estimate := estimate*3600*24*365*10] %>% 
  .[, std.error := std.error*3600*24*365*10] %>% 
  setnames("type", "term") %>% 
  .[, season := forcats::fct_relevel(season, "Annual")] %>% 
  ggplot(aes(lev, estimate)) +
  geom_ribbon(aes(ymax = estimate + std.error*1.96, ymin = estimate - std.error*1.96), alpha = 0.3) +
  geom_line() +
  scale_fill_brewer(palette = "Dark2", aesthetics = c("color", "fill")) +
  geom_hline(yintercept = 0) +
  scale_x_level() +
  scale_y_continuous("Standard deviations per decade") +
  coord_flip() +
  facet_grid(season ~ term,labeller = labeller(term = lab_sam)) +
  tag_facets("rc") 
```

Figure \ref{fig:trends} shows normalised decadal trends for each index for the whole period 1979-2918 along with the 95% confidence interval in shading for the whole year (row a) and separed by trimesters (rows b through e). As previously documented (e.g. @fogt2020), there is a statistically significant increase towards more positive SAM (panel a.1), which is evident only in Summer and Autumn (panels b.1 and c.1). We observe these increases mainly in the troposphere, reaching their maximum at at 100 hPa in Summer. By separating the SAM signal in its Asymmetric and Symmetric parts, we can not only see that these trends are almost entirely due to the Symmetric component (columns 2 vs. columns 3), but in some cases the trends become more clear. In Summer, the Asymmetric SAM has a statistically non significant negative trend in the middle troposphere that obscures the signal; as a result, trends computed using only the Symmetric component are more clear (compare the shading region in panel b.1 and b.3). In Autumn, using the Symmetric SAM reveals a statistically significant positive trend in the stratosphere that is not significant using the Full index. 

```{r regression-90}
local <- indices %>%
  .[time >= as.Date("1990-01-01")] %>% 
  .[, estimate_norm := estimate_norm/sd(estimate_norm), by = .(lev, term)] %>%
  .[, FitLm(estimate_norm, time, se = TRUE), by = .(lev, type = term, season(time))] %>% 
  rm_intercept() %>% 
  .[, term := NULL] %>% 
  .[, estimate := estimate*3600*24*365*10] %>% 
  .[, std.error := std.error*3600*24*365*10] 

trends_text <- local[, paste0(signif(estimate, 2), " \\pm ", signif(std.error*1.96, 2)), 
                     by = .(term = type, season, lev)]
```

We stress that these are only linear trends during the whole period and the absence of a statistically significant signal should not be taken as evidence of no sistematic change. In particular, going back to Figure \ref{fig:asymsam-timeseries}, we can see an evident change in the stratospheric Asymemtric component (red line in panel a) between the 90's, when we see a dominance of extreme negative values, and the 00's, when we see the inverse. This change is restricted to the Winter months: the linear trend for JJA starting in 1990 for the Asymmetric component at 50hPa is $`r trends_text[term == "asym" & lev == 50 & season == "JJA"]$V1`$.

Figure \ref{fig:r-squared-trend} shows decadal trends for the explained variance of each index. There is no evidencie of a significant trend in the stratosphere. In the troposphere, there is a positive trend for the Asymmetric SAM and no significant trend for the Symmetric SAM. This suggest that the SAM has become more asymmetric in the period from 1979 to 2018. The change is slight, though; of the order of 1% icreased explained variance per decade. 

```{r r-squared-trend, fig.height=3, fig.width=3, fig.cap = "Decadal trends for explained variance of each index at each level for the period 1979-2018. Shading indicates the 95\\% confidence interval."}
indices %>% 
  .[term != "full"] %>% 
  .[, FitLm(r.squared, time, se = TRUE), by = .(lev, type = term)] %>% 
  rm_intercept() %>%
  .[, estimate := estimate*3600*24*365*10] %>% 
  .[, std.error := std.error*3600*24*365*10] %>% 
  ggplot(aes(lev, estimate)) +
  geom_hline(yintercept = 0) +
  geom_ribbon(aes(fill = type, color = type, 
                  ymin = estimate - 1.96*std.error, ymax = estimate + 1.96*std.error), 
              size = 0.2, alpha = 0.2) +
  geom_line(aes(color = type)) +
  scale_x_level() +
  scale_y_continuous("Trend in R^2") +
  scale_fill_brewer(NULL, palette = "Dark2", aesthetics = c("color", "fill"), labels = lab_sam) +
  coord_flip() 
```

## Spatial patterns


```{r compute-regr-pattern}
indices_2d_yearly <- hgt[lev %in% c(main_levs)] %>% 
  indices_wide[., on = .NATURAL, allow.cartesian = TRUE] %>% 
  .[, combine_lists(FitLm(hgt_a, sym, asym, se = TRUE),
                    FitLm(hgt_a, full, se = TRUE)),
    by = .(lon, lat, lev)] %>% 
  rm_intercept() %>% 
  .[, p.val := Pvaluate(estimate, std.error, df, "fdr"), by = .(term, lev)] %>% 
  periodic(lon = c(0, 360)) %>% 
  .[, term := factor(term, levels = names(lab_sam), ordered = TRUE)] %>% 
  .[, season := "Annual"]
```


```{r 2d-regr, fig.cap = "Regression patterns of geopotential height at 30, 300 and 700 hPa with the Full, Asymmetric and Symmetric SAM. The regression patterns for Asymmetric and Symmetric SAM are the result of one multiple regression using both indices, not of two simple regressions involving each index by itsef. Points marked on panel b.2 are the location of the reference points used by \\cite{raphael2004} for its Zonal Wave 3 index.", fig.env = "figure*", fig.width=7, fig.height=5}
indices_2d_yearly %>% 
  .[lat <= -20] %>% 
  .[lev %in% c(50, 700)] %>% 
  ggplot(aes(lon, lat)) +
  geom_contour_fill(aes(z = estimate), breaks = AnchorBreaks(0, exclude =  0), global.breaks = FALSE) +
  geom_contour_tanaka(aes(z = estimate),
                      breaks = AnchorBreaks(0, exclude =  0),
                      size = 0.3,
                      global.breaks = FALSE) +
  geom_qmap(~.x[lat <= -20]) +
  geom_point(data = data.frame(lon = ConvertLongitude(c(50, 166, -76)),
                               lat = -49, term = "asym", lev = 700), 
             shape = 21, size = 2.5, color = "black", fill = "#de3e80") +
  scale_x_longitude() +
  scale_y_latitude(limits = c(NA, -20), labels = NULL) +
  scale_fill_divergent(NULL, guide = guide_colorstrip_bottom(), 
                       limits = c(-45, 45),
                       oob = scales::squish,
                       breaks = AnchorBreaks(0, 10, 0)) +
  scale_linetype(guide = "none") +
  coord_polar() +
  facet_grid(lev ~ term, labeller = labeller(term = lab_sam, lev = lev.lab)) +
  tag_facets("cr") +
  axis_labs_smol  +
  no_grid
```

To show if, and to what extent, the Asymmetric and Symmetric SAM inidices indeed capture the asymmetric and symmetric compoment of the SAM respectively, we computed the spatial regression of geopotential height anomalies on these indices and the Full SAM index. Figure \ref{fig:2d-regr} shows these regressions. Regression coefficients in column a are computed using the Full SAM. Regression coefficients in columns b and c are computed using multiple regression using the Asymmetric and Symmetric indices at the same time. Thus, they are to be interpreted as the patterns associated with each index, removing the variability (linearly) explained by the other index.

In the stratosphere, the spatial pattern associated with the Full SAM is more clearly dominated by a zonally symmetric, monopolar structure (panel a.1) which is, however, not perfectly centered in the south pole. The monopole obtained by multiple regression with the Asymmetric and Symmetric SAM (panel c.1) is much more symmetric and the shift from total symmetry is captured by the regression pattern of the Asymmetric SAM as a wave-1 with maximum anomalies above the Belinghausen Sea on the Western Hemisphere and and Davids Sea in the Eastern Hemisphere (panel b.1). 

In the troposphere, panel a.2 shows the well known zonally symmetrical annular mode *contaminated* with zonal asymmetries in the form of a wave-3. The regression using the Asymmetric and Symmetric SAM indices successfully disentangle both structures. The Asymmetric component gives rise to a cleaner zonal wave (panel b.2) and the Symemtric component is assosiated with an trully annular mode, almost devoid of zonal asymmetries (panel c.2). The wave-3 pattern observed in panel b.2 is rotated by half a wavelength from the average position of the mean wave-3 pattern asociated with @raphael2004's ZW3 index, whose reference locations are marked with points in the figure. Thus, the tropospheric Asymmetric SAM index responds to zonal displacements in the position of the wave-3 pattern. 


```{r compute-raphael}
# 50Â°E, 166Â°E and 76Â°W. 
raphael <- ReadNetCDF(ERA5(), 
           subset = list(time = c("1979-01-01", "2018-12-31"),
                         latitude = -49,
                         level = 500),
           vars = c(hgt = "z")) %>% 
  normalise_coords() %>% 
  .[, hgt := hgt/9.8] %>% 
  .[, hgt := Anomaly(hgt), by = .(lat, time)] %>% 
  .[lon %~% ConvertLongitude(c(50, 166, -76))] %>% 
  .[, hgt_s := frollmean(hgt, 3, NA, align = "center"), by = .(lon, lat)] %>% 
  na.omit() %>% 
  .[, hgt_s := scale(hgt_s), by = .(lon, lat, month(time))] %>% 
  .[, .(raphael = mean(hgt_s)), by = time]
```

```{r wave-amplitude, fig.cap = "Planteray wave amplitude for the regression patterns at 50 and 700 hPa. Note the varying x axis.", fig.width=3, fig.height=3}
indices_2d_yearly %>% 
  .[lat < -20] %>%
  .[lev %in% c(50, 700)] %>% 
  .[, FitWave(estimate, 0:3), by = .(lat, lev, term)] %>% 
  ggplot(aes(lat, amplitude)) +
  geom_line(aes(color = factor(k))) +
  scale_color_brewer("Wave-number", palette = "Dark2") +
  scale_y_continuous("Amplitude") +
  scale_x_latitude(ticks = 20) +
  coord_flip() +
  facet_grid(lev~term, labeller = labeller(term = lab_sam, lev = lev.lab), scales = "free") +
  tag_facets("cr", position = "tr")  +
  no_grid +
  theme(strip.text = element_text(size = 7))
```

The amplitude of each zonal wave number at each latitude at 50 hPa and 700 hPa is shown in Figure \ref{fig:wave-amplitude}, where wave number zero represents the amplitude of the zonal mean. Comparing between rows, this Figure quantifies the relatively clean separation between the zonally symmetric and zonally asymmetric structures, as its evident how the mixture of waves of the Full field (column a) is very similar to the sum of the waves of the Asymmetric and Symmetric field (columns b and c, respectively). Column b of Figure \ref{fig:wave-amplitude} shows that the Asymmetric SAM is overwhelmingly dominated by wave 1 in the stratosphere (panel b.1), while in the troposphere it is composed of zonal waves 3 to 1 in decreasing level of importance (panel b.2). 




```{r compute-vertical-regression}
# vertical_regr <- ReadNetCDF(ERA5(), 
#            subset = list(time = c("1979-01-01", "2018-12-31"),
#                          latitude = c(-65, -40)),
#            vars = c(hgt = "z")) %>% 
#   normalise_coords() %>% 
#   .[, .(hgt = weighted.mean(hgt, w = cos(lat*pi/180))), by = .(lon, lev, time)] %>% 
#   .[, hgt := hgt/9.8] %>% 
#   .[, hgt_a := hgt - mean(hgt), by = .(lon, lev, month(time))] %>% 
#   indices_wide[., on = .NATURAL, allow.cartesian = TRUE] %>% 
#   .[, FitLm(hgt_a, sym, asym, se = TRUE),
#     by = .(lon, lev)] %>% 
#   rm_intercept() %>% 
#   .[, p.val := Pvaluate(estimate, std.error, df, "fdr"), by = .(term, lev)] %>% 
#   periodic(lon = c(0, 360)) %>% 
#   .[, term := factor(term, levels = names(lab_sam), ordered = TRUE)] 

indices_wide %>% 
  copy() %>% 
  setnames("lev", "index_level") -> indices_for_regr

vertical_regr <- ReadNetCDF(ERA5(), 
                            subset = list(time = c("1979-01-01", "2018-12-31"),
                                          latitude = c(-65, -40)),
                            vars = c(hgt = "z")) %>% 
  normalise_coords() %>% 
  .[, .(hgt = weighted.mean(hgt, w = cos(lat*pi/180))), by = .(lon, lev, time)] %>% 
  .[, hgt := hgt/9.8] %>% 
  .[, hgt_a := hgt - mean(hgt), by = .(lon, lev, month(time))] %>% 
  indices_for_regr[., on = .NATURAL, allow.cartesian = TRUE] %>% 
  .[, combine_lists(FitLm(hgt_a, full, se = TRUE),
                    FitLm(hgt_a, sym, asym, se = TRUE)),
    by = .(lon, lev, index_level)] %>% 
  rm_intercept() %>% 
  .[, p.val := Pvaluate(estimate, std.error, df, "fdr"), by = .(term, index_level, lev)] %>% 
  periodic(lon = c(0, 360)) %>% 
  .[, term := factor(term, levels = names(lab_sam), ordered = TRUE)] 
```



```{r vertical-regression, fig.cap = "Asymmetric coefficient of the multiple regression of mean monthly geopotential height anomalies between 65 and 40 South. (\\#FIXME this caption needs some love)", fig.width = 3, fig.height=3}
vertical_regr %>% 
  .[index_level %in% c(50, 700)] %>% 
  .[term == "asym"] %>%
  ggplot(aes(lon, lev)) +
  geom_contour_fill(aes(z = estimate), breaks = AnchorBreaks(0, 10, 0)) +
  geom_contour_tanaka(aes(z = estimate),
                      breaks = AnchorBreaks(0, 10, 0),
                      size = 0.3,
                      global.breaks = FALSE) +
  # geom_contour2(aes(z = p.val), breaks = 0.01) +
  scale_fill_divergent(NULL, guide = guide_colorstrip_bottom(13), 
                       oob = scales::squish,
                       breaks = MakeBreaks(binwidth = 10, exclude = 0)) +
  scale_y_level() +
  scale_x_longitude(ticks = 60)  +
  facet_grid(index_level~., labeller = labeller(index_level = lev.lab)) +
  tag_facets(position = "bl") 
```


To analyse the vertical structure of the geopotential anomalies asociated with the asymetric SAM index, we show a vertical cross section of regressions of mean geopotential height between 65ÂªS and 40ÂªS for the 50 hPa Asymmetric SAM index (panel a) and for the 700 hPa Asymmetric SAM index (panel b) (Figure \ref{fig:vertical-regression}). 

The geopotential anomalies associated with the stratospheric SAM (panel a) are clearly constrained to the stratosphere, which underscores the disconnect between the stratospheric and tropospheric Asymmetric SAM. The vertical structure this signal tilts about 60Âª to the West between 100 hPa and 1 hPa, suggesting baroclinic processes and polarward transport of heat (#FIXME is this ok?). Interestingly, the signal in the stratosphere maximises near 10 hPa despite using the 50 hPa index for the regression. 

The tropospheric Asymmetric SAM (panel b) has significant signals that extend upwards to the uppermost levels of the reanalysis. In the troposphere, the wave-3 structure is equivalent barotropic with maximum amplitude at roughly 250 hPa. The anomalies are much more intense in the Western hemisphere, where they extent into the stratosphere. In the Eastern hemisphere the wave-3 signal is weaker and confined to the troosphere while negative anomalies dominate in the stratosphere. So, while the tropospheric Asymmetric SAM index is associated with stratospheric geopotential anomalies, these do not project strongly onto the stratospheric Asymmetric SAM.

The structures shown in panels a and b in  Figure \ref{fig:vertical-regression} are surprisignly robust to the choice of index level. For any stratospheric (above 100 hPa) index, the resulting anomalies are very similar to the wave-1 structure with maximum near 10 hPa in panel a. Conversely, for any tropospheric (below 100 hPa) index, the result is very similar to panel b. Pattern cross-correlation is greater than 0.9 within stratospheric index levels and tropospheric index levels and less than .4 accross stratospheric and tropospheric levels (Figure A8), i.e. regressions obtained using Asymmetric SAM indices in the troposphere are very similar to each other and different to the ones obtaines using indices in the stratosphere and vice versa. The patterns mainly change in amplitude. The tropospheric pattern is maximised by the 300 hPa Asymmetric SAM index and the stratospheric pattern increased monotonically with height. 


```{r enso-cor}
mei_sam_cor <- rsoi::download_mei(TRUE, data_path("derived", "mei.csv")) %>% 
  as.data.table() %>% 
  .[, .(time = lubridate::as_datetime(Date), mei = MEI)] %>% 
  .[indices, on = "time"] %>% 
  .[, with(cor.test(estimate, mei), 
           list(cor = estimate, 
                low = conf.int[1], 
                upp = conf.int[2])), by = .(lev, term)] 
# enso_sam_cor %>% 
#   ggplot(aes(lev, cor)) +
#   geom_ribbon(aes(ymin = low, ymax = upp, fill = term), alpha = 0.2) +
#   geom_line(aes(color = term)) +
#   scale_x_level() +
#   coord_flip()
  
cor_texts <- mei_sam_cor[lev == 700, 
                          paste0(signif(cor, 2)), # " (CI: ", signif(low, 2), "â", signif(upp, 2), ")"), 
                          by = term] %>% 
  dcast(1~term)

mei_sam_partial <- rsoi::download_mei(TRUE, data_path("derived", "mei.csv")) %>% 
  as.data.table() %>% 
  .[, .(time = lubridate::as_datetime(Date), mei = MEI)] %>% 
  .[indices_wide, on = "time"] %>% 
  .[lev == 700] %>% 
  .[, partial_cor(mei, asym, sym)] %>% 
  .[, partial_correlation := signif(partial_correlation, 2)] %>% 
  dcast(.~term)
```

The wave-3 pattern from Figure \ref{fig:2d-regr} panel b.2 is very similar to the teleconnection pattern associated with the ENSO. Indeed, @fogt2011 showed that there is a significant relationship between the SAM and the ENSO. The correlation between the full SAM and the ENSO as measured by the Multivariate Enso Index [@wolter2011] is `r cor_texts$full`. This relationship is captured entirely the Asymmetric SAM, as this index has a partial correlation of `r mei_sam_partial$asym` with the MEI, whereas the Symmetric SAM's partial correlation with the MEI is essentially null (`r mei_sam_partial$sym`).


## Impacts

### Temperature

```{r compute-air-regr}
time_subset <- list(time = range(indices$time))
air <- NOAATemp() %>% 
  ReadNetCDF(vars = "air", subset = c(time_subset, list(lat = c(-90, 10)))) %>% 
  normalise_coords()  %>%
  # Interpolate at lon = 0. Otherwise, can't close contours. 
  qwrap(lon = c(0, 360) ~ c(-2.5, 360)) %>% 
  .[ , Interpolate(air ~ lon + lat, x.out = c(0, unique(lon)), y.out = unique(lat)), by = time] %>% 
  .[lon != -2.5]

# mei <- rsoi::download_mei() %>% 
#   as.data.table() %>% 
#   .[, .(time = lubridate::as_datetime(Date), mei = MEI)]

air_regr <- air %>% 
  # .[, air := Anomaly(air), by = .(lon, lat)] %>%
  .[indices_wide[lev == 700], on = .NATURAL] %>% 
  # mei[., on = .NATURAL] %>% 
  rm_singleton() %>% 
  .[, lapply(.SD, mean, na.rm = TRUE), by = .(lon, lat, time = seasonally(time))] %>%
  .[, nas := mean(is.na(air)), by = .(lon, lat, season(time))] %>% 
  .[nas >= 0.15, air := NA] %>% 
  .[, rbind(as.data.table(FitLm(air, asym, sym, se = TRUE)),
            as.data.table(FitLm(air, full, se = TRUE))),
    by = .(lon, lat, season(time))] %>% 
  rm_intercept() %>% 
  .[, term := factor(term, levels = names(lab_sam), ordered = TRUE)] 
```



```{r regr-air-season, fig.cap = "Regression pattern of surface temperature with Asymmetric and Symmetric SAM. P-values smaller than 0.05 (controlling for Flase Detection Rate) as hatched areas. Gray areas have more than 15\\% of missing data.", fig.width = 6, fig.height = 8, fig.env = "figure*"}
air_regr %>% 
  # .[season == "DJF"] %>% 
  copy() %>% 
  # .[lat <= -61, estimate := NA] %>%
  .[lat >= 65, estimate := NA] %>%
  .[, p.value := Pvaluate(estimate, std.error, df, "fdr"), by = .(term, season)] %>% 
  # .[, term := factor(term, levels = names(lab_sam), ordered = TRUE)] %>%
  periodic(lon = c(0, 360)) %>% 
  ggplot(aes(lon, lat)) +
  geom_contour_fill(aes(z = estimate), 
                    breaks = AnchorBreaks(0, 0.15, 0)) +
  geom_contour_tanaka(aes(z = estimate),
                      breaks = AnchorBreaks(0, 0.15, 0)) +
  # geom_raster(aes(fill = estimate)) +
  geom_contour_fill(aes(z = p.value), breaks = c(0, 0.05), color = "black", fill = "gray50", alpha = 0.2) +
  geom_contour_fill(aes(z = as.numeric(is.na(estimate))), breaks = c(0.5, 2), fill = "gray") +
  geom_contour2(aes(z = as.numeric(is.na(estimate))), breaks = c(0.5, 2), color = "gray50") +
  geom_qmap(~.x[lat <= 0]) +
  scale_x_longitude() +
  scale_y_latitude(labels = NULL, limits = c(NA, 0)) +
  scale_fill_divergent("Surface temperature",  
                       limits = c(-0.8, .8), 
                       oob = scales::squish,
                       guide = guide_colorstrip_bottom(), breaks = AnchorBreaks(0, 0.15, 0)) +
  coord_polar() +
  facet_grid(season ~ term, labeller = labeller(term = lab_sam, lev = lev.lab)) +
  tag_facets("cr", tag_suffix = "") +
  no_grid +
  axis_labs_smol
```

Figure \ref{fig:regr-air-season} shows regression coefficients of each index at 700 hPa with surface temperature for each trimester. It is evident that the Asymmetric and Symmetric SAM indices are associated with overall distinct temperature patterns which can be obscured when using the Full SAM index. The Symmetric SAM signal is weaker than the Asymmetric SAM, as evidenced by the relatively smaller and les sstatistically significant regression coefficients in row 3 of Figure \ref{fig:regr-air-season} compared with row 2. 

In DJF (row 1), the strong negative signal in the tropical Pacific in panel a.1 is mostly associated with the Asymmetric component (panel b.1), as is it largely absent in the Symmetric component (panel c.1). Furthermore, the Asymmetric SAM is also asociated with low temperature anomalies in the Indian ocean, but this signal is obscured by the Symmetric variability and thus lost in the Full SAM. Over the continents, the Asymmetric SAM is assoiated with negative temperature anomalies which, again, mostly disappear in the Full SAM regression. Temperature regression with the Symmetric SAM (panel c.1) shows a ring of negative anomalies around Antarctica surrounded by positive anomalies. This pattern of anomalies is consistent with thermal wind balance and the intesification and pole-ward migration of the westerlies commonly linked to the SAM. 

The patterns seen in MAM and JJA (rows 2 and 3) are not robustly significant in the sense that there are no areas with p-values below 0.05 when controlling for FDR following @wilks2016. Nevertheless, it is interesting to note that in both trimesters, the sign of the regression is consistently flipped between the Asymmetric and Symmetric regressions. In South America, for example, the Asymmetric SAM is associated with positive temperature anomalies in MAM and negative temperature anomales in JJA, while the oposite is the case for the Symemtric SAM. 

Finally, in SON (row 4) there is no significant temperature signal associated with the Symmetric SAM (panel c.4), while the Asymmetric SAM shows a relatively robust signal in the equatorial Pacitic, Australia, and even Southeast South America. 


### Precipitation


Regression of the SAM indicies with seasonal mean precipitation are shown Figures \ref{fig:pp-regr-oceania} and \ref{fig:pp-regr-america} for Australia and New Zealand, and South America respectively. (We didn't detect any significant signal in South Africa.)

```{r calc-indices2d-seasonal}
indices_2d_seasonal <- hgt[lev %in% 700] %>% 
  indices_wide[., on = .NATURAL, allow.cartesian = TRUE] %>% 
  .[, lapply(.SD, mean, na.rm = TRUE), by = .(lon, lat, time = seasonally(time))] %>% 
  .[, combine_lists(FitLm(hgt_a, sym, asym, se = TRUE),
                    FitLm(hgt_a, full, se = TRUE)),
    by = .(lon, lat, season(time))] %>% 
  rm_intercept() %>% 
  .[, p.val := Pvaluate(estimate, std.error, df, "fdr"), by = .(term, season)] %>% 
  periodic(lon = c(0, 360)) %>% 
  .[, term := factor(term, levels = names(lab_sam), ordered = TRUE)] 

indices_2d <- rbind(indices_2d_yearly[lev == 700] %>% .[, lev := NULL], indices_2d_seasonal) %>% 
  .[, season := forcats::fct_relevel(season, "Annual")] 
```


```{r compute-pp-regr} 
# pp <- CMAP() %>% 
#   ReadNetCDF(subset = list(lat = c(-90, -20))) %>% 
#   normalise_coords() %>% 
#   .[, precip := Anomaly(precip), by = .(lon, lat)]

continents <- list(africa  = list(lon = c(0, 60),
                                  lat = c(-40, 0)),
                   oceania = list(lon = c(100, 180),
                                  lat = c(-50, -5)),
                   america = list(lon = c(265, 325),
                                  lat = c(-60, -10)))


add_continent <- function(dt) {
  dt[, continent := fcase(lon %between% continents$africa$lon & 
                            lat %between% continents$africa$lat, "africa",
                          lon %between% continents$oceania$lon & 
                            lat %between% continents$oceania$lat, "oceania",
                          lon %between% continents$america$lon &
                            lat %between% continents$america$lat, "america")] %>% 
    .[, continent := factor(continent, levels = c("africa", "oceania", "america"), ordered = TRUE)] %>% 
    .[]
}

pp <- CPCC() %>% 
  ReadNetCDF(subset = list(lat = c(-90, 0),
                           time = range(indices$time))) %>% 
  na.omit() %>% 
  normalise_coords() %>%
  .[, days := lubridate::days_in_month(time[1]), by = time] %>% 
  .[, precip := precip/days]

# mei <- rsoi::download_mei() %>% 
#   as.data.table() %>% 
#   .[, .(time = lubridate::as_datetime(Date), mei = MEI)]

pp_regr_season <- pp %>% 
  .[indices_wide[lev == 700], on = .NATURAL] %>% 
  na.omit() %>% 
  .[, precip_a := Anomaly(precip), by = .(lon, lat, month(time))] %>% 
  .[, lapply(.SD, mean, na.rm = TRUE), by = .(lon, lat, time = seasonally(time))] %>%
  .[, precip_a := Anomaly(precip), by = .(lon, lat, season(time))] %>%
  .[, nas := mean(is.na(precip)), by = .(lon,  lat, season(time))] %>% 
  .[nas >= 0.15, precip := NA] %>% 
  # na.omit() %>% 
  .[is.finite(precip_a)] %>%
  .[, combine_lists(FitLm(precip_a, asym, sym, se = TRUE),
                    FitLm(precip_a, full, se = TRUE)),
    by = .(lon, lat, season(time))] %>% 
  rm_intercept() %>% 
  .[, term := factor(term, levels = names(lab_sam), ordered = TRUE)] 

pp_regr_annual <- pp %>% 
  .[indices_wide[lev == 700], on = .NATURAL] %>% 
  na.omit() %>% 
  .[, precip_a := Anomaly(precip), by = .(lon, lat, month(time))] %>% 
  .[, nas := mean(is.na(precip)), by = .(lon,  lat)] %>%
  .[nas >= 0.15, precip := NA] %>% 
  .[is.finite(precip_a)] %>%
  .[, combine_lists(FitLm(precip_a, asym, sym, se = TRUE),
                    FitLm(precip_a, full, se = TRUE)),
    by = .(lon, lat)] %>% 
  rm_intercept() %>% 
  .[, term := factor(term, levels = names(lab_sam), ordered = TRUE)] %>% 
  .[, season := "Annual"]
pp_regr <- rbind(pp_regr_season, pp_regr_annual) %>% 
  .[, season := forcats::fct_relevel(season, "Annual")] 
```


```{r def-plot_pp}
plot_pp <- function(this_continent, data = pp_regr) {
  data %>%
    .[term != "mei"] %>% 
    add_continent() %>% 
    # .[lat <= -10] %>% 
    .[continent == this_continent] %>%
    .[, p.value := Pvaluate(estimate, std.error, df, "fdr"), by = .(season, continent, term)] %>%
    ggplot(aes(lon, lat)) +
    geom_contour_fill(aes(z = estimate), na.fill = 0, breaks = AnchorBreaks(0, 0.1, 0)) +
    stat_subset(aes(subset = is.na(estimate)), geom = "tile", color = "gray50") +
    # geom_raster(aes(fill = estimate/30)) +
    geom_contour2(aes(z = p.value), breaks = 0.05) +
    # geom_contour_fill(aes(z = as.numeric(is.na(estimate))), breaks = 1) +
    # stat_subset(aes(subset = p.value <= 0.05 & is.cross(lon, lat, 2)), size = 0.4, alpha = 0.8) +
    geom_contour2(data = indices_2d %>% copy() %>% add_continent() %>% .[continent == this_continent],
                  color = "gray50", size = 0.2, global.breaks = FALSE, 
                aes(z = estimate, linetype = factor(-sign(..level..)))) +
    geom_qmap(~.x[lat <= 10], keep = 0.015, weighting = 0.9) +
    scale_x_longitude(breaks = NULL) +
    scale_y_latitude(breaks = NULL) +
    scale_fill_divergent("Precipitation", 
                         limits = c(-.8, .8),
                         oob = scales::squish,
                         # label = scales::percent_format(),
                         guide = guide_colorstrip_bottom(), 
                         breaks = AnchorBreaks(0, 0.1, 0)) +
    scale_linetype(guide = "none") +
    coord_quickmap(xlim = continents[[this_continent]]$lon, 
                   ylim = continents[[this_continent]]$lat) +
    facet_grid(season ~ term, labeller = labeller(term = lab_sam, lev = lev.lab)) +
    tag_facets("cr", position = "bl")  +
    no_grid +
    axis_labs_smol
}

```

```{r pp-regr-africa,  fig.cap = "Regression pattern of precipiation with Asymmetric and Symmetric SAM. P-values smaller than 0.05 (controlling for Flase Detection Rate) as hatched areas. Africa", fig.width = 6, fig.height = 4.5, fig.env = "figure*"}
# plot_pp("africa") 
```


```{r pp-regr-oceania, dependson="def-plot_pp",  fig.cap = "Regression pattern of precipiation with Asymmetric and Symmetric SAM. P-values smaller than 0.05 (controlling for Flase Detection Rate) as hatched areas.", fig.width = 6, fig.height = 6.5, fig.env = "figure*"}
plot_pp("oceania") 

```


In Australia (Figure \ref{fig:pp-regr-oceania}), the annual-level regression shows that the Full SAM is associated with a statistically significant increase in precipitation in the Southeastern region (panel a.1), which reproduces the results from @gillett2006. The separation between Asymmetric and Symmetric SAM suggest that this increase is explained by the Symmetric SAM only in the East coast (panel c.1), which is consistent with the increased easterly flow clearly seen in relation with this index. The Asymmetric SAM appears related to increased precipitation in the West coast of Southeastern Australia (panel b.2), explained by the anomalous *westerly* circulation transporting moist air to the continent. 

The seasonal-level regressions show statistically significant anomalies only in SON, with a pattern similar to the annual-level regression (panel a.5). Panels b.5 and c.5 don't show a clear separation between the Asymmetric and Symmetric SAM. If anything, the positive and more significant regression coefficients in panel b.5 vs pane c.5 would suggest more influence of the Asymmetric than the Symmetric SAM, going against the interpretation gathered from the annual-level regressions. This Spring signal is broadly consistent with @hendon2007, but whereas @hendon2007 also detected a strong signal in Summer, panel a.2 shows no statistically significant association (although the coeffcients have the consistent sign). 


```{r pp-regr-america, dependson = "def-plot_pp", fig.cap = "Same but for america", fig.width = 6, fig.height = 7.6, fig.env = "figure*"}
plot_pp("america")
```

In South America (Figure \ref{fig:pp-regr-america}), the annual-level regression shows that the SAM is associated with statistically significant precipitation decrease in Southeastern South America (SESA) and Southern Chile and non-significant increase in South Brazil, near the South Atlantic Convergence Zone (SACZ) (panel a.1). 

Panels b.1 and c.1 show a remarkably clean separation between the Asymmeric SAM --associated with the Southeastern South American and Southern Brazilian signals-- and the Symmetric SAM --associated with the signal in Southern Chile. This separation is consistent with the mechanisms responsible for these effects. In Southern Chile, the reduced westerly flow reduce moisture transport from the Pacific Ocean (cita?? #FIXME). 

In Southeastern South America, anomalous meridional winds lead to less precipitation by inhibiting moisture convergence from the South American Low Level Jet [@silvestri2009]. The increased precipiation in the South Atlantic Convergence Zone, on the other hand, appears to be related to modulation of the anomalous SAM circulation in SACZ events which lead to more frequent and intense SACZ events during positive SAM [@rosso2018]. 

There is a small area of increased precipitation with SAM near central Argentina which is also present in the station-based analysis by @gillett2006 and that is explained by the Asymmmetric SAM.

Except during Winter, the seasonal-level regression all show these similar patterns although not as cleanly and only in some cases statistically significant. 

### Sea ice

```{r read-ice}
ice <- readRDS(data_path("derived", "ice.Rds"))
ice_proj <- readRDS(data_path("derived", "ice_proj.Rds"))

new_proj <- "+proj=stere +lat_0=-90 +lat_ts=-70 +lon_0=-180 +k=1 +x_0=0 +y_0=0 +a=6378273 +b=6356889.449 +units=m +no_defs"

project_ice <- function(data) {
  browser()
  data[, c("x", "y") := proj4::project(list(x, y), proj = ice_proj, inverse = TRUE)] %>% 
    .[, x := ConvertLongitude(x, group = group)] %>% 
    .[]

}
```

```{r compte-ice-regression}
ice_regr <- ice %>% 
  .[indices_wide[lev == 700], on = .NATURAL] %>% 
  # .[season(time) %in% c("JJA", "SON")] %>%
  .[concentration <= 0.15, concentration := 0] %>% 
  .[, lapply(.SD, mean, na.rm = TRUE), by = .(x, y, time = seasonally(time))] %>% 
  # .[season(time) == "SON"] %>% 
  .[, combine_lists(FitLm(concentration, full, se = TRUE),
                    FitLm(concentration, asym, sym, se = TRUE)),
    by = .(x, y, season(time))] %>%
  rm_intercept() 
```


```{r regr-ice, fig.cap = "Seasonal regression of SAM indices with sea ice concentration. \\#FIXME", fig.env="figure*",  fig.width = 6, fig.height = 8}
ice_regr %>% 
  .[, term := factor(term, levels = names(lab_sam), ordered = TRUE)] %>%
  .[, pval := Pvaluate(estimate, std.error, df, "fdr"), by = .(season, term)] %>%
  .[, c("lon", "lat") :=  proj4::project(list(x, y), proj = ice_proj, inverse = TRUE)] %>% 
  # .[season == "SON"] %>%
  .[, lon := ConvertLongitude(lon)] %>% 
  na.omit() %>% 
  .[estimate != 0] %>% 
  
  ggplot(aes(lon, lat)) +
  scattermore::geom_scattermore(aes(color = estimate), pixels = c(256, 256)) +
  stat_subset(aes(subset = pval < 0.01 & is.cross(x, y, 3)),
              geom = "point", size = 0.01, alpha = .6) +
  geom_contour2(data = indices_2d_seasonal[lat <= -50], color = "gray50", size = 0.3,
                aes(z = estimate, linetype = factor(-sign(..level..)))) +
  geom_qmap(~.x[lat <= -60]) +
  scale_color_divergent("Sea Ice",
                        limits = c(-.1, .1), 
                        oob = scales::squish, 
                        guide = guide_colorstrip_bottom(),
                        breaks = AnchorBreaks(0, 0.025, 0)) +
  scale_x_longitude() +
  scale_y_latitude(limit = c(-90, NA), labels = NULL) +
  scale_linetype(guide = "none") +
  coord_polar() +
  facet_grid(season ~ term, labeller = labeller(term = lab_sam)) +
  tag_facets("cr") +
  no_grid +
  axis_labs_smol
```


Regressions between the Full SAM index and Antarctic Sea Ice Concentrations (Figure \ref{fig:regr-ice}) show a great deal of variability across seasons. The only statistically significant signal is in Spring, when we observe negative concentraion anomalies in the Northen Weddell Sea (panel a.4) explained by the Asymmetric SAM (panel b.4). Both in Winter and in Spring the Asymmetric SAM is associated with bigger Sea Ice Concentration anomalies in West Antarctica than East Antarctica, with generally decreased concentration East of the Antarctic Peninsula and increased concentration to the West, as expected from the anomalous circulation correlated with this index. The Symmetric SAM signal appears more evenly distributed accross the whole ice sheet. 

## Conclusions

We presented a method to systematically separate the zonally asymmetric and zonally symmetric components of the SAM into two indices. As expected, they are significantly correlated with each other, but they also have their own unique dynamics such as differnet vertical coherence patterns, variability and long term trends.

The spatial structure and temporal evolution of the SAM show a strong separation between the stratosphere SAMs. The first EOF in the stratosphere is monopolar in nature while the first EOF in the troposphere is a proper annular mode. Their repespective departures from the zonal mean are also different: a zonal wave 1 dominates the stratospheric SAM; waves 3 and 2 dominate the tropospheric SAM. Furthermore, there is little temporal correlation between the tropospheric and stratospheric time series. 

The zonal asymmetric component of the SAM at each level is even more decupled between the troposphere and the stratosphere. Their temporal evolution shows essentialy zero correlation (Figure \ref{fig:cross-correlation}) and the signal associated with the stratospheric Asymmetric SAM is completely restricted to the stratosphere (Figure \ref{fig:vertical-regression} panel a). Geopotential height anomalies associated with the tropospheric Asymmetric SAM, on the other hand, do extend to the stratosphere, but those anomalies do not project strongly into the stratospheric Asymmetric SAM. 

We show that the observed positive trend towards positive SAM is restricted to the tropospheric SAM and is explained by the Symmetric component (Figure \ref{fig:trends]). However, the degree of asymmetry appears to have increased slightly in the last 40 years, as the Asymmetric SAM explains an increasingly proportion of the variance (Figure \ref{fig:r-squared-trend}).

Temperature and precipitation anomalies associated with the SAM respond to various processes in different locations. The Asymmetric and Symmetric indices do a reasonable job separating some of them. The strong sumertime temperature anomalies in the equatorial Pacific are explained by the Asymmetric component, most likely due to its relationship with ENSO. The Symmetric SAM, on the other hand, captures the change in meridional temperature gradient, which is linked to the SAM-zonal wind relationship by thermal wind balance. 

The patterns of SAM-associated precipitation anomalies are similarly well separated. In South America, we show that negative anomalies observed in Chile related to the SAM are well explained by the Symmetric component, while the precipitation dipole in Southern South America and the South Atlantic Convergence Zone is explained by the Asymmetric component. 

<!-- @hosking2013 observed a pattern similar to the one near the Amundsen Sea in panel a.4 associated with the strengthening of the ASL. The positive anomalies of SIC near the Amundsen sea being inconsistent with the anomalies of meridional wind associated with the ASL. Row 4 in Figure \ref{fig:regr-ice} might shed some light to resolve this mistery. The SAM is evidently related to the ASL through it's Asymmetric component, and since the ASymmetric SAM is correlated with the Symmetric SAM, the ALS will be rleated to the symemtric SAM. Consiering the similarities between the the SIC anomalies observed by @hosking2013 (in its Figure 7) and Figure \ref{fig:regr-ice} panel a.4, it is very likely that what was observed in that paper was a residual effect of the SAM. #FIXME!! -->


### Limitations {-}

Our method assumes linearity in the asymmetric component of the SAM. That is, assumes that zonal symmetries associated with positive SAM are oposite and equal to the ones associated with negatie SAM. @fogt2012's composites suggest that this might not be entirely valid, although we argue that much of that apparent non-linearity is due to the heterogenous nature of the selected years for constructing the composites. Using our data (from 1979 to 2018), seasonal composites of zonal anomalies of 700 hPa geopotential height for for SAM+ and SAM- show pattern linear correlations greater than -0.7 for all seasons and are visually very linear (Figure A9). Therefore, we belive that our method is at the very least a reasonable approximation of the fenomenon. 

We also asumed that the structure of the SAM zonal anomalies is stable in all seasons. Again, this is not unreasonable, as geopotential zonal anomalies computed by projecting the first EOF *of each season* are very similar to each other (Figure A10).

@silvestri2009 showed that impacts linked to the SAM changed rather dramatically before and after 1980. In particular, the negative relationship with precipitation in South America (consistent with Figure \ref{fig:pp-regr-america} panel a.1) was absent in some areas and switched sign in other in the earlier period. The correlation between ENSO and SAM is similarly non-stationary, also disapearing before 1973. 

Seeing as both the ENSO-SAM relationship and most of the precipitation imacts in South America are captured by the Asymmetric SAM, the results presented here are most likely period-dependent. Therefore, is very likely that if we were to repeat this analysis using pre-satellite data, the resulting Asymmetric SAM would look very different. 



\acknowledgments
CMAP Precipitation data provided by the NOAA/OAR/ESRL PSL, Boulder, Colorado, USA, from their Web site at https://psl.noaa.gov/ #FIXME

NOAA Global Surface Temperature (NOAAGlobalTemp) data provided by the NOAA/OAR/ESRL PSL, Boulder, Colorado, USA, from their Web site at https://psl.noaa.gov/ 



\bibliography{AsymSAM}

\newpage

\appendix

\appendixtitle{Extra figures}



```{r A1, fig.cap = "Lag-correlation between Symmetric and Asymmetric SAM at each level.", fig.width = 4, fig.height=4, appendix = TRUE}
ccf_dt <- function(..., plot = FALSE) {
  stat <- ccf(..., plot = plot)
  list(lag = stat$lag[, 1, 1], 
       acf = stat$acf[, 1, 1])
}

indices_wide %>% 
  .[, ccf_dt(asym, sym, lag.max = 5), by = .(lev)] %>% 
  ggplot(aes(lag, lev)) +
  geom_contour_fill(aes(z = acf), breaks = AnchorBreaks(0, 0.05)) +
  geom_vline(xintercept = 0) +
  scale_fill_divergent(NULL, guide = guide_colorstrip_bottom(), breaks = AnchorBreaks(0, 0.05)) +
  scale_x_continuous("Asym leads Sym\t \t\t Sym leads Asym", breaks = seq(-5, 5, 1), 
                     expand = c(0, 0)) +
  scale_y_level()
```


```{r A2 ccf-levels, fig.cap = "Cross-correlation functions for each index and two differnet base levels.", fig.height=5, fig.width=6}
ccf_dt <- function(...) {
  a <- ccf(..., plot = FALSE)
  list(acf = as.vector(a$acf),
       lag = as.vector(a$lag))
}



index2 <- copy(indices)
index2[, estimate_700 := estimate[lev == 700], by = .(term, time)]
index2[, estimate_10 := estimate[lev == 10], by = .(term, time)]

rbind("700" = index2[, ccf_dt(x = estimate, y = estimate_700, lag.max = 5), by = .(lev, term)],
      "10" = index2[, ccf_dt(x = estimate, y = estimate_10, lag.max = 5), by = .(lev, term)], 
      idcol = "base_level") %>% 
  ggplot(aes(lag, lev)) +
  geom_contour_fill(aes(z = acf), breaks = AnchorBreaks(0, 0.1, 0)) +
  scale_fill_divergent(NULL, guide = guide_colorstrip_bottom(), 
                       breaks = AnchorBreaks(0, 0.1, 0)) +
  scale_y_level() +
  scale_x_continuous(breaks = seq(-10, 10)) +
  facet_grid(term~base_level, labeller = labeller(base_level = function(x) paste0("Base level: ", x, " hPa"), 
                                                  term = lab_sam)) +
  tag_facets() 
```


```{r compute-spectrums}
indices %>% 
  .[lev %in% c(50, 700)] %>% 
  # .[, estimate_norm := estimate_norm/sd(estimate_norm), by = .(lev, term)] %>% 
  .[, fftspectrum(estimate, c(3, 5), B = 5000, probs = c(0.025, 0.975)), by = .(term, lev)] -> spec
```

```{r A3, fig.cap = "Fourier spectrum of each timeseries. The shading indicates de 95\\% area derived by fitting an AR process to each series and bootstrapping 5000 simulated samples.", appendix = TRUE, fig.height=4, fig.width=7}
spec %>%
  # .[term != "full"] %>% 
  ggplot(aes(1/freq/12, spec)) +
  geom_ribbon(aes(ymin = `2%`, ymax = `98%`), position = "dodge", alpha = 0.1) +
  geom_line(aes(y = ar_spectrum), alpha = 0.15) +
  geom_line() +
  annotation_logticks(sides = "b") +
  scale_color_brewer(NULL, palette = "Dark2", aesthetics = c("color", "fill")) +
  scale_x_log10("Period (years)", sec.axis = sec_axis(~.*12)) +
  facet_grid(lev ~ term,labeller = labeller(lev = lev.lab, term = lab_sam), scales = "free") +
  tag_facets() 
```

```{r A4, fig.cap = "Autocorrelation functions of each timeseries", appendix = TRUE, fig.width=4, fig.height=4}
acf_dt <- function(...) {
  a <- acf(..., plot = FALSE)
  list(acf = as.vector(a$acf),
       lag = as.vector(a$lag))
}
indices %>% 
  .[lev %in% c(30, 700)] %>% 
  .[, acf_dt(estimate_norm), by = .(lev, term)] %>% 
  ggplot(aes(lag, acf)) +
  geom_col(aes(fill = term)) +
  scale_fill_brewer(palette = "Dark2") +
  facet_grid(term ~ lev,labeller = labeller(lev = lev.lab, term = lab_sam)) +
  tag_facets(position = "tr") 
```




```{r A8, appendix = TRUE, fig.cap = "Pattern cross-correlation \\#FIXME!", fig.height=4, fig.width=4}
vertical_regr %>% 
  .[term == "asym"] %>% 
  copy() %>% 
  .[, id := interaction(lev, lon)] %>% 
  widyr::pairwise_cor(index_level, id, estimate, diag = TRUE) %>% 
  as.data.table() %>% 
  ggplot(aes(item2, item1)) +
  geom_contour_fill(aes(z = correlation), na.fill = .99, breaks = MakeBreaks(binwidth = 0.1)) +
  geom_contour_tanaka(aes(z = correlation), size = 0.1, na.fill = .99, breaks = MakeBreaks(binwidth = 0.1)) +
  geom_text_contour(aes(z = correlation), na.fill = .99, breaks = MakeBreaks(binwidth = 0.1), 
                    color = "white", rotate = FALSE, stroke.color = "black", stroke = 0.2, 
                    skip = 1, size = 4,
                    data = ~.x[item2 > item1]) +
  geom_polygon(data = tri, fill = "white") +
  scale_fill_divergent("Pattern correlation", 
                       breaks = MakeBreaks(binwidth = 0.1),
                       guide = guide_colorstrip_bottom()) +
  scale_x_level(minor_breaks = logbreaks, position = "top") +
  scale_y_level(minor_breaks = logbreaks) +
  coord_equal() +
  theme(panel.spacing.x = unit(2, "lines"), strip.placement = "outside") 
```


```{r A9, fig.cap = "700 hPa Geopotetnial height zonal anomalies of composites of positive and negative SAM months selected using 1 standard deviation as threshhold. Numbers in the column headers are pattern correlation between SAM+ and SAM- composites and number of monthly fields used to construct the composites.", apendix = TRUE, fig.height = 5, fig.width = 7}
composites <- hgt[lev == 700] %>%
  indices_wide[., on = .NATURAL] %>% 
  .[, sign := ifelse(abs(full) > sd(full), sign(full), 0), by = season(time)] %>% 
  .[, .(hgt = mean(hgt_a), n = .N), by = .(lon, lat, sign, season(time))] %>% 
  .[, z := Anomaly(hgt), by = .(lat, sign, season)] 

composites_cors <- composites %>% 
  dcast(season + lat + lon ~ sign, value.var = "z") %>% 
  .[, .(cor = cor(`-1`, `1`)), by = season]

tags <- composites[order(sign, season)][sign != 0, paste0("n: ", unique(n)), by = .(sign, season)]

composites %>% 
  .[sign != 0] %>% 
  composites_cors[., on = "season"] %>% 
  .[order(season)] %>% 
  .[, season_text := paste0(season, "\ncor: ", signif(cor, 2))] %>% 
  .[, season_text := factor(season_text, levels = unique(season_text), ordered = TRUE)] %>% 
  periodic(lon = c(0, 360)) %>% 
  ggplot(aes(lon, lat)) +
  geom_contour_fill(aes(z = z), breaks = AnchorBreaks(0,exclude = 0), global.breaks = FALSE) +
  geom_contour_tanaka(aes(z = z), breaks = AnchorBreaks(0,exclude = 0), global.breaks = FALSE) +
  
  geom_qmap(~.x[lat <= 0]) +
  scale_x_longitude() +
  scale_y_latitude(limits = c(NA, -20), labels = NULL) +
  scale_fill_divergent(NULL, guide = guide_colorstrip_bottom(),
                       breaks = AnchorBreaks(0, binwidth = 15, exclude = 0)) +
  coord_polar() +
  axis_labs_smol +
  no_grid +
  facet_grid(sign~season_text, labeller = labeller(sign = c("-1" = "SAM-", "1" = "SAM+"))) +
  tag_facets(tag_pool = tags$V1, tag_suffix = "")
  
```

```{r A10, fig.cap = "Zonal of projection of 700 hPa onto the first EOF of each season.",  apendix = TRUE, fig.width=4, fig.height=4}
set.seed(42)
SAM_season <- hgt[lat <= -20] %>% 
  .[lev == 700] %>% 
  .[, hgt := hgt_a*sqrt(cos(lat*pi/180))] %>% 
  .[, season := season(time)] %>% 
  .[, .(eof = list(EOF(hgt ~ time | lon + lat, n = 1, data = .SD))), 
    by = .(season)]

SAM_season[, eof[[1]]$left, by = season] %>% 
  copy() %>% 
  setnames("hgt", "EOF") %>% 
  .[, EOF := EOF/sd(EOF), by = .(season)] %>% 
  hgt[., on = "time"] %>% 
  .[, .(proj = sum(EOF*hgt_a)), by = .(lon, lat, season)] %>% 
  .[season == "DJF", proj := -proj] %>% 
  .[, proj_z := Anomaly(proj), by = .(lat, season)] %>% 
   periodic(lon = c(0, 360)) %>% 
  ggplot(aes(lon, lat)) +
  geom_contour_fill(aes(z = proj_z), breaks = AnchorBreaks(0,exclude = 0), global.breaks = FALSE) +
  geom_contour_tanaka(aes(z = proj_z), breaks = AnchorBreaks(0,exclude = 0), global.breaks = FALSE) +
  geom_qmap(~.x[lat <= 0]) +
  scale_x_longitude() +
  scale_y_latitude(limits = c(NA, -20), labels = NULL) +
  scale_fill_divergent(NULL, guide = "none") +
  coord_polar() +
  axis_labs_smol +
  no_grid +
  facet_wrap(.~season)
```

