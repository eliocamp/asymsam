---
twocol: TRUE  #  Use FALSE for submission. 
title: Title here
author1: 
  name: Elio Campitelli
  email: elio.campitelli@cima.fcen.uba.ar
author2: 
  name: Leandro DÃ­az
affiliation: "CIMA UBA blablabla"
extra_authors: 
  - name: Carolina Vera
abstract: |
  Enter the text of your abstract here. This is a sample American Meteorological Society (AMS) \LaTeX\ template.  This document provides authors with instructions on the use of the AMS \LaTeX\ template.  Authors should refer to the file amspaper.tex to review the actual \LaTeX\ code used to create this document. The template.tex file should be modified by authors for their own manuscript.
statement: |
  This is significant becasue I wrote it.
bibliography: AsymSAM.bib
output: 
  rticles::ams_article:
    latex_engine: "xelatex"
header-includes: 
 - \usepackage{gensymb}
 - \usepackage{subfig}
---

```{r setup, echo = FALSE,warning=FALSE, message = FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  fig.path = "",
  message = FALSE,
  warning = FALSE,
  cache = TRUE,
  cache.extra = 42,
  cache.path = "../cache/",
  collapse = TRUE,
  comment = "#>",
  dpi = 300,
  out.extra = ""
)
library(metR)
library(data.table)
library(ggplot2)
library(magrittr)
library(ggperiodic)
library(asymsam)
library(latex2exp)
library(tagger)

theme_set(theme_asymsam(base_size = 10))
ZeroBreaks <- AnchorBreaks(0, NULL, 0)
axis_labs_smol <- theme(axis.text = element_text(size = 6))
lev.lab <- AddSuffix(" hPa")

guide_colorstrip_bottom <- function(width = 25, height = 0.5, ...) {
  guide_colorstrip(title.position = "top", title.hjust = 0.5,
                   barheight = height,
                   barwidth = width, ...)
}


knitr::opts_hooks$set(invisible = function(options) {
  options$include = FALSE
  options
})

main_levs <- c(700, 300, 30, 50)

combine_lists <- function(...) {
  X <- list(...)
  names <- names(X[[1]])
  names(names) <- names
  lapply(names, function(n) {
    unlist(lapply(X, function(x) x[[n]]))
  })
}
```


<!-- The actual document text starts here: -->

# Introduction 

yada yada SAM yada yada circulation.. yada yada so important. yada yada many impacts. 


```{r read-hgt}
hgt <- ReadNetCDF(ERA5(), 
                  subset = list(time = c("1979-01-01", "2018-12-31"),
                                latitude = c(-90, 10),
                                level = as.list(main_levs)),
                  vars = c(hgt = "z")) %>% 
  normalise_coords() %>% 
  .[, hgt := hgt/9.8] %>% 
  .[, hgt_a := hgt - mean(hgt), by = .(lon, lat, lev, month(time))]
```

```{r compute-SAM}
SAM <- hgt[lat <= -20] %>% 
  .[, hgt := hgt_a*sqrt(cos(lat*pi/180))] %>% 
  .[, .(eof = list(eof_flip(EOF(hgt ~ time | lon + lat, n = 1, data = .SD)))), 
    by = .(lev)]

dims <- hgt[lat <= -20] %>% 
  .[, .(x = uniqueN(lon), y = uniqueN(lat), t = uniqueN(time))]
```


# Methods

### Data 

We used monthly geopotential height at 2.5 longitude by 2.5 latitude resolution from ERA5 [@hersbach] for the period 1979 to 2018 (inclusive).

Monthly temperature NOAA Global Surface Temperature (NOAAGlobalTemp) 5.0 degree latitude x 5.0 degree longitude global grid [@vose2012; @smith2008]. The same analysis was carried out using CRUTEM4 [@osborn2014] (not shown). 

We used monthly precipitation data from CPC Merged Analysis of Precipitation [@xie1997] 2.5 degree latitude x 2.5 degree longitude. CPCC: [schneider2015]  #FIXME


### Definition of indices

We defined the Southern Annular Mode (SAM) as the leading EOF of the monthly anomalies of geopotential field at 700 hPa south of 20\degree S (citation?). The EOF was performed by computing the Singular Value Decomposition of the data matrix consisting in `r dims$t` rows and  `r dims$x*dims$y` columns (`r dims$x` points of longitude and `r dims$y` points of latitude). The values where weighted by the square root of the cosine of latitude to account for the non-equal area of each gridpoint [@chung1999]. This same method was used at the rest of the levels considered in this paper. 

To separate between the zonally symmetric and asymmetric components of the SAM, we computed the zonal mean and anomalies of the full SAM spatial pattern. The results are shown in Figure\ \ref{fig:method} for 700hPa. The full spatial signal ($\mathrm{EOF_1}(\lambda, \phi)$) is the sum of the zonally asymmetric ($\mathrm{EOF_1^*}(\lambda, \phi)$) and symmetric ($[\mathrm{EOF_1}](\lambda, \phi)$) components. We then compute the "Full", "Asymmetric" and "Symmetric" indices, by regressing each geopotential field on these patterns (weighting by the cosine of latitude).

The three indices are normalised by dividing them by the standard deviation of the "Full" index at each level. This means that comparing the magnitude between indices is meaningful, but it also means that not every index will have unit standard deviation. 

```{r method, fig.cap = "Spatial patterns of the first EOF of 700 hPa geopotential height. Full field (left), zonally asymmetric component (middle) and zonally symmetric component (right). Arbitrary units.", fig.width=6, fig.height=2.5, fig.env="figure*"}
sam_sep <- SAM[, eof[[1]]$right, by = .(lev)] %>% 
  setnames("hgt", "full") %>% 
  .[, c("sym", "asym") := list(mean(full), Anomaly(full)), by = .(lat, lev)] %>% 
  rm_singleton()


lab_sam <-  c(full = "Full", 
              asym = "Asymmetric",
              sym  = "Symmetric")

lab_eof <- c(full = TeX("$\\mathrm{EOF_1}(\\lambda, \\phi)$"),
             asym = TeX("$\\mathrm{EOF_1}^*(\\lambda, \\phi)$"), 
             sym  = TeX("$\\[\\mathrm{EOF_1}\\](\\lambda, \\phi)$"))

sam_plot <- sam_sep %>% 
  .[lev %in% c(700)] %>%
  melt(id.vars = c("lon", "lat", "lev")) %>% 
  .[variable == "sym", value := value + rnorm(.N, 0, sd = 1e-6)] %>%
  .[, variable := factor(variable, levels = names(lab_sam), ordered = TRUE)] 

levels(sam_plot$variable) <- lab_eof

sam_plot %>% 
  periodic(lon = c(0, 360)) %>%
  ggplot(aes(lon, lat)) +
  # geom_contour(aes(z = value, linetype = factor(-sign(..level..))), global.breaks = FALSE) +
  geom_contour_fill(aes(z = value), global.breaks = FALSE, breaks = ZeroBreaks) +
  geom_contour_tanaka(aes(z = value), global.breaks = FALSE, breaks = ZeroBreaks) +
  geom_qmap() +
  scale_x_longitude() +
  scale_y_latitude(limits = c(NA, -20), labels = NULL) +
  scale_fill_divergent(guide = "none") +
  coord_polar() +
  facet_grid(.~variable, labeller = labeller(variable = label_parsed, lev = lev.lab)) +
  axis_labs_smol +
  tag_facets()
```


### Significance

We adjusted p-values for False Detection Rate following @wilks2016. 


# Results


## Temporal evolution

```{r compute-asymsam}
indices_file <- data_path("derived", "indices.Rds")
if (file.exists(indices_file)) {
  indices <- readRDS(indices_file)
  indices[, `:=`(estimate = -estimate, estimate_norm = -estimate_norm)]
} else {
  stop("Run 02-compute-eofs.R")
}

indices_wide <- dcast(indices, + lev + time ~ term, value.var = "estimate_norm")
```

```{r}
# indices %>% 
#   copy() %>% 
#   .[lev %in% c(50, 700)] %>% 
#   .[, cumestimate := cumsum(estimate_norm), by = .(lev, term, season(time))] %>% 
#   
#   
#   ggplot(aes(time, cumestimate)) +
#   geom_line(aes(color = term)) +
#   # ggridges::geom_vridgeline(stat="ydensity", scale = -4e8, fill = NA,
#   #                           aes(color = term, width = ..density.., x = min(time - 1e7))) +
#   scale_color_brewer(NULL, palette = "Dark2", labels = lab_sam) +
#   scale_y_continuous(NULL) +
#   # scale_x_datetime(NULL, expand = c(0, 0)) +
#   facet_grid(lev~season(time), labeller = labeller(lev = lev.lab)) +
#   tag_facets()

```



```{r asymsam-timeseries, fig.cap = "Time series for the asymmetric SAM and symmetric SAM and density estimates.", fig.width=6, fig.height=3, fig.env="figure*"}
indices %>% 
  .[lev %in% c(50, 700) & term != "full"] %>% 
  # .[, estimate_norm := estimate_norm/sd(estimate_norm), by = .(lev, term)] %>% 
  ggplot(aes(time, estimate_norm)) +
  geom_line(aes(color = term)) +
  ggridges::geom_vridgeline(stat="ydensity", scale = -4e8, fill = NA,
                            aes(color = term, width = ..density.., x = min(time - 1e7))) +
  # geom_smooth(aes(color = term), method = "loess", n = 481, span = 10*12/481, method.args = list(degree = 1)) +
  # geom_point(data = ~.x[lev == 50][time == as.Date("1987-11-01") & term == "sym" | 
  #                         time == as.Date("1987-08-01") & term == "asym"]) +
  ggforce::geom_mark_circle(data = ~.x[lev == 50][time == as.Date("1987-11-01") & term == "sym" | 
                                                    time == as.Date("1987-08-01") & term == "asym"],
                            expand = unit(2, "mm")) +
  scale_color_brewer(NULL, palette = "Dark2", labels = lab_sam) +
  scale_y_continuous(NULL) +
  # scale_x_datetime(NULL, expand = c(0, 0)) +
  facet_grid(lev~., labeller = labeller(lev = lev.lab)) +
  tag_facets()
```


Figure \ref{fig:asymsam-timeseries} shows the resulting Asymmetric and Symmetric time series corresponding to 700 and 50hPa.  #FIXME

At first glance the series can be distinguished by their distributions. Whereas the tropospheric incides are aproximately normally distributed, the stratospheric indices are more long-tailed; that is, extreme values (both negative and positive) abound. The Asymmetric series have both more variability in the higher frequencies than the Symmetric series.

The stratospheric Symmetric SAM varies strongly witha two-year period, which can be seen using spectral methods (Figure A3) or in the autocorrelation structure (Figure A4). There is a local peak at 2 years in the periodigram of the tropospheric Symmetric SAM also, although it's not statistically significant. In the troposphere the most significant peak of variability is found in the Asymmetric index at around `r 12*.3` months. 

```{r compute-cors}
ccf_dt <- function(..., plot = FALSE) {
  stat <- ccf(..., plot = plot)
  list(lag = stat$lag[, 1, 1], 
       acf = stat$acf[, 1, 1])
}

cors <- indices_wide %>% 
  .[, ccf_dt(asym, sym, lag.max = 5), by = .(lev)]
```

From Figure \ref{fig:asymsam-timeseries} we can see that the Asymemtric and Symmetric time series appear to be correlated. Moreover, looking at the extremes in the stratosphere, the Symmetric serie appears to lag the Asymmetric series (see, for example, the positive events on late 1987 marked with a circle). We show these correlations, across all the levels of the reanalysis and for zero and -1 lag (Asymmetric index leading the Symmetric index), in Figure \ref{fig:cor-lev}. 

```{r cor-lev, fig.cap = "Correlation between the Symmetric and Asymmetric SAM at each level for lag zero and lag -1 (Asymmetric leads Symmetric).", fig.width=3, fig.height=3}
cors %>% 
  .[lag %in% c(0, -1)] %>% 
  ggplot(aes(lev, acf)) +
  geom_line(aes(color = factor(lag, levels = c(0, -1), ordered = TRUE),
                linetype = factor(lag, levels = c(0, -1), ordered = TRUE))) +
  scale_x_level() +
  scale_y_continuous("Correlation", limits = c(0, 1)) + 
  scale_linetype_manual(NULL, values = c(1, 5), labels = c("0" = "Zero-lag", 
                                                         "-1" = "Asymmetric leads\nSymmetric (1 month)")) +
  scale_color_brewer(NULL, palette = "Dark2", labels = c("0" = "Zero-lag", 
                                                         "-1" = "Asymmetric leads\nSymmetric (1 month)")) +
  coord_flip()
```


Zero-lag correlations between the Asymmetric and Symmetric series are relatively constant throught the troposphere, fluctiating between `r signif(cors[lag == 0 & lev >= 100, min(acf)], 2)` and `r signif(cors[lag == 0 & lev >= 100, max(acf)], 2)`. One-month-lag correlations are similarly constant but significantly reduced, hovering around `r signif(cors[lag == -1 &lev > 500][, mean(acf)], 2)`. In the stratosphere, zero-lag correlations drop to a minimum of `r signif(cors[lag == 0 & lev < 100][which.min(acf)]$acf, 2)` at `r cors[lag == 0 & lev < 100][which.min(acf)]$lev` hPa and then it increases again monotonically with height up to the uppermost level of the reanalysis. At the same time, one-month-lag correlations increase with height. 

```{r cross-correlation, fig.cap = "Cross correlation between levels of the Full, Asymmetric and Symmetric SAM.", fig.width = 6, fig.height=3, fig.env="figure*"}
tri <- matrix(c(1000, 1000, 1000, 1, 1, 1, 1000, 1000), ncol = 2, byrow = TRUE) %>% 
  as.data.table() %>% 
  setnames(., colnames(.), c("item1", "item2"))

logbreaks <- function(range) {
  ticks <- ggplot2:::calc_logticks(minpow = log10(min(range)), maxpow = log10(max(range)))
  ticks$value[ticks$end == 0.2]
}

crosscor <- indices %>% 
  copy() %>% 
  .[, widyr::pairwise_cor(.SD, lev, time, estimate, diag = FALSE), by = .(term)] 
crosscor %>% 
  ggplot(aes(item2, item1)) +
  geom_contour_fill(aes(z = correlation), na.fill = .99, breaks = MakeBreaks(binwidth = 0.1)) +
  geom_contour_tanaka(aes(z = correlation), size = 0.1, na.fill = .99, breaks = MakeBreaks(binwidth = 0.1)) +
  geom_text_contour(aes(z = correlation), na.fill = .99, breaks = MakeBreaks(binwidth = 0.1), 
                    color = "white", rotate = FALSE, stroke.color = "black", stroke = 0.2, 
                    skip = 1, size = 2) +
  geom_polygon(data = tri, fill = "white") +
  scale_fill_divergent("Cross-correlation", 
                       breaks = MakeBreaks(binwidth = 0.1),
                       guide = guide_colorstrip_bottom()) +
  scale_x_level(minor_breaks = logbreaks, position = "top") +
  scale_y_level(minor_breaks = logbreaks) +
  coord_equal() +
  facet_grid(. ~ term, labeller = labeller(term = lab_sam)) +
  theme(panel.spacing.x = unit(2, "lines"), strip.placement = "outside") +
  tag_facets(position = "br")
```


Figure \ref{fig:cross-correlation}a) shows (zero-lag) cross-correlation across levels for the Full, Symmetric and Asymmetric SAM indices. For the Full SAM (panel a), high values below 100 hPa reflect the vertical (zero-lag) coherency throughout the troposfere. Above 100 hPa correlation between levels falls off more rapidly, indicating less coherent (zero-lag) variability. Still there is a non negligible correlation between the troposphere and the lower-to-middle stratosphere. Examining panels b and c, we see that the Asymemtric and Symmetric SAM  share the same high level of coherency in the troposphere but they differ in their stratospheric behaviour. As evidenced by the wider dark red areas near the diagonal in Figure \ref{fig:cross-correlation}b) vs.  Figure \ref{fig:cross-correlation}c), stratospheric coherency is stronger for the Asymmetric SAM than the Symemtric SAM. The stratospheric Symmetric SAM seems to connect more strongly to the trosposphere than the Asymmetric SAM; this can be seen by the lower correlation values in the top right left of Figure \ref{fig:cross-correlation}b) in comparison with Figure \ref{fig:cross-correlation}c).


<!-- ```{r} -->
<!-- indices_wide %>%  -->
<!--   .[, FitLm(as.numeric(time), asym, sym, se = TRUE), by = .(lev)] %>%  -->
<!--   rm_intercept() %>%  -->
<!--   # .[, term := NULL] %>%  -->
<!--   .[, estimate := estimate/(3600*24*365*10)] %>% -->
<!--   .[, std.error := std.error/(3600*24*365*10)] %>% -->
<!--   # setnames("type", "term") %>%  -->
<!--   ggplot(aes(lev, estimate)) + -->
<!--   geom_ribbon(aes(ymax = estimate + std.error*1.96, ymin = estimate - std.error*1.96), alpha = 0.3) + -->
<!--   geom_line() + -->
<!--   scale_fill_brewer(palette = "Dark2", aesthetics = c("color", "fill")) + -->
<!--   geom_hline(yintercept = 0) + -->
<!--   scale_x_level() + -->
<!--   scale_y_continuous("Standard deviations per decade") + -->
<!--   coord_flip() + -->
<!--   facet_grid(~ term,labeller = labeller(term = lab_sam)) + -->
<!--   tag_facets()  -->
<!-- ``` -->




```{r trends, fig.cap = "Decadal normalised trends for each index at each level for annual (row a) and seasonal values (rows b-e) for the period 1979-2018. Shading indicates the 95\\% confidence interval.", fig.width = 6, fig.height=4, fig.env="figure*"}
annual_trend <- indices %>%
  copy() %>% 
  .[, estimate_norm := estimate_norm/sd(estimate_norm), by = .(lev, term)] %>%
  .[, FitLm(estimate_norm, time, se = TRUE), by = .(lev, type = term)] %>% 
  rm_intercept() %>% 
  .[, term := NULL] %>% 
  .[, season := "Annual"]


indices %>% 
  copy() %>% 
  # .[time > as.Date("1990-01-01")] %>%
  .[, season := season(time)] %>% 
  .[, estimate_norm := estimate_norm/sd(estimate_norm), by = .(lev, term)] %>% 
  .[, FitLm(estimate_norm, time, se = TRUE), by = .(type = term, lev, season)] %>% 
  rm_intercept() %>% 
  .[, term := NULL] %>% 
  rbind(annual_trend) %>% 
  .[, estimate := estimate*3600*24*365*10] %>% 
  .[, std.error := std.error*3600*24*365*10] %>% 
  setnames("type", "term") %>% 
  .[, season := forcats::fct_relevel(season, "Annual")] %>% 
  ggplot(aes(lev, estimate)) +
  geom_ribbon(aes(ymax = estimate + std.error*1.96, ymin = estimate - std.error*1.96), alpha = 0.3) +
  geom_line() +
  scale_fill_brewer(palette = "Dark2", aesthetics = c("color", "fill")) +
  geom_hline(yintercept = 0) +
  scale_x_level() +
  scale_y_continuous("Standard deviations per decade") +
  coord_flip() +
  facet_grid(season ~ term,labeller = labeller(term = lab_sam)) +
  tag_facets("rc") 
```

Figure \ref{fig:trends} shows normalised decadal trends for each index for the whole period 1979-2918 along with the 95% confidence interval in shading for the whole year (row a) and separed by trimesters (rows b through e). As documented by #FIXME (e.g. @fogt2020), there is a statistically significant increase towards more positive SAM (panel a.1), which is XX only in Summer and Autumn (panels b.1 and c.1). We observe these increases mainly in the troposphere, reaching their maximum at at 100 hPa in Summer. By separating the SAM signal in its Asymmetric and Symmetric parts, we can not only see that these trends are almost entirely due to the Symmetric component (columns 2 vs. columns 3), but in some cases the trends become more clear. In Summer, the Asymmetric SAM has a statistically non significant negative trend in the middle troposphere that obscures the signal; as a result, trends computed using only the Symmetric component are more clear (compare the shading region in panel b.1 and b.3). In Autumn, using the Symmetric SAM reveals a statistically significant positive trend in the stratosphere that is not significant using the Full index. 

```{r regression-90}
local <- indices %>%
  .[time >= as.Date("1990-01-01")] %>% 
  .[, estimate_norm := estimate_norm/sd(estimate_norm), by = .(lev, term)] %>%
  .[, FitLm(estimate_norm, time, se = TRUE), by = .(lev, type = term, season(time))] %>% 
  rm_intercept() %>% 
  .[, term := NULL] %>% 
  .[, estimate := estimate*3600*24*365*10] %>% 
  .[, std.error := std.error*3600*24*365*10] 

trends_text <- local[, paste0(signif(estimate, 2), " \\pm ", signif(std.error*1.96, 2)), 
                     by = .(term = type, season, lev)]
```

We stress that these are only linear trends during the whole period and the absence of a statistically significant signal should not be taken as evidence of no sistematic change. In particular, going back to Figure \ref{fig:asymsam-timeseries}, we can see an evident change in the stratospheric Asymemtric component (red line in panel a) between the 90's, when we see a dominance of extreme negative values, and the 00's, when we see the inverse. This change is restricted to the Winter months: the linear trend for JJA starting in 1990 for the Asymmetric component at 50hPa is $`r trends_text[term == "asym" & lev == 50 & season == "JJA"]$V1`$.

These results point to very different behaviours between the stratospheric and tropospheric SAM. #FIXME

This suggests that both the Asymmetric and the Symemtric component of the tropospheric SAM are highly vertically coherent, both in their individual evolution and their temporal relationship. This is to be expected since the SAM is mostly equivalent barotropic (citaaaa). 



## Spatial patterns


```{r compute-regr-pattern}
indices_2d_yearly <- hgt[lev %in% c(main_levs)] %>% 
  indices_wide[., on = .NATURAL, allow.cartesian = TRUE] %>% 
  .[, combine_lists(FitLm(hgt_a, sym, asym, se = TRUE),
                    FitLm(hgt_a, full, se = TRUE)),
    by = .(lon, lat, lev)] %>% 
  rm_intercept() %>% 
  .[, p.val := Pvaluate(estimate, std.error, df, "fdr"), by = .(term, lev)] %>% 
  periodic(lon = c(0, 360)) %>% 
  .[, term := factor(term, levels = names(lab_sam), ordered = TRUE)] 
```


To undertand the spatial patterns associated with both indeces, we regressed monthly geopotential anomalies into both indeces using multiple regression 


```{r 2d-regr, fig.cap = "Regression patterns of geopotential height at 30, 300 and 700 hPa with the Full, Asymmetric and Symmetric SAM. The regression patterns for Asymmetric and Symmetric SAM are the result of one multiple regression using both indices, not of two simple regressions involving each index by itsef.", fig.env = "figure*", fig.width=7, fig.height=5}
indices_2d_yearly %>% 
  .[lat <= -20] %>% 
  .[lev %in% c(50, 700)] %>% 
  ggplot(aes(lon, lat)) +
  geom_contour_fill(aes(z = estimate), breaks = ZeroBreaks, global.breaks = FALSE) +
  geom_contour_tanaka(aes(z = estimate),
                      breaks = ZeroBreaks,
                      size = 0.3,
                      global.breaks = FALSE) +
  geom_qmap(~.x[lat <= -20]) +
  scale_x_longitude() +
  scale_y_latitude(limits = c(NA, -20), labels = NULL) +
  scale_fill_divergent(NULL, guide = guide_colorstrip_bottom(), 
                       limits = c(-85, 85),
                       oob = scales::squish,
                       breaks = MakeBreaks(binwidth = 20, exclude = 0)) +
  scale_linetype(guide = "none") +
  coord_polar() +
  facet_grid(lev ~ term, labeller = labeller(term = lab_sam, lev = lev.lab)) +
  tag_facets("rc") +
  axis_labs_smol 
```

Figure \ref{fig:2d-regr} shows the spatial year-long regression #FIXME. Column a are regressinos using the Full SAM, while columns b and c are regression coefficients computed in a multiple regression of geopotential height on the Asymmetric and Symmetric indices at the same time. Thus, they are to be interpreted as the patterns associated with each index, controling for the (linear) effect of the other. (Figure A6 #FIXME illustrates the difference between computing two simple regressions and one multiple regression.)

In the stratosphere, the spatial pattern associated with the Full SAM is more clearly dominated by a zonally symmetric, monopolar structure (panel a.1) which is, however, not perfectly centered in the south pole. The monopole obtained by multiple regression with the Asymmetric and Symmetric SAM (panel c.1) is much more symmetric and the shift from total symmetry is captured by the regression pattern of the Asymmetric SAM as a wave-1 with maximum anomalies above the Belinghausen Sea on the Western Hemisphere and and Davids Sea in the Eastern Hemisphere (panel b.1).

In the troposphere, panel a.2 show the well known zonally symmetrical annular mode *contaminated* with zonal asymmetries in the form of a wave-3. The regression using the Asymmetric and Symmetric SAM indices successfully disentangle both structures. The Asymmetric component gives rise to a cleaner zonal wave (panel b.2) and the Symemtric component is assosiated with an trully annular mode, almost devoid of zonal asymmetries (panel c.2).  #FIXME (agregar algo mÃ¡s?)



```{r wave-amplitude, fig.cap = "Planteray wave amplitude for the regression patterns at 50 and 700 hPa.", fig.width=3, fig.height=4}
indices_2d_yearly %>% 
  .[lat < -20] %>%
  .[lev %in% c(50, 700)] %>% 
  .[, FitWave(estimate, 0:3), by = .(lat, lev, term)] %>% 
  ggplot(aes(lat, amplitude)) +
  geom_line(aes(color = factor(k))) +
  scale_color_brewer("Wave-number", palette = "Dark2") +
  scale_y_continuous("Amplitude") +
  scale_x_latitude(ticks = 20) +
  coord_flip() +
  facet_grid(term~lev, labeller = labeller(term = lab_sam, lev = lev.lab), scales = "free_x") +
  tag_facets(position = "tr")
```

The amplitude of each zonal wave number at each latitude at 50 hPa and 700 hPa is shown in Figure \ref{fig:wave-amplitude}, where wave number zero represents the amplitude of the zonal mean. Comparing between rows, this Figure quantifies the relatively clean separation between the zonally symmetric and zonally asymmetric structures, as its evident how the mixture of waves of the Full field (first row) is very similar to the sum of the waves of the Asymmetric and Symmetric field (second and third row, respectively). The second row of Figure \ref{fig:wave-amplitude} shows that the Asymmetric SAM is overwhelmingly dominated by wave 1 in the stratosphere (panel b), while in the troposphere it is composed of zonal waves 3 to 1 in decreasing level of importance. 



```{r compute-vertical-regression}
# vertical_regr <- ReadNetCDF(ERA5(), 
#            subset = list(time = c("1979-01-01", "2018-12-31"),
#                          latitude = c(-65, -40)),
#            vars = c(hgt = "z")) %>% 
#   normalise_coords() %>% 
#   .[, .(hgt = weighted.mean(hgt, w = cos(lat*pi/180))), by = .(lon, lev, time)] %>% 
#   .[, hgt := hgt/9.8] %>% 
#   .[, hgt_a := hgt - mean(hgt), by = .(lon, lev, month(time))] %>% 
#   indices_wide[., on = .NATURAL, allow.cartesian = TRUE] %>% 
#   .[, FitLm(hgt_a, sym, asym, se = TRUE),
#     by = .(lon, lev)] %>% 
#   rm_intercept() %>% 
#   .[, p.val := Pvaluate(estimate, std.error, df, "fdr"), by = .(term, lev)] %>% 
#   periodic(lon = c(0, 360)) %>% 
#   .[, term := factor(term, levels = names(lab_sam), ordered = TRUE)] 

indices_wide %>% 
  copy() %>% 
  setnames("lev", "index_level") -> indices_for_regr

vertical_regr <- ReadNetCDF(ERA5(), 
                            subset = list(time = c("1979-01-01", "2018-12-31"),
                                          latitude = c(-65, -40)),
                            vars = c(hgt = "z")) %>% 
  normalise_coords() %>% 
  .[, .(hgt = weighted.mean(hgt, w = cos(lat*pi/180))), by = .(lon, lev, time)] %>% 
  .[, hgt := hgt/9.8] %>% 
  .[, hgt_a := hgt - mean(hgt), by = .(lon, lev, month(time))] %>% 
  indices_for_regr[., on = .NATURAL, allow.cartesian = TRUE] %>% 
  .[, combine_lists(FitLm(hgt_a, full, se = TRUE),
                    FitLm(hgt_a, sym, asym, se = TRUE)),
    by = .(lon, lev, index_level)] %>% 
  rm_intercept() %>% 
  .[, p.val := Pvaluate(estimate, std.error, df, "fdr"), by = .(term, index_level, lev)] %>% 
  periodic(lon = c(0, 360)) %>% 
  .[, term := factor(term, levels = names(lab_sam), ordered = TRUE)] 
```


```{r vertical-regression, fig.cap = "Asymmetric coefficient of the multiple regression of mean monthly geopotential height anomalies between 65 and 40 South. (\\#FIXME this caption needs some love)", fig.width = 3, fig.height=3}
vertical_regr %>% 
  .[index_level %in% c(50, 700)] %>% 
  .[term == "asym"] %>%
  ggplot(aes(lon, lev)) +
  geom_contour_fill(aes(z = estimate), breaks = AnchorBreaks(0, 10, 0)) +
  geom_contour_tanaka(aes(z = estimate),
                      breaks = AnchorBreaks(0, 10, 0),
                      size = 0.3,
                      global.breaks = FALSE) +
  # geom_contour2(aes(z = p.val), breaks = 0.01) +
  scale_fill_divergent(NULL, guide = guide_colorstrip_bottom(18), 
                       oob = scales::squish,
                       breaks = MakeBreaks(binwidth = 10, exclude = 0)) +
  scale_y_level() +
  scale_x_longitude(ticks = 60)  +
  facet_grid(index_level~., labeller = labeller(index_level = lev.lab)) +
  tag_facets(position = "bl") 
```


To analyse the vertical structure of the geopotential anomalies asociated with the asymetric SAM index, we show a vertical cross section of regressions of mean geopotential height between 65ÂªS and 40ÂªS for the 50 hPa Asymmetric SAM index (panel a) and for the 700 hPa Asymmetric SAM index (panel b) (Figure \ref{fig:vertical-regression}). 

The geopotential anomalies associated with the stratospheric SAM (panel a) are clearly constrained to the stratosphere, which underscores the disconnect between the stratospheric and tropospheric symetric SAM. The vertical structure this signal tilts about 60Âª to the West between 100 hPa and 1 hPa, suggesting baroclinic processes and polarward transport of heat (#FIXME is this ok?). Interestingly, the signal in the stratosphere maximises near 10 hPa despite using the 50 hPa index for the regression. 

The tropospheric asymmetric SAM has significant signals that extend upwards the uppermost levels of the reanalysis. In the troposphere, the wave-3 structure is equivalent barotropic with maximum amplitude at roughly 250 hPa. #FIXME moaaaaar.

Interestingly, the structures shown in Figure \ref{fig:vertical-regression} are surprisignly robust to the choice of index level. For any stratospheric (above 100 hPa) index, the resulting anomalies are very similar to the wave-1 structure with maximum near 10 hPa in panel a. Conversely, for any tropospheric (below 100 hPa) index, the result is very similar to panel b. The pattern cross-correlation between levels of each segment of the atmosphere is greater than 0.9 (Figure A#fixme). The patterns mainly change in amplitude. The tropospheric pattern is maximised by the 300 hPa Asymmetric SAM index and the stratospheric pattern increased monotonically with height. 



<!-- ```{r compute-regr-pattern-season} -->
<!-- indices_2d <- hgt[lev %in% main_levs] %>%  -->
<!--   indices_wide[., on = .NATURAL, allow.cartesian = TRUE] %>%  -->
<!--   .[, rbind(as.data.table(FitLm(hgt_a, sym, asym)), -->
<!--             as.data.table(FitLm(hgt_a, full))), -->
<!--     by = .(lon, lat, lev, season(time))] %>%  -->
<!--   rm_intercept() %>%  -->
<!--   periodic(lon = c(0, 360)) %>%  -->
<!--   .[, term := factor(term, levels = names(lab_sam), ordered = TRUE)]  -->
<!-- ``` -->


<!-- ```{r 2d-regr-700, fig.cap = "Seasonal regression patterns of geopotential height at 700 hPa with the Full, Asymmetric and Symmetric SAM. The regression patterns for Asymmetric and Symmetric SAM are the result of one multiple regression using both indices, not of two simple regressions involving each index by itsef.", fig.width =10, fig.height=7, fig.env = "sidewaysfigure"} -->
<!-- indices_2d %>%  -->
<!--   .[lat <= -20] %>%  -->
<!--   .[lev == 700] %>%  -->
<!--   ggplot(aes(lon, lat)) + -->
<!--   geom_contour_fill(aes(z = estimate),  breaks = AnchorBreaks(0, binwidth = 5, 0), -->
<!--                     global.breaks = FALSE) + -->
<!--   geom_contour_tanaka(aes(z = estimate), -->
<!--                       breaks = AnchorBreaks(0, binwidth = 5, 0), -->
<!--                       size = 0.3, -->
<!--                       global.breaks = FALSE) + -->
<!--   geom_qmap(~.x[lat <= -20]) + -->
<!--   scale_x_longitude() + -->
<!--   scale_y_latitude(limits = c(NA, -20), labels = NULL) + -->
<!--   scale_fill_divergent(NULL, guide = guide_colorstrip_bottom(), -->
<!--                        limits = c(-55, 55), -->
<!--                        oob = scales::squish, -->
<!--                        breaks = AnchorBreaks(0, binwidth = 5, 0)) + -->
<!--   scale_linetype(guide = "none") + -->
<!--   coord_polar() + -->
<!--   facet_grid(term ~ season, labeller = labeller(term = lab_sam, lev = lev.lab)) + -->
<!--   tag_facets() + -->
<!--   axis_labs_smol -->
<!-- ``` -->



<!-- ```{r 2d-regr-30, fig.cap = "Seasonal regression patterns of geopotential height at 30 hPa with the Full, Asymmetric and Symmetric SAM. The regression patterns for Asymmetric and Symmetric SAM are the result of one multiple regression using both indices, not of two simple regressions involving each index by itsef.", fig.width =10, fig.height=7, fig.env = "sidewaysfigure"} -->
<!-- indices_2d %>%  -->
<!--   .[lat <= -20] %>%  -->
<!--   .[lev == 30] %>%  -->
<!--   ggplot(aes(lon, lat)) + -->
<!--   geom_contour_fill(aes(z = estimate),  breaks = AnchorBreaks(0, binwidth = 20, 0), -->
<!--                     global.breaks = FALSE) + -->
<!--   geom_contour_tanaka(aes(z = estimate), -->
<!--                       breaks = AnchorBreaks(0, binwidth = 20, 0), -->
<!--                       size = 0.3, -->
<!--                       global.breaks = FALSE) + -->
<!--   geom_qmap(~.x[lat <= -20]) + -->
<!--   scale_x_longitude() + -->
<!--   scale_y_latitude(limits = c(NA, -20), labels = NULL) + -->
<!--   scale_fill_divergent(NULL, guide = guide_colorstrip_bottom(), -->
<!--                        limits = c(-105, 105), -->
<!--                        oob = scales::squish, -->
<!--                        breaks = AnchorBreaks(0, binwidth = 20, 0)) + -->
<!--   scale_linetype(guide = "none") + -->
<!--   coord_polar() + -->
<!--   facet_grid(term ~ season, labeller = labeller(term = lab_sam, lev = lev.lab)) + -->
<!--   tag_facets() + -->
<!--   axis_labs_smol -->
<!-- ``` -->

## Impacts


### Temperature




```{r compute-air-regr}
time_subset <- list(time = range(indices$time))
air <- NOAATemp() %>% 
  ReadNetCDF(vars = "air", subset = c(time_subset, list(lat = c(-90, 10)))) %>% 
  normalise_coords()  %>%
  # Interpolate at lon = 0. Otherwise, can't close contours. 
  qwrap(lon = c(0, 360) ~ c(-2.5, 360)) %>% 
  .[ , Interpolate(air ~ lon + lat, x.out = c(0, unique(lon)), y.out = unique(lat)), by = time] %>% 
  .[lon != -2.5]

air_regr <- air %>% 
  # .[, air := Anomaly(air), by = .(lon, lat)] %>%
  .[indices_wide[lev == 700], on = .NATURAL] %>% 
  rm_singleton() %>% 
  .[, lapply(.SD, mean, na.rm = TRUE), by = .(lon, lat, time = seasonally(time))] %>%
  .[, nas := mean(is.na(air)), by = .(lon, lat, season(time))] %>% 
  .[nas >= 0.15, air := NA] %>% 
  .[, rbind(as.data.table(FitLm(air, asym, sym, se = TRUE)),
            as.data.table(FitLm(air, full, se = TRUE))),
    by = .(lon, lat, season(time))] %>% 
  rm_intercept() 
```


```{r regr-air-season, fig.cap = "Regression pattern of surface temperature with Asymmetric and Symmetric SAM. P-values smaller than 0.05 (controlling for Flase Detection Rate) as hatched areas. Gray areas have more than 15\\% of missing data.", fig.width = 10, fig.height = 7, fig.env = "sidewaysfigure"}
air_regr %>% 
  copy() %>% 
  # .[lat <= -61, estimate := NA] %>%
  .[lat >= 65, estimate := NA] %>%
  .[, p.value := Pvaluate(estimate, std.error, df, "fdr"), by = .(term, season)] %>% 
  .[, term := factor(term, levels = names(lab_sam), ordered = TRUE)] %>% 
  periodic(lon = c(0, 360)) %>% 
  ggplot(aes(lon, lat)) +
  geom_contour_fill(aes(z = estimate), na.fill = 0,
                    breaks = AnchorBreaks(0, 0.15, 0)) +
  # geom_raster(aes(fill = estimate)) +
  geom_contour2(aes(z = p.value), breaks = 0.05) +
  geom_contour_fill(aes(z = as.numeric(is.na(estimate))), breaks = 0.5, fill = "gray", color = "gray30") +
  geom_qmap(~.x[lat <= 0]) +
  scale_x_longitude() +
  scale_y_latitude(labels = NULL, limits = c(NA, 0)) +
  scale_fill_divergent("Surface temperature",  limits = c(-0.8, .8), oob = scales::squish,
                       guide = guide_colorstrip_bottom(), breaks = AnchorBreaks(0, 0.15, 0)) +
  coord_polar() +
  facet_grid(term ~ season, labeller = labeller(term = lab_sam, lev = lev.lab)) +
  tag_facets("cr", tag_suffix = "") +
  axis_labs_smol
```

Figure \ref{fig:regr-air-season} shows regression coefficients of each index at 700 hPa with surface temperature for each trimester. It is evident that the Asymmetric and Symmetric SAM indices are associated with overall distinct temperature patterns which can be obscured when using the Full SAM index. The Symmetric SAM signal is weaker than the Asymmetric SAM, as evidenced by the relatively smaller and les sstatistically significant regression coefficients in row 3 of Figure \ref{fig:regr-air-season} compared with row 2. 

In DJF (column a), the strong negative signal in the tropical Pacific in panel a.1 is mostly associated with the Asymmetric component (panel a.2), as is it largely absent in the Symmetric component (panel a.3). Furthermore, the Asymmetric SAM is also asociated with low temperature anomalies in the Indian ocean, but this signal is obscured by the Symmetric variability and thus lost in the Full SAM. Over the continents, the Asymmetric SAM is assoiated with negative temperature anomalies which, again, mostly disappear in the Full SAM regression. 

The patterns seen in MAM and JJA (columns b and c) are not robustly significant in the sense that there are no areas with p-values below 0.05 when controlling for FDR following @wilks2016. Nevertheless, it is interesting to note that in both trimesters, the sign of the regression is consistently flipped between the Asymmetric and Symmetric regressions. In South America, for example, the Asymmetric SAM is associated with positive temperature anomalies in MAM and negative temperature anomales in JJA, while the oposite is the case for the Symemtric SAM. 

Finally, in SON (column d), there is no significant temperature signal associated with the Symmetric SAM (panel d.3), while the Asymmetric SAM shows a relatively robust signal in the equatorial Pacitic, Australia, and even Southeast South America. This strong signals are reduced in intensity in panel a.3. 


### Precipitation


??


```{r compute-pp-regr} 
# pp <- CMAP() %>% 
#   ReadNetCDF(subset = list(lat = c(-90, -20))) %>% 
#   normalise_coords() %>% 
#   .[, precip := Anomaly(precip), by = .(lon, lat)]

continents <- list(africa  = list(lon = c(0, 60),
                                  lat = c(-40, 0)),
                   oceania = list(lon = c(100, 180),
                                  lat = c(-50, -5)),
                   america = list(lon = c(265, 325),
                                  lat = c(-60, -10)))


add_continent <- function(dt) {
  dt[, continent := fcase(lon %between% continents$africa$lon & 
                            lat %between% continents$africa$lat, "africa",
                          lon %between% continents$oceania$lon & 
                            lat %between% continents$oceania$lat, "oceania",
                          lon %between% continents$america$lon &
                            lat %between% continents$america$lat, "america")] %>% 
    .[, continent := factor(continent, levels = c("africa", "oceania", "america"), ordered = TRUE)] %>% 
    .[]
}



pp_regr_season <- CPCC() %>% 
  ReadNetCDF(subset = list(lon = lapply(continents, function(x) x$lon),
                           lat = lapply(continents, function(x) x$lat))) %>% 
  na.omit() %>% 
  normalise_coords() %>%
  .[, days := lubridate::days_in_month(time[1]), by = time] %>% 
  .[, precip := precip/days] %>% 
  # .[, air := Anomaly(air), by = .(lon, lat)] %>%
  .[indices_wide[lev == 700], on = .NATURAL] %>% 
  rm_singleton() %>% 
  add_continent() %>% 
  .[!is.na(continent)] %>% 
  .[, lapply(.SD, mean, na.rm = TRUE), by = .(lon, lat, continent, time = seasonally(time))] %>%
  .[, `:=`(precip_a = Anomaly(precip),
           precip_a_p = log(precip) - log(mean(precip, na.rm = TRUE))),
    by = .(lon, lat, season(time))] %>% 
  .[, nas := mean(is.na(precip)), by = .(lon,  lat, season(time))] %>% 
  .[nas >= 0.15, precip := NA] %>% 
  na.omit() %>% 
  .[is.finite(precip_a_p)] %>% 
  .[, combine_lists(FitLm(precip_a, asym, sym, se = TRUE),
                    FitLm(precip_a, full, se = TRUE)),
    by = .(lon, lat, season(time))] %>% 
  rm_intercept()

filter_sa <- function(data, lons = c(265, 325), lats = c(-80, -10)) {
  data[is.sa(data, lons = lons, lats = lats)]
}

```

```{r def-plot_pp}
plot_pp <- function(this_continent) {
  pp_regr_season %>%
    add_continent() %>% 
    # .[lat <= -10] %>% 
    .[continent == this_continent] %>%
    .[, p.value := Pvaluate(estimate, std.error, df, "none"), by = .(season, continent, term)] %>%
    .[, p.value2 := Pvaluate(estimate, std.error, df, "fdr"), by = .(season, continent, term)] %>%
    ggplot(aes(lon, lat)) +
    geom_contour_fill(aes(z = estimate), na.fill = 0, breaks = AnchorBreaks(0, 0.5, 0)) +
    # geom_raster(aes(fill = estimate/30)) +
    geom_contour2(aes(z = p.value2), breaks = 0.01) +
    # geom_contour_fill(aes(z = as.numeric(is.na(estimate))), breaks = 1) +
    # stat_subset(aes(subset = p.value <= 0.01 & is.cross(lon, lat, 1)), size = 0.4, alpha = 0.3) +
    geom_qmap(~.x %>% add_continent() %>% .[continent == this_continent], keep = 0.015, weighting = 0.9) +
    scale_x_longitude(ticks = 15) +
    scale_y_latitude(ticks = 15, labels = NULL) +
    scale_fill_divergent("Precipitation", 
                         limits = c(-3.4, 3.4),
                         oob = scales::squish,
                         guide = guide_colorstrip_bottom(), 
                         breaks = AnchorBreaks(0, 0.5, 0)) +
    coord_quickmap(xlim = continents[[this_continent]]$lon, 
                   ylim = continents[[this_continent]]$lat) +
    facet_grid(term ~ season, labeller = labeller(term = lab_sam, lev = lev.lab)) +
    tag_facets(position = "br") +
    axis_labs_smol
}
```

```{r pp-regr-global-africa,  fig.cap = "Regression pattern of precipiation with Asymmetric and Symmetric SAM. P-values smaller than 0.05 (controlling for Flase Detection Rate) as hatched areas. Africa", fig.width = 6, fig.height = 4.5, fig.env = "figure*"}
plot_pp("africa") 

```


```{r pp-regr-global-oceania,  fig.cap = "Same but for oceania", fig.width = 6, fig.height = 4.5, fig.env = "figure*"}
plot_pp("oceania") +
  tag_facets(position = "bl") 

```

```{r pp-regr-global-america,  fig.cap = "Same but for america", fig.width = 6, fig.height = 6, fig.env = "figure*"}
plot_pp("america")

```


## Conclusiones




This suggests that both the Asymmetric and the Symemtric component of the tropospheric SAM are highly vertically coherent, both in their individual evolution and their temporal relationship. This is to be expected since the SAM is mostly equivalent barotropic (citaaaa). 


\acknowledgments
CMAP Precipitation data provided by the NOAA/OAR/ESRL PSL, Boulder, Colorado, USA, from their Web site at https://psl.noaa.gov/ #FIXME

NOAA Global Surface Temperature (NOAAGlobalTemp) data provided by the NOAA/OAR/ESRL PSL, Boulder, Colorado, USA, from their Web site at https://psl.noaa.gov/ 



\bibliography{AsymSAM}

\newpage

\appendix

\appendixtitle{Extra figures}



```{r A1, fig.cap = "Lag-correlation between Symmetric and Asymmetric SAM at each level.", fig.width = 4, fig.height=4, appendix = TRUE}
ccf_dt <- function(..., plot = FALSE) {
  stat <- ccf(..., plot = plot)
  list(lag = stat$lag[, 1, 1], 
       acf = stat$acf[, 1, 1])
}

indices_wide %>% 
  .[, ccf_dt(asym, sym, lag.max = 5), by = .(lev)] %>% 
  ggplot(aes(lag, lev)) +
  geom_contour_fill(aes(z = acf), breaks = AnchorBreaks(0, 0.05)) +
  geom_vline(xintercept = 0) +
  scale_fill_divergent(NULL, guide = guide_colorstrip_bottom(), breaks = AnchorBreaks(0, 0.05)) +
  scale_x_continuous("Asym leads Sym\t \t\t Sym leads Asym", breaks = seq(-5, 5, 1), 
                     expand = c(0, 0)) +
  scale_y_level()
```


```{r A2 ccf-levels, fig.cap = "Cross-correlation functions for each index and two differnet base levels."}
ccf_dt <- function(...) {
  a <- ccf(..., plot = FALSE)
  list(acf = as.vector(a$acf),
       lag = as.vector(a$lag))
}



index2 <- copy(indices)
index2[, estimate_700 := estimate[lev == 700], by = .(term, time)]
index2[, estimate_10 := estimate[lev == 10], by = .(term, time)]

rbind("700" = index2[, ccf_dt(x = estimate, y = estimate_700, lag.max = 5), by = .(lev, term)],
      "10" = index2[, ccf_dt(x = estimate, y = estimate_10, lag.max = 5), by = .(lev, term)], 
      idcol = "base_level") %>% 
  ggplot(aes(lag, lev)) +
  geom_contour_fill(aes(z = acf), breaks = AnchorBreaks(0, 0.1, 0)) +
  scale_fill_divergent(NULL, guide = guide_colorstrip_bottom(), 
                       breaks = AnchorBreaks(0, 0.1, 0)) +
  scale_y_level() +
  scale_x_continuous(breaks = seq(-10, 10)) +
  facet_grid(term~base_level, labeller = labeller(base_level = function(x) paste0("Base level: ", x, " hPa"), 
                                                  term = lab_sam)) +
  tag_facets() 
```


```{r compute-spectrums}
indices %>% 
  .[lev %in% c(50, 700)] %>% 
  # .[, estimate_norm := estimate_norm/sd(estimate_norm), by = .(lev, term)] %>% 
  .[, fftspectrum(estimate, c(3, 5), B = 5000, probs = c(0.025, 0.975)), by = .(term, lev)] -> spec
```

```{r A3, fig.cap = "Fourier spectrum of each timeseries. The shading indicates de 95\\% area derived by fitting an AR process to each series and bootstrapping 5000 simulated samples.", appendix = TRUE}
spec %>%
  # .[term != "full"] %>% 
  ggplot(aes(1/freq/12, spec)) +
  geom_ribbon(aes(fill = term, ymin = `2%`, ymax = `98%`), position = "dodge", alpha = 0.1) +
  geom_line(aes(color = term, y = ar_spectrum), alpha = 0.15) +
  geom_line(aes(color = term)) +
  annotation_logticks(sides = "b") +
  scale_color_brewer(NULL, palette = "Dark2", aesthetics = c("color", "fill")) +
  scale_x_log10("Period (years)", sec.axis = sec_axis(~.*12)) +
  facet_grid(lev ~ term,labeller = labeller(lev = lev.lab, term = lab_sam), scales = "free") +
  tag_facets() 
```

```{r A4, fig.cap = "Autocorrelation functions of each timeseries", appendix = TRUE}
acf_dt <- function(...) {
  a <- acf(..., plot = FALSE)
  list(acf = as.vector(a$acf),
       lag = as.vector(a$lag))
}
indices %>% 
  .[lev %in% c(30, 700)] %>% 
  .[, acf_dt(estimate_norm), by = .(lev, term)] %>% 
  ggplot(aes(lag, acf)) +
  geom_col(aes(fill = term)) +
  scale_fill_brewer(palette = "Dark2") +
  facet_grid(term ~ lev,labeller = labeller(lev = lev.lab, term = lab_sam)) +
  tag_facets(position = "tr") 
```




```{r A6, appendix = TRUE, fig.cap = "Regressions maps resulting from performing one multiple regression (column a) and from performing two simple regressions (column b)"}
regr_dif <- hgt[lev %in% 700] %>% 
  indices_wide[., on = .NATURAL, allow.cartesian = TRUE] %>% 
  .[,  rbind(idcol = "regression", multiple = as.data.table(FitLm(hgt_a, sym, asym)),
             single = rbind(as.data.table(FitLm(hgt_a, sym)),
                            as.data.table(FitLm(hgt_a, asym)))),
    by = .(lon, lat)]

regr_dif %>% 
  rm_intercept() %>% 
  periodic(lon = c(0, 360)) %>% 
  .[, term := factor(term, levels = names(lab_sam), ordered = TRUE)] %>% 
  .[lat <= -20] %>% 
  ggplot(aes(lon, lat)) +
  geom_contour_fill(aes(z = estimate), breaks = ZeroBreaks, global.breaks = FALSE) +
  # geom_contour2(aes(z = estimate, linetype = factor(-sign(..level..))), 
  # size = 0.3,
  # global.breaks = FALSE) +
  geom_contour_tanaka(aes(z = estimate),
                      breaks = ZeroBreaks,
                      size = 0.3,
                      global.breaks = FALSE) +
  geom_qmap(~.x[lat <= -20]) +
  # geom_contour2(data = ~.x[dataset == "NCEP"], aes(z = V1)) +
  scale_x_longitude() +
  scale_y_latitude(limits = c(NA, -20), labels = NULL) +
  scale_fill_divergent(NULL, guide = guide_colorstrip_bottom(), 
                       limits = c(-85, 85),
                       oob = scales::squish,
                       breaks = MakeBreaks(binwidth = 20, exclude = 0)) +
  scale_linetype(guide = "none") +
  coord_polar() +
  facet_grid(term ~ regression, labeller = labeller(term = lab_sam, lev = lev.lab)) +
  tag_facets("cr") +
  axis_labs_smol 
```

```{r A7, appendix = TRUE, fig.cap = "Zonal waves derives from the regression maps from performing one multiple regression (column a) and from performing two simple regressions (column b)"}
regr_dif %>% 
  rm_intercept() %>% 
  .[lat < -20] %>%
  # .[lev %in% c(50, 700)] %>% 
  .[, FitWave(estimate, 0:3), by = .(lat, regression, term)] %>% 
  ggplot(aes(lat, amplitude)) +
  geom_line(aes(color = factor(k))) +
  scale_color_brewer("Wave-number", palette = "Dark2") +
  scale_y_continuous("Amplitude") +
  scale_x_latitude(ticks = 15) +
  coord_flip() +
  facet_grid(term~regression, labeller = labeller(term = lab_sam, lev = lev.lab), scales = "free_x") +
  tag_facets("cr", position = "tr")
```


```{r A8, appendix = TRUE, fig.cap = "Pattern cross-correlation \\#FIXME!"}
vertical_regr %>% 
  .[term == "asym"] %>% 
  copy() %>% 
  .[, id := interaction(lev, lon)] %>% 
  widyr::pairwise_cor(index_level, id, estimate) %>% 
  ggplot(aes(item2, item1)) +
  geom_contour_fill(aes(z = correlation), na.fill = .99, breaks = MakeBreaks(binwidth = 0.1)) +
  geom_contour_tanaka(aes(z = correlation), size = 0.1, na.fill = .99, breaks = MakeBreaks(binwidth = 0.1)) +
  geom_text_contour(aes(z = correlation), na.fill = .99, breaks = MakeBreaks(binwidth = 0.1), 
                    color = "white", rotate = FALSE, stroke.color = "black", stroke = 0.2, 
                    skip = 1, size = 4) +
  geom_polygon(data = tri, fill = "white") +
  scale_fill_divergent("Cross-correlation", 
                       breaks = MakeBreaks(binwidth = 0.1),
                       guide = guide_colorstrip_bottom()) +
  scale_x_level(minor_breaks = logbreaks, position = "top") +
  scale_y_level(minor_breaks = logbreaks) +
  coord_equal() +
  theme(panel.spacing.x = unit(2, "lines"), strip.placement = "outside") 
```

