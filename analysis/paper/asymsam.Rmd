---
title: Assessment of zonally symmetric and asymmetric components of the Southern Annular Mode using a novel approach
# subtitle: Do you have a subtitle? If so, write it here
titlerunning:  Assessment of zonally symmetric and asymmetric components of the SAM
# authorrunning: Short form of author list if too long for running head
thanks: | 
  The research was supported by UBACyT20020170100428BA and the CLIMAX Project funded by Belmont Forum/ANR-15-JCL/-0002-01. Elio Campitelli was supported by a PhD grant from CONICET, Argentina.

authors: 
- name: Elio Campitelli
  address: |
    Universidad de Buenos Aires, Facultad de Ciencias Exactas y Naturales, Departamento de Ciencias de la Atmósfera y los Océanos. Buenos Aires, Argentina.  
    CONICET – Universidad de Buenos Aires. Centro de Investigaciones del Mar y la Atmósfera (CIMA). Buenos Aires, Argentina.  
    CNRS – IRD – CONICET – UBA. Instituto Franco-Argentino para el Estudio del Clima y sus Impactos (IRL 3351 IFAECI). Buenos Aires, Argentina.
  email: elio.campitelli@cima.fcen.uba.ar
  
- name:  Leandro B. Díaz
  address: |
    Universidad de Buenos Aires, Facultad de Ciencias Exactas y Naturales, Departamento de Ciencias de la Atmósfera y los Océanos. Buenos Aires, Argentina.  
    CONICET – Universidad de Buenos Aires. Centro de Investigaciones del Mar y la Atmósfera (CIMA). Buenos Aires, Argentina.  
    CNRS – IRD – CONICET – UBA. Instituto Franco-Argentino para el Estudio del Clima y sus Impactos (IRL 3351 IFAECI). Buenos Aires, Argentina.
  
- name:  Carolina Vera
  address: |
    Universidad de Buenos Aires, Facultad de Ciencias Exactas y Naturales, Departamento de Ciencias de la Atmósfera y los Océanos. Buenos Aires, Argentina.  
    CONICET – Universidad de Buenos Aires. Centro de Investigaciones del Mar y la Atmósfera (CIMA). Buenos Aires, Argentina.  
    CNRS – IRD – CONICET – UBA. Instituto Franco-Argentino para el Estudio del Clima y sus Impactos (IRL 3351 IFAECI). Buenos Aires, Argentina.
  
  
keywords:
  - Southern Annular Mode
  - general circulation
  - zonally asymmetric circulation
  - El Niño Southern Oscillation

#PACS: 
#- PAC1
#- superPAC
    
# MSC:
# - MSC code 1
# - MSC code 2

abstract: |
  The Southern Annular Mode (SAM) is the main mode of variability in the Southern Hemisphere extra-tropical circulation and it is so called because of its zonally symmetric ring-like shape. However, the SAM pattern actually contains noticeable deviations from zonal symmetry. Thus, the purpose of this study is to describe the zonally asymmetric and symmetric components of the SAM variability and their impacts. We regress monthly geopotential height fields at each level onto the asymmetric and symmetric component of the SAM to create two new indices: Asymmetric SAM (A-SAM) and Symmetric SAM (S-SAM). In the troposphere, the A-SAM is associated with a zonal wave 3 which is rotated a quarter wavelength with respect to the climatological zonal wave 3, is much stronger in the Pacific ocean, where it extends vertically to the stratosphere with an equivalent barotropic structure. On the other hand, the S-SAM is associated with negative geopotential height anomalies over Antarctica surrounded by a zonally symmetric ring of positive geopotential height anomalies. The observed relationship between the El Niño Southern Oscillation and the SAM is fully explained by the A-SAM index. The positive trend of the SAM is present only in its symmetric component. Despite this, the SAM is becoming more zonally asymmetric. The regional impacts of the SAM in temperature and precipitation are strongly affected by its asymmetric component.

bibliography: 
  - AsymSAM
  - packages
bibstyle: spbasic
# bibstyle options spbasic(default), spphys, spmpsci
output: 
  bookdown::pdf_book: 
      base_format: rticles::springer_article
      latex_engine: "xelatex"
      citation_package: "natbib"
      # pandoc_args: ["--lua-filter=abstract-to-meta.lua"]
header-includes: 
 - \usepackage{gensymb}
 - \usepackage{subfig}
#  - \usepackage[inline]{showlabels}
 - \usepackage{chngcntr}
 - \usepackage{natbib}
 - \usepackage{lineno}
 - \linenumbers 
---

```{r setup, echo = FALSE,warning=FALSE, message = FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  fig.path = "",
  message = FALSE,
  warning = FALSE,
  cache = TRUE,
  cache.extra = 41,
  cache.path = "../cache/",
  collapse = TRUE,
  comment = "#>",
  dev = c("pdf", "png"),
  dpi = 300,
  out.extra = ""
)

# knitr::opts_hooks$set(fig.cap = function(options) {
#   options$cache <- FALSE
#   options
# })

library(metR)
library(data.table)
library(ggplot2)
library(magrittr)
library(ggperiodic)
library(asymsam)
library(latex2exp)
library(tagger)
library(patchwork)
library(knitr)
library(kableExtra)

theme_set(theme_asymsam(base_size = 9) + theme(tagger.panel.tag.text = element_text(size = 8)))

panel_background <- theme(panel.background = element_rect(fill = "#fbfbfb", color = NA), 
                          panel.ontop = FALSE,
                          tagger.panel.tag.background = ggplot2::element_rect(color = NA, 
                                                                              fill = "#fbfbfb"))

ZeroBreaks <- AnchorBreaks(0, NULL, 0)
axis_labs_smol <- theme(axis.text = element_text(size = 6))
lev.lab <- AddSuffix(" hPa")
no_grid <- theme(panel.grid = element_blank()) 

guide_colorstrip_bottom <- function(width = 25, height = 0.5, ...) {
  guide_colorstrip(title.position = "top", title.hjust = 0.5,
                   barheight = height,
                   barwidth = width, ...)
}

guide_colorsteps_bottom <- function(width = 25, height = 0.5, ...) {
  guide_colorsteps(title.position = "top", title.hjust = 0.5,
                   barheight = height,
                   barwidth = width, ...)
}

geom_coords <- function() {
  list(
    geom_segment(data = data.frame(xstart =  seq(0, 360 - 30, by = 30), 
                                   xend =  seq(0, 360 - 30, by = 30),
                                   ystart = -90 + 15,
                                   yend = Inf),
                 aes(x = xstart, xend = xend, y = ystart, yend = yend),
                 size = 0.1, alpha = 0.5),
    
      geom_hline(yintercept = seq(-90, 0, by = 15), size = 0.1, alpha = 0.5),
      shadowtext::geom_shadowtext(data = data.frame(x = 0, y = seq(-90 + 15, 0, by = 15)),
                                  aes(x, y, label = LatLabel(y)), size = 1.5, alpha = 0.7,
                                  colour = "black",
                                  bg.colour = "white" ) 
  )
}

knitr::opts_hooks$set(invisible = function(options) {
  options$include = FALSE
  options
})


main_levs <- c(700, 300, 30, 50)

combine_lists <- function(...) {
  X <- list(...)
  names <- names(X[[1]])
  names(names) <- names
  lapply(names, function(n) {
    unlist(lapply(X, function(x) x[[n]]))
  })
}

report_p <- function(p.value, signs = TRUE) {
  if (signs) {
  ifelse(p.value < 0.001, " < 0.001", paste0(" = ", signif(p.value, 2)))  
  } else {
  ifelse(p.value < 0.001, " < 0.001", paste0(signif(p.value, 2)))    
  }
  
}

lab_sam <-  c(full = "SAM", 
              asym = "A-SAM",
              sym  = "S-SAM")

geom_contour_tanaka2 <- purrr::partial(geom_contour_tanaka, range = c(0.01, 0.3))
```

<!-- The actual document text starts here: -->

<!-- # Abstract -->

<!-- The main mode of variability in the Southern Hemisphere extratropical circulation is the Southern Annular Mode (SAM); so called because of it's zonally symmetric ring-like shape. However, the SAM pattern actually contains noticeable deviations from zonal symmetry. We regress monthly geopotential height fields at each level onto the asymmetric and symmetric component of the SAM to create two new indices. In the troposphere, the Asymmetric SAM, is associated with a zonal wave 3 which is rotated a quarter wavelength with respect to the climatological zonal wave 3, is much stronger in the Pacific ocean, where it extends vertically to the stratosphere with an equivalent barotropic structure. The Symmetric SAM, on the other hand, is associated with a negative geopotential height anomalies over Antarctica surrounded by a zonally symmetric ring of positive geopotential height anomalies. The observed relationship between the El Niño Southern Oscillation and the SAM is explained fully by the Asymmetric SAM index. The positive trend of the SAM is present only in its asymmetric component. Despite this, the SAM is becoming more zonally asymmetric. The regional impacts of the SAM in temperature and precipitation are strongly affected by its asymmetric nature.  -->

# Introduction

The Southern Annular Mode (SAM) is the main mode of variability in the Southern Hemisphere extratropical circulation [@rogers1982] on daily, monthly, and decadal timescales [@baldwin2001a; @fogt2006] and exerts an important influence on temperature and precipitation anomalies, and sea ice concentration [e.g. @fogt2020].
Its positive phase is usually described as anomalously low pressures over Antarctica surrounded by a ring of anomalous high pressures in middle-to-high latitudes.

Most authors describe the SAM as a zonally symmetric pattern, a fact that is reflected not only in its name, but also in the various methods used to characterise it.
Of the several different indices presented in the literature, many of them are based on zonal means of sea level pressure or geopotential height [@ho2012].
@gong1999 defined the SAM index as the zonal mean sea level pressure difference between 40\degree S and 65\degree S, which is also the definition used by the station-based index in @marshall2003.
@baldwin2009 proposed defining the Northern and Annular modes as the leading EOF of the zonally averaged geopotential height at each level.

Even though these indices are based on zonal averages, their associated geopotential height spatial anomalies contain noticeable deviations from zonal symmetry, particularly in the Pacific Ocean region.
The zonal asymmetries have not been widely studied, but previous work suggest that they strongly modulate the regional impacts of the SAM [@fan2007; @silvestri2009; @fogt2012; @rosso2018]. 
The fact that the SAM is not entirely zonally symmetric hinders our ability to reconstruct its historical variability prior to the availability of dense observations in the Southern Hemisphere [@jones2009].

Some of the variability associated with the zonal asymmetries of the SAM seems to be forced by the tropics.
ENSO-like variability affects the Southern Hemisphere extratopics through the Rossby wave trains [@mo1987; @kidson1988; @karoly1989] which project strongly onto the zonal anomalies associated with the SAM in the Pacific sector. 
Moreover, tropical influences on the SAM have been observed [@fan2007; @fogt2011; @clem2013].
@fan2007 computed SAM indices of the Western and the Eastern Hemispheres separately and found that they were much more correlated to each other if the (linear) signal of the ENSO was removed.

Positive trends in the SAM have been documented by various researchers using different indices, mostly on austral Summer and Autumn [e.g. @fogt2020 and references therein].
It is thought that these trends are driven primarily by stratospheric ozone depletion and the increase in greenhouse gases, and understood in the context of zonal mean variables [@marshall2004; @gillett2005; @arblaster2006; @gillett2013].
However, it's not clear yet how or if the asymmetric SAM component responds to these forcings, or how its variability alters the observed trends.

The impact of the zonally asymmetric component of the SAM at regional scales has not been studied in detail yet.
The positive phase of the SAM is associated with colder-than-normal temperatures over Antarctica and warmer-than-normal temperatures at lower latitudes [@jones2019] (and vice versa for negative SAM). 
But there are significant deviations from this zonal mean response, notably in the Antarctic Peninsula and the South Atlantic [@fogt2012]. 
The SAM-related signal on precipitation anomalies behaves similarly, although with even greater deviation from zonal symmetry [@lim2016]. 
The SAM-precipitation relationship in Southeastern South America can be explained by the Pacific-South American (PSA)-like zonally asymmetric circulation associated with the SAM [@silvestri2009; @rosso2018].
@fan2007 also found that precipitation in East Asia was impacted by the variability of only the Western Hemisphere part of the SAM.

The study of the temporal variability of the asymmetric component of the SAM has not received much attention except for @fogt2012.
This study provides evidences for the relevance of the SAM's asymmetric component. 
However, their conclusions are based on composites of positive and negative SAM events including a small number of cases unevenly distributed among years with and without satellite information. 
The latter is particularly important due to the inhomogeneities in reanalysis products prior to the satellite era and the possible change in the asymmetric structure of the SAM [@silvestri2009].
Moreover, @fogt2012 studied the zonal asymmetric component of the SAM only in sea level pressure.
Zonal asymmetries in the SAM spatial pattern are fairly barotropic throughout the troposphere, but they change dramatically in the stratosphere [@baldwin2009].

Our objective is, then, to describe the zonally asymmetric and symmetric components of the SAM variability.
We first propose a methodology that provides for each level, two indices which aim to capture independently the variability of the symmetric and asymmetric SAM component respectively.
Their vertical structure and coherence, temporal variability and trends are consequently assessed.
We then study the spatial patterns described by the variability exclusive to each index focusing on 50 hPa as representing the stratosphere and 700 hPa as representing the troposphere.
Finally, the relationships of the SAM at 700 hPa with temperature and precipitation anomalies are investigated.

In the Section \@ref(methods) we describe the methods.
In Section \@ref(temporal) we describe the temporal variability and vertical coherence of the indices.
In Section \@ref(spatial), we analyse the spatial patterns of geopotential height associated with them.
In Section \@ref(impacts), we study their relationship with surface-level temperature and precipitation.

```{r read-hgt}
hgt <- ReadNetCDF(ERA5(), 
                  subset = list(time = c("1979-01-01", "2018-12-01"),
                                latitude = c(-90, 10),
                                level = as.list(main_levs)),
                  vars = c(hgt = "z")) %>% 
  normalise_coords() %>% 
  .[, hgt := hgt/9.8] %>% 
  .[, hgt_a := hgt - mean(hgt), by = .(lon, lat, lev, month(time))]
```

```{r compute-SAM}
set.seed(43)
SAM <- hgt[lat <= -20] %>% 
  .[lev == 700] %>%
  .[, hgt := hgt_a*sqrt(cos(lat*pi/180))] %>% 
  .[, .(eof = list(EOF(hgt ~ time | lon + lat, n = 1, data = .SD))), 
    by = .(lev)]

# I need to change the sign
SAM$eof[[1]]$left[, hgt := -hgt]
SAM$eof[[1]]$right[, hgt := -hgt]


dims <- hgt[lat <= -20] %>% 
  .[, .(x = uniqueN(lon), y = uniqueN(lat), t = uniqueN(time))]

```

```{r test-aao1}
# test that my SAM have the correct sign.
aao <- rsoi::download_aao(TRUE, data_path("raw", "aao.csv")) %>% 
  as.data.table() %>% 
  .[, .(time = lubridate::as_datetime(Date), aao = AAO)] %>% 
  .[time %between% as.Date(c("1979-01-01", "2018-12-01"))]

cor_aao <- SAM$eof[[1]]$left %>% 
  .[aao, on = .NATURAL] %>% 
  na.omit() %>% 
  .[, cor(hgt, aao)] 

if (sign(cor_aao) != 1) {
  stop("AAO and full index are not positively correlated!")
}
```

# Methods {#methods}

## Data

We used monthly geopotential height at 2.5\degree longitude by 2.5\degree latitude of horizontal resolution and 37 vertical isobaric levels as well as 2 metre temperature from ERA5 [@hersbach2020] for the period 1979 to 2018.
We restrict our analysis to the post-satellite era to avoid any confounding factors arising from the incorporation of satellite observations.

For precipitation data we used monthly data from the CPC Merged Analysis of Precipitation [\@xie1997], with a 2.5\\degree\\ resolution in latitude and longitude.
This rainfall gridded dataset is based on information from different sources such as rain gauge observations, satellite inferred estimations and the NCEP-NCAR reanalysis, and it is available since 1979 to present.

## Definition of indices

Traditionally, the SAM is defined as the leading empirical orthogonal mode (EOF) of sea-level pressure or geopotential height anomalies at low levels [@ho2012].
Following @baldwin2001, we extend that definition vertically and use the term SAM to refer to the leading EOF of the monthly anomalies of geopotential height south of 20\degree S at each level.
We performed EOFs by computing the Singular Value Decomposition of the data matrix consisting in `r dims$t` rows and `r dims$x*dims$y` columns (`r dims$x` points of longitude and `r dims$y` points of latitude).
We weighted the values by the square root of the cosine of latitude to account for the non-equal area of each gridpoint [@chung1999].
We consider in the EOF analysis all months together without dividing by seasons.

To separate the zonally symmetric and asymmetric components of the SAM, we computed the zonal mean and anomalies of the full SAM spatial pattern, as shown in Figure \@ref(fig:method) at 700 hPa.
The full spatial signal ($\mathrm{EOF_1}(\lambda, \phi)$) is the sum of the zonally asymmetric ($\mathrm{EOF_1^*}(\lambda, \phi)$) and symmetric ($[\mathrm{EOF_1}](\lambda, \phi)$) components.
We then compute the SAM index, Asymmetric SAM index (A\nobreakdash-SAM) and Symmetric SAM (S\nobreakdash-SAM) indices as the coefficients of the regression of each monthly geopotential height field on the respective patterns (weighting by the cosine of latitude).
The three indices are then normalized by dividing them by the standard deviation of the SAM index at each level.
As a result, the magnitudes between indices are comparable.
However, only SAM index has unit standard deviation per definition.
The explained variance of each pattern is used as an indicator of the degree of zonally symmetry or asymmetry of each monthly field.
To quantify the coherence between temporal series corresponding to different indices or the same index at different levels, we computed the temporal correlation between them.

```{r method, fig.cap = "Spatial patterns of the first EOF of 700~hPa geopotential height for 1979 -– 2018 period. (a) Full field, (b) zonally asymmetric component and (c) zonally symmetric component. Arbitrary units; positive values in blue and negative values in red.", fig.width=6, fig.height=2.7, fig.env="figure*"}
sam_sep <- SAM[, eof[[1]]$right, by = .(lev)] %>% 
  setnames("hgt", "full") %>% 
  .[, c("sym", "asym") := list(mean(full), Anomaly(full)), by = .(lat, lev)] 


lab_eof <- c(full = TeX("$\\mathrm{EOF_1}(\\lambda, \\phi)$"),
             asym = TeX("$\\mathrm{EOF_1}^*(\\lambda, \\phi)$"), 
             sym  = TeX("$\\[\\mathrm{EOF_1}\\](\\lambda, \\phi)$"))

sam_plot <- sam_sep %>% 
  .[lev %in% c(700)] %>%
  rm_singleton() %>% 
  melt(id.vars = c("lon", "lat")) %>% 
  .[, value := value + rnorm(.N, sd = 1e-6)] %>% 
  .[, variable := factor(variable, levels = names(lab_sam), ordered = TRUE)] 

levels(sam_plot$variable) <- lab_eof



sam_plot %>% 
  periodic(lon = c(0, 360)) %>%
  ggplot(aes(lon, lat)) +
  # geom_contour(aes(z = value, linetype = factor(-sign(..level..))), global.breaks = FALSE) +
  geom_contour_fill(aes(z = value), global.breaks = FALSE, breaks = ZeroBreaks) +
  geom_contour_tanaka2(aes(z = value), global.breaks = FALSE, breaks = ZeroBreaks) +
  geom_qmap() +
  geom_coords() +
  scale_x_longitude(labels = NULL) +
  scale_y_latitude(limits = c(NA, -20), labels = NULL) +
  scale_fill_divergent(guide = "none", high = "#731C1F", low = "#323071") +
  coord_polar() +
  facet_grid(.~variable, labeller = labeller(variable = label_parsed, lev = lev.lab)) +
  axis_labs_smol +
  no_grid +
  tag_facets(position = list(x = 0.15, y = 0.85)) +
  theme(panel.spacing = grid::unit(-1, "lines"))
```

The method assumes linearity in the asymmetric component of the SAM.
That means that zonal asymmetries associated with positive SAM phase (SAM+) are almost opposite in sign and of the same magnitude to the ones associated with negative SAM phase (SAM-).
@fogt2012's composites (their Figure 4) suggest that this might not be entirely valid, although much of that apparent non-linearity could be due to the heterogenous nature of the selected years for constructing the composites.
To test this assumption, we computed seasonal composites of zonal anomalies of geopotential height for SAM+ and SAM- (defined as months in which the SAM index is greater than 1 standard deviation and lower than minus 1 standard deviation, respectively) for the period from 1979 to 2018 at the 700 hPa and 50 hPa levels (Figures \@ref(fig:A3) and \@ref(fig:A4)).
In all seasons and both levels, SAM+ composites are similar to SAM- in structure but with the opposite sign.
Spatial correlations between composites for each season are high.
The method considered in this study seems then a reasonable approximation of the phenomenon.

By performing the EOF analysis using data for all months we are assuming that the zonally asymmetric structure of the SAM is the same at all seasons.
The latter was assessed by computing geopotential height zonal anomalies by projecting the first EOF of each season independently.
The following seasons were considered -- December to February (DJF), March to May (MAM), June to August (JJA) and September to November (SON).
Results are very similar to each other in the troposphere (Figure \@ref(fig:A5), row 2) and show spatial correlations between 0.65 (DJF with JJA) and 0.9 (MAM with SON).
In the stratosphere (Figure \@ref(fig:A5), row 1), patterns are similar for all seasons except DJF, when the wave-1 zonal anomalies are rotated 90\degree in comparison with the rest of the year.
Spatial correlations in the stratosphere are between -0.24 (DJF with SON) and 0.95 (MAM with JJA).
Therefore, the results confirm that the zonal asymmetric structure of the SAM is very similar throughout most of the year.
The outlier being DJF, which shows much lower correlations with the other seasons at both levels and the weakest zonal anomalies (Figure \@ref{fig:A3}), which is consistent with @fogt2020.
Therefore, even though we do our analysis for all months, we would expect for it to represent the other trimesters better. 

The method also assumes that the zonally asymmetric pattern of the SAM remains stationary along the period considered.
@silvestri2009 suggest that this might not be the case between 1958 and 2004.
Zonal asymmetric patterns of SAM were computed for the two halves of the period (1979 to 1998 and 1999 to 2018) respectively.
The differences between the two periods appear to be relatively small in both the troposphere and stratosphere (Figure \@ref(fig:A6)).

## Regressions

We performed linear regressions to quantify the association between the SAM indices and other variables.
Moreover, we apply multiple linear regression analysis to describe the combined influence of both A\nobreakdash-SAM and S\nobreakdash-SAM.
To obtain the linear coefficients of a variable $X$ (geopotential, temperature, precipitation, etc...) with A\nobreakdash-SAM and S\nobreakdash-SAM we fit the equation

$$
X(\lambda, \phi, t) = \alpha(\lambda, \phi) \operatorname{A-SAM} + \beta(\lambda, \phi) \operatorname{S-SAM} + X_0(\lambda, \phi) +  \epsilon(\lambda, \phi, t)
$$

where $\lambda$ and $\phi$ are the longitude and latitude, $t$ is the time, $\alpha$ and $\beta$ are the linear regression coefficients, $X_0$ and $\epsilon$ are the constant and error terms.
From this equation, $\alpha$ represents the (linear) association of $X$ with the variability of A\nobreakdash-SAM that is not explained by the variability of S\nobreakdash-SAM; i.e. it is proportional to the partial correlation of $X$ and A\nobreakdash-SAM, controlling for the effect of S\nobreakdash-SAM, and vice versa for $\beta$.
When performing a separate regression for each trimester (DJF, MAM, JJA, SON), we averaged the relevant variables seasonally for each year and trimester before computing the regression.

Statistical significance for regression fields were evaluated adjusting p-values by controlling for the False Discovery Rate [@benjamini1995; @wilks2016] to avoid misleading results from the high number of regressions [@walker1914; @katz1991].

Linear trends were computed by Ordinary Least Squares and the 95% confidence interval was computed assuming a t-distribution with the appropriate residual degrees of freedom.
To the amplitude of the zonal waves is defined through computing the Fourier transform of the spatial field at each latitude circle.

We computed density probability estimates using a Gaussian kernel of optimal bin width according to @sheather1991.

## Computation procedures

We performed all analysis in this paper using the R programming language [@rcoreteam2020], using the data.table package [@dowle2020] and the metR package [@campitelli2020].
All graphics are made using ggplot2 [@wickham2009]. 
We downloaded data from reanalysis using the ecmwfr package [@hufkens2020] and indices of the ENSO with the rsoi package [@albers2020].
The paper was rendered using knitr and rmarkdown [@xie2015; @allaire2019].

# Results {#results}

## Temporal evolution {#temporal}

```{r compute-asymsam}
indices_file <- data_path("derived", "indices.Rds")
if (file.exists(indices_file)) {
  indices <- readRDS(indices_file)
  indices[, `:=`(estimate = -estimate, 
                 estimate_norm = -estimate_norm)]
} else {
  stop("Run 02-compute-eofs.R")
}

indices_wide <- dcast(indices, + lev + time ~ term, value.var = "estimate_norm")
```

```{r test-aao2}
# test that my indices hace the correct sign. The Full index needs to be **positively** correlated
# with the AAO index.
cor_aao <- indices[term == "full" & lev == 700] %>% 
  .[aao, on = .NATURAL] %>% 
  na.omit() %>% 
  .[, cor(estimate, aao)] 

if (sign(cor_aao) != 1) {
  stop("AAO and full index are not positively correlated!")
}
```

```{r asymsam-timeseries, fig.cap = "Time series for A\\nobreakdash-SAM and S\\nobreakdash-SAM at (a) 50~hPa and (b) 700~hPa. To the right, probability density estimate of each index. Series are standarised by the standard deviation of the SAM at each level.", fig.width=6, fig.height=3, fig.env="figure*"}
indices %>% 
  .[lev %in% c(50, 700) & term != "full"] %>% 
  # .[, estimate_norm := estimate_norm/sd(estimate_norm), by = .(lev, term)] %>% 
  ggplot(aes(time, estimate_norm)) +
  geom_line(aes(color = term)) +
  # ggridges::geom_vridgeline(stat="ydensity", scale = -4e8, fill = NA,
  #                           aes(color = term, width = ..density.., x = min(time - 1e7))) +
  # geom_smooth(aes(color = term), method = "loess", n = 481, span = 10*12/481, method.args = list(degree = 1)) +
  # geom_point(data = ~.x[lev == 50][time == as.Date("1987-11-01") & term == "sym" | 
  #                         time == as.Date("1987-08-01") & term == "asym"]) +
  scale_color_brewer(NULL, palette = "Dark2", labels = lab_sam) +
  scale_y_continuous(NULL, position = "right") +
  scale_x_datetime(NULL, expand = c(0, 0), 
                   date_labels = "%Y", date_minor_breaks = "1 year",
                   breaks = lubridate::as_datetime(seq(as.Date("1980-01-01"), as.Date("2019-01-01"), 
                                                       by = "5 year"))) +
  facet_grid(lev~., labeller = labeller(lev = lev.lab), switch = "y") +
  tag_facets() +
  
  indices %>% 
  .[lev %in% c(50, 700) & term != "full"] %>% 
  ggplot(aes(estimate_norm)) +
  geom_density(aes(color = term), bw = "SJ") +
  facet_grid(lev~., labeller = labeller(lev = lev.lab)) +
  scale_color_brewer(NULL, palette = "Dark2", labels = lab_sam, guide = "none") +
  scale_y_continuous(NULL, labels = NULL, breaks = NULL) +
  scale_x_continuous(NULL, labels = NULL, breaks = 0) +
  coord_flip()  +
  theme(strip.text = element_blank()) +
  plot_layout(widths = c(4, 1)) 
```

We first asses the temporal evolution of A\nobreakdash-SAM and S\nobreakdash-SAM.
Figure \@ref(fig:asymsam-timeseries) shows the corresponding time series for 700 hPa and 50 hPa and their corresponding density estimates.
We selected these two levels as representative of the tropospheric and stratospheric variability respectively.
As it is shown below, the variabilities of both indices are highly coherent within each atmospheric layer, therefore is reasonable to take one level as representative of each layer.

Month-to-month variability is evident for both indices, with noisy variations in the low frequencies.
At first glance the series can be distinguished by their distributions.
Compared to the tropospheric indices, the stratospheric indices are much more long-tailed; that is, extreme values (both negative and positive) abound.
The A\nobreakdash-SAM series have both more variability in the higher frequencies than the S\nobreakdash-SAM series.

```{r compute-spectrums}
spec <- indices %>% 
  .[lev %in% c(50, 700)] %>% 
  # .[, estimate_norm := estimate_norm/sd(estimate_norm), by = .(lev, term)] %>% 
  .[, fftspectrum(estimate, c(3, 5), B = 5000, probs = c(0, 0.95)), by = .(term, lev)]
```

```{r spectrum-max}
max_period <- spec[lev == 50 & term == "sym"] %>% 
  .[which.max(spec - `95%`)] %>% 
  .[, 1/freq]
```

The stratospheric S\nobreakdash-SAM varies strongly with a period between 15 and 30 months (the maximum spectrum is located at `r round(max_period)` months), which can be seen by spectral analysis (Figure \@ref(fig:A2)). A local peak at a similar frequency range is discernible in the periodogram of the tropospheric S\nobreakdash-SAM, although it's not statistically significant. This period band is around the range of periodicity of the Quasi-Biennial Oscillation [@baldwin2001b] and is consistent with [@vasconcellos2020], who found that the SAM and the QBO share significant common high power around the 2-year band.
The fact that this periodicity is not evident on the A\nobreakdash-SAM index, is also consistent with their composites of geopotential height anomalies during easterly and westerly QBO, which show a rather symmetric monopole over Antarctica.
In the troposphere the most significant peak of variability is found in A\nobreakdash-SAM at around `r 12*.3` months.

```{r compute-cors}
ccf_dt <- function(..., plot = FALSE) {
  stat <- ccf(..., plot = plot)
  list(lag = stat$lag[, 1, 1], 
       acf = stat$acf[, 1, 1])
}

cors <- indices_wide %>% 
  .[, ccf_dt(asym, sym, lag.max = 5), by = .(lev)]
```

From a visual inspection, the A\nobreakdash-SAM and S\nobreakdash-SAM time series appear to be correlated.
Moreover, looking at the extremes in the stratosphere, the S\nobreakdash-SAM series appears to lag the A\nobreakdash-SAM series (see, for example, the positive events on late 1987).
Figure \@ref(fig:cor-lev) shows these correlations along all levels considered, for zero and -1 lags.
Values of zero-lag correlations between A\nobreakdash-SAM and S\nobreakdash-SAM are relatively constant throughout the troposphere, fluctuating between `r signif(cors[lag == 0 & lev >= 100, min(acf)], 2)` and `r signif(cors[lag == 0 & lev >= 100, max(acf)], 2)`.
One-month-lag correlations are similarly constant but significantly reduced to around `r signif(cors[lag == -1 &lev > 500][, mean(acf)], 2)`.
In the stratosphere, zero-lag correlations drop to a minimum of `r signif(cors[lag == 0 & lev < 100][which.min(acf)]$acf, 2)` at `r cors[lag == 0 & lev < 100][which.min(acf)]$lev` hPa and then increase again monotonically with height up to the uppermost level of the reanalysis (although results near the top of the models are to be interpreted with care).
At the same time, one-month-lag correlations increase with height.
Therefore, stratospheric A\nobreakdash-SAM index tends to precede the S\nobreakdash-SAM index.
(Correlations at lags -5 to 5 are shown in Figure \@ref(fig:A1).)

```{r cor-lev, fig.cap = "Correlation between S\\nobreakdash-SAM and A\\nobreakdash-SAM at each level for lag zero and lag -1 (A\\nobreakdash-SAM leads S\\nobreakdash-SAM) for the 1979 -- 2018 period.", fig.width=3, fig.height=3}
cors %>% 
  .[lag %in% c(0, -1)] %>% 
  ggplot(aes(lev, acf)) +
  geom_line(aes(color = factor(lag, levels = c(0, -1), ordered = TRUE),
                linetype = factor(lag, levels = c(0, -1), ordered = TRUE))) +
  scale_x_level() +
  scale_y_continuous("Correlation", limits = c(0, 1)) + 
  scale_linetype_manual(NULL, values = c(1, 5), 
                        labels = c("0" = "Zero-lag", 
                                   "-1" = "A-SAM leads\nS-SAM by 1 month")) +
  scale_color_brewer(NULL, palette = "Dark2", 
                     labels = c("0" = "Zero-lag",
                                "-1" = "A-SAM leads\nS-SAM by 1 month")) +
  coord_flip()
```

```{r cross-correlation, fig.cap = "Cross correlation between levels for the (a) SAM, (b) A\\nobreakdash-SAM, and (c) S\\nobreakdash-SAM for the 1979 -- 2018 period.", fig.width = 6, fig.height=3, fig.env="figure*"}
tri <- matrix(c(1000, 1000, 1000, 1, 1, 1, 1000, 1000), ncol = 2, byrow = TRUE) %>% 
  as.data.table() %>% 
  setnames(., colnames(.), c("item1", "item2"))

logbreaks <- function(range) {
  ticks <- ggplot2:::calc_logticks(minpow = log10(min(range)), maxpow = log10(max(range)))
  ticks$value[ticks$end == 0.2]
}

N <- indices %>% 
  .[, .N, by = .(lev, term)] %>% 
  .[, unique(N)]

crosscor <- indices %>% 
  copy() %>% 
  .[, widyr::pairwise_cor(.SD, lev, time, estimate, diag = TRUE), by = .(term)] 

crosscor %>% 
  .[, p.value := 2*pnorm(atanh(correlation), 0, sd = 1/sqrt(N), lower.tail = FALSE)] %>% 
  .[, p.value := p.adjust(p.value, method = "bonferroni")]

crosscor %>% 
  ggplot(aes(item2, item1)) +
  geom_contour_fill(aes(z = correlation, fill = ..level..), breaks = MakeBreaks(binwidth = 0.1)) +
  geom_contour_tanaka2(aes(z = correlation), size = 0.1, na.fill = .99, 
                      breaks = MakeBreaks(binwidth = 0.1)) +
  geom_text_contour(aes(z = correlation), breaks = MakeBreaks(binwidth = 0.1), 
                    color = "white", rotate = FALSE, stroke.color = "black", stroke = 0.2, 
                    skip = 1, size = 2, 
                    data = ~.x[item2 > item1]) +
  geom_polygon(data = tri, fill = "white") +
  scale_fill_divergent_discretised("Cross-correlation",
                                   guide = guide_colorstrip_bottom()) +
  scale_x_level(minor_breaks = logbreaks, position = "top") +
  scale_y_level(minor_breaks = logbreaks) +
  coord_equal() +
  facet_grid(. ~ term, labeller = labeller(term = lab_sam)) +
  theme(panel.spacing.x = unit(2, "lines"), strip.placement = "outside") +
  tag_facets(position = "br")
```

Figure \@ref(fig:cross-correlation) shows (zero-lag) cross-correlation across levels for the SAM, A\nobreakdash-SAM and S\nobreakdash-SAM indices.
For the SAM (Figure \@ref(fig:cross-correlation)a), high values below 100 hPa reflect the vertical (zero-lag) coherency throughout the troposphere.
Above 100 hPa, correlation between levels falls off more rapidly, indicating less coherent (zero-lag) variability.
But correlations between tropospheric and lower-to-middle stratospheric levels are still relatively high (e.g. greater than 0.4 between tropospheric levels and levels below 30 hPa).
A\nobreakdash-SAM and S\nobreakdash-SAM (Figure \@ref(fig:cross-correlation)b and c, respectively) share similar high level of coherency in the troposphere but they differ in their stratospheric behaviour.
Stratospheric coherency is stronger for the A\nobreakdash-SAM than the S\nobreakdash-SAM.
The stratospheric S\nobreakdash-SAM seems to connect more strongly to the troposphere than the stratospheric A\nobreakdash-SAM.

```{r trends, fig.cap = "Linear trends (in standard deviations per decade) at each level for annual (row 1) and seasonal values (rows 2 to 5) for the period 1979 -- 2018 and for the (column a) SAM index, (column b) A\\nobreakdash-SAM index, and (column c) S\\nobreakdash-SAM index. Shading indicates the 95\\% confidence interval from a t-distribution.", fig.width = 6, fig.height=4, fig.env="figure*", cache = FALSE}
indices %>% 
  copy() %>% 
  .[, lapply(.SD, mean), by = .(lev, PC, term, time = seasonally(time))] %>% 
  .[, season := season(time)] %>% 
  rbind(., copy(indices)[, season := "Annual"]) %>% 
  .[, estimate_norm := estimate_norm/sd(estimate_norm), by = .(lev, term)] %>%
  .[, FitLm(estimate_norm, time = time, se = TRUE), by = .(type = term, lev, season)] %>% 
  rm_intercept() %>% 
  .[, term := NULL] %>%  
  .[, estimate := estimate*3600*24*365*10] %>% 
  .[, std.error := std.error*3600*24*365*10] %>% 
  .[, pval := Pvaluate(estimate, std.error, df, "fdr")] %>% 
  setnames("type", "term") %>% 
  .[, season := forcats::fct_relevel(season, "Annual")] %>% 
  .[, t := qt(.975, df)] %>% 
  ggplot(aes(lev, estimate)) +
  geom_hline(yintercept = 0) +
  geom_ribbon(aes(ymax = estimate + std.error*t, ymin = estimate - std.error*t), 
              fill = "#95a3ab", color = "black", 
              alpha = .6, size = 0.1) +
  geom_line() +
  # stat_subset(aes(subset = pval <= 0.05), shape = 4, size = 2) +
  scale_fill_brewer(palette = "Dark2", aesthetics = c("color", "fill")) +
  scale_x_level() +
  scale_y_continuous("Standard deviations per decade") +
  coord_flip() +
  facet_grid(season ~ term,labeller = labeller(term = lab_sam)) +
  tag_facets("cr") 
```


The linear trends for each of the indices (SAM, S\nobreakdash-SAM and A\nobreakdash-SAM) were evaluated for the complete period 1979 -- 2018 at each level for the whole year and separated by trimesters (Figure \@ref(fig:trends)).
The SAM index presents a statistically positive significant trend (Figure \@ref(fig:trends)`r get_tag(term == "full" & season == "Annual")`) that extends throughout the troposphere up to about 50 hPa and reaches its maximum value at 100 hPa.
The seasonal trends (rest of Figure \@ref(fig:trends) column a) indicate that positive trends are present in Autumn and particularly in Summer, where the 100 hPa maximum is much more defined.
In Winter and Spring, we detect no statistically significant trend.
This is consistent with the results of previous studies, which find large positive trends in Summer, smaller in Autumn and no trends in the other seasons [e.g. @fogt2020 and references therein] using indices of the SAM based on surface or near-surface circulation.

By separating the SAM signal in its asymmetric and symmetric parts, not only we can see that these trends are almost entirely due to the symmetric component (column b vs. column c in Figure \@ref(fig:trends)), but in some cases the trends become clearer.
In Summer, A\nobreakdash-SAM has a statistically non significant negative trend in the middle troposphere that obscures the trend in the SAM index; as a result, trends computed using only the Symmetric component are stronger (compare the shading region in Figure \@ref(fig:trends)`r get_tag(term == "full" & season == "DJF")` and `r get_tag(term == "sym" & season == "DJF")`).
In Autumn, the S\nobreakdash-SAM index reveals a statistically significant positive trend in the stratosphere that is not significant using the SAM index.

A positive trend in the S\nobreakdash-SAM index and no trend in the A\nobreakdash-SAM index might at first suggest a trend towards a more symmetric SAM. 
However, a very negative S\nobreakdash-SAM trending towards a less negative S\nobreakdash-SAM would be translated into a positive S\nobreakdash-SAM trend but a more asymmetric SAM. 

```{r r-squared-trend, fig.height=4, fig.width=4, fig.cap = "Linear trends (in percent per decade) of the variance explained by A\\nobreakdash-SAM and S\\nobreakdash-SAM at each level and for each trimester for the period 1979 -- 2018. Shading indicates the 95\\% confidence interval."}
indices %>% 
  .[term != "full"] %>% 
  .[, FitLm(r.squared, time, se = TRUE), by = .(lev, type = term, season(time))] %>% 
  rm_intercept() %>%
  .[, estimate := estimate*3600*24*365*10] %>% 
  .[, std.error := std.error*3600*24*365*10] %>% 
  ggplot(aes(lev, estimate)) +
  geom_hline(yintercept = 0) +
  geom_ribbon(aes(fill = type, color = type, 
                  ymin = estimate - 1.96*std.error, ymax = estimate + 1.96*std.error), 
              size = 0.2, alpha = 0.2) +
  geom_line(aes(color = type)) +
  scale_x_level() +
  scale_y_continuous("Change in explained variance per decade", 
                     label = scales::percent_format(1)) +
  scale_fill_brewer(NULL, palette = "Dark2", aesthetics = c("color", "fill"), labels = lab_sam) +
  coord_flip() +
  facet_wrap(~season)
```
To study the question of whether the SAM is becoming more or less asymmetric, we show trends for the  explained variance of each index for each trimester in Figure \@ref(fig:r-squared-trend). 
In the troposphere the only significant trend is in DJF, in which the A\nobreakdash-SAM has a positive trend of about 2% per decade, suggesting, that the DJF SAM has become more asymmetric in the period from 1979 to 2018, 
However due to the atypical nature of the asymmetric component of the SAM during DJF (Section\ \ref(definition-of-indices)) this should be taken only as preliminary evidence. 
The other significant trends is in the stratosphere during SON, where there is a positive trend in the variance explained by the S\nobreakdash-SAM of about 4% per decade. 
This change could be the result of the forcing from ozone depletion.

## Spatial patterns {#spatial}

```{r compute-regr-pattern}
indices_2d_yearly <- hgt[lev %in% c(main_levs)] %>% 
  indices_wide[., on = .NATURAL, allow.cartesian = TRUE] %>% 
  .[, combine_lists(FitLm(hgt_a, sym, asym, se = TRUE),
                    FitLm(hgt_a, full, se = TRUE)),
    by = .(lon, lat, lev)] %>% 
  rm_intercept() %>% 
  .[, p.val := Pvaluate(estimate, std.error, df, "fdr"), by = .(term, lev)] %>% 
  periodic(lon = c(0, 360)) %>% 
  .[, term := factor(term, levels = names(lab_sam), ordered = TRUE)] %>% 
  .[, season := "Annual"]
```

```{r 2d-regr, fig.cap = "Regression of geopotential height (meters) at (row 1) 50~hPa and (row 2) 700~hPa with (column a) SAM, (column b) A\\nobreakdash-SAM, and (column c) S\\nobreakdash-SAM for the 1979 -- 2018 period. The regression patterns for A\\nobreakdash-SAM and S\\nobreakdash-SAM are the result of one multiple regression using both indices. Points marked on panel b.2 are the location of the reference points used by \\cite{raphael2004} for their Zonal Wave 3 index. ", fig.env = "figure*", fig.width=6, fig.height=5}
indices_2d_yearly %>% 
  .[lat <= -20] %>% 
  .[lev %in% c(50, 700)] %>%
  .[, term := factor(term, levels = c("full", "asym", "sym"))] %>% 
  ggplot(aes(lon, lat)) +
  geom_contour_fill(aes(z = estimate), breaks = AnchorBreaks(0, exclude =  0),
                    global.breaks = FALSE) +
  geom_contour_tanaka2(aes(z = estimate),
                      breaks = AnchorBreaks(0, exclude =  0),
                      size = 0.3,
                      global.breaks = FALSE) +
  # geom_contour2(aes(z = env)) +
  geom_qmap(~.x[lat <= -20]) +
  geom_coords() +
  geom_point(data = data.frame(lon = ConvertLongitude(c(50, 166, -76)),
                               lat = -49, term = factor("asym", 
                                                        levels = c("full", "asym", "sym")),
                               lev = 700),
             shape = 21, size = 2.5, color = "black", fill = "#de3e80") +
  scale_x_longitude(labels = NULL) +
  scale_y_latitude(limits = c(NA, -20), labels = NULL) +
  scale_fill_divergent(NULL, guide = guide_colorstrip_bottom(), 
                       limits = c(-45, 45),
                       oob = scales::squish,
                       breaks = AnchorBreaks(0, 10, 0)) +
  scale_linetype(guide = "none") +
  coord_polar() +
  facet_grid(lev ~ term, labeller = labeller(lev = lev.lab, term = lab_sam)) +
  tag_facets("cr", position = list(x = 0.15, y = 0.85)) +
  no_grid +
  theme(panel.spacing = grid::unit(-1, "lines"))
```

We then computed the spatial regression of geopotential height anomalies on the A\nobreakdash-SAM and S\nobreakdash-SAM indices at 700 hPa and 50 hPa levels (Figure \@ref(fig:2d-regr)).
While regression coefficients in Figure \@ref(fig:2d-regr) column a are computed using SAM, the regression coefficients in columns b and c of Figure \@ref(fig:2d-regr) are computed using multiple regression using the A\nobreakdash-SAM and S\nobreakdash-SAM indices at the same time.
Thus, they are to be interpreted as the patterns associated with each index, removing the variability (linearly) explained by the other one.

In the stratosphere, the spatial pattern associated with the SAM is clearly dominated by a zonally symmetric, monopolar structure (Figure \@ref(fig:2d-regr)a.1) which is not centred in the South Pole.
On the other hand, the monopole associated with S\nobreakdash-SAM (Figure \@ref(fig:2d-regr)c.1) is more symmetric, although still is not perfectly centred in the South Pole. 
Furthermore, the regression pattern of A\nobreakdash-SAM is characterized by a wave-1 structure with centres over the Drake Passage in the Western Hemisphere and Davis Sea in the Eastern Hemisphere

```{r compute-raphael}
# 50°E, 166°E and 76°W. 
raphael <- ReadNetCDF(ERA5(), 
                      subset = list(time = c("1979-01-01", "2019-01-01"),
                                    latitude = -49,
                                    level = 500),
                      vars = c(hgt = "z")) %>% 
  normalise_coords() %>% 
  .[, hgt := hgt/9.8] %>% 
  .[, hgt := Anomaly(hgt), by = .(lat, time)] %>% 
  .[lon %~% ConvertLongitude(c(50, 166, -76))] %>% 
  .[, hgt_s := frollmean(hgt, 3, NA, align = "center"), by = .(lon, lat)] %>% 
  na.omit() %>% 
  .[, hgt_s := scale(hgt_s), by = .(lon, lat, month(time))] %>% 
  .[, .(raphael = mean(hgt_s)), by = time]

cor_raphael <- raphael[indices_wide[lev == 500], on = "time"] %>% 
  na.omit() %>% 
  .[, cor.test(asym, raphael)]
```

In the troposphere, the regression pattern associated with the SAM shows the well-known combination of zonally symmetrical annular mode with zonal asymmetries in the form of a wave-3 (Figure \@ref(fig:2d-regr)a.2, [@fogt2012]).
The regression patterns associated with the A\nobreakdash-SAM and S\nobreakdash-SAM indices successfully disentangle both structures. 
(Note that, in light of previous discussion about the atypical nature of DJF, this year-round average effect  will likely not represent DJF perfectly).
While the A\nobreakdash-SAM index gives rise to a cleaner zonal wave (Figure \@ref(fig:2d-regr)b.2), the S\nobreakdash-SAM index is associated with an annular structure, with only vestigial zonal asymmetries (Figure \@ref(fig:2d-regr)c.2) in the shape of a wave-3 which is the inverse of the A\nobreakdash-SAM wave-3.
The wave-3 pattern observed in Figure \@ref(fig:2d-regr)b.2 is rotated by half a wavelength from the average position of the mean wave-3 pattern described by @raphael2004, whose reference locations are marked with points in the figure.
Indeed, there is no correlation between @raphael2004's index and A\nobreakdash-SAM (cor = `r signif(cor_raphael$estimate, 2)`, p-value `r report_p(cor_raphael$p.value)`).
Thus, the tropospheric A\nobreakdash-SAM index represents a zonal displacement in the position of the climatological wave-3 pattern.

(ref:wave-amplitude-caption) Amplitude (meters) of zonal waves of the geopotential height regression patterns in Figure \@ref(fig:2d-regr) for zonal waves with wavenumber 0, 1, 2, and 3, where wavenumber 0 represents the amplitude of the zonal mean.

```{r wave-amplitude, fig.cap = "(ref:wave-amplitude-caption)", fig.width=4, fig.height=3, fig.env = "figure*", cache = FALSE}
indices_2d_yearly %>% 
  .[lat < -20] %>%
  .[lev %in% c(50, 700)] %>% 
  .[, FitWave(estimate, 0:3), by = .(lat, lev, term)] %>% 
  ggplot(aes(lat, amplitude)) +
  geom_line(aes(color = factor(k)), size = 1) +
  scale_color_brewer("Wavenumber", palette = "Set1") +
  scale_y_continuous("Amplitude") +
  scale_x_latitude(ticks = 20) +
  coord_flip() +
  facet_grid(lev~term, labeller = labeller(term = lab_sam, lev = lev.lab)) +
  tag_facets("cr", position = "tr") 
```

The amplitude of the first zonal wavenumbers at each latitude at 50 hPa and 700 hPa are shown in Figure \@ref(fig:wave-amplitude), where wavenumber zero represents the amplitude of the zonal mean.
Zonal wave amplitudes of the spatial pattern described by the SAM index (Figure \@ref(fig:wave-amplitude) column `r get_col(term == "full")`) are dominated by the zonal mean (wavenumber 0) at both levels.
However, zonal waves are important, particularly South of 50\degree S, with wavenumber 1 clearly dominating at 50 hPa (Figure \@ref(fig:wave-amplitude)`r get_tag(term == "full" & lev == 50)`) and a mix of waves of similar amplitude at 700 hPa (Figure \@ref(fig:wave-amplitude)`r get_tag(term == "full" & lev == 700)`).
Figure \@ref(fig:wave-amplitude) column `r get_col(term == "asym")` shows that the A\nobreakdash-SAM is overwhelmingly dominated by wave 1 in the stratosphere (Figure \@ref(fig:wave-amplitude)`r get_tag(term== "asym" & lev == 50)`), while in the troposphere it is explained by a combination of zonal waves 3 to 1 in decreasing level of importance (Figure \@ref(fig:wave-amplitude)`r get_tag(term== "asym" & lev == 700)`) with negligible amplitude of the zonal mean.
On the other hand, the S\nobreakdash-SAM it is almost entirely explained by the zonal mean at both levels (Figure \@ref(fig:wave-amplitude) column c), with little to no contribution from zonal waves with wavenumbers 1 to 3.

```{r compute-vertical-regression}
# vertical_regr <- ReadNetCDF(ERA5(), 
#            subset = list(time = c("1979-01-01", "2018-12-31"),
#                          latitude = c(-65, -40)),
#            vars = c(hgt = "z")) %>% 
#   normalise_coords() %>% 
#   .[, .(hgt = weighted.mean(hgt, w = cos(lat*pi/180))), by = .(lon, lev, time)] %>% 
#   .[, hgt := hgt/9.8] %>% 
#   .[, hgt_a := hgt - mean(hgt), by = .(lon, lev, month(time))] %>% 
#   indices_wide[., on = .NATURAL, allow.cartesian = TRUE] %>% 
#   .[, FitLm(hgt_a, sym, asym, se = TRUE),
#     by = .(lon, lev)] %>% 
#   rm_intercept() %>% 
#   .[, p.val := Pvaluate(estimate, std.error, df, "fdr"), by = .(term, lev)] %>% 
#   periodic(lon = c(0, 360)) %>% 
#   .[, term := factor(term, levels = names(lab_sam), ordered = TRUE)] 

indices_wide %>% 
  copy() %>% 
  setnames("lev", "index_level") -> indices_for_regr

vertical_regr <- ReadNetCDF(ERA5(), 
                            subset = list(time = c("1979-01-01", "2018-12-31"),
                                          latitude = c(-65, -40)),
                            vars = c(hgt = "z")) %>% 
  normalise_coords() %>% 
  .[, .(hgt = weighted.mean(hgt, w = cos(lat*pi/180))), by = .(lon, lev, time)] %>% 
  .[, hgt := hgt/9.8] %>% 
  .[, hgt_a := hgt - mean(hgt), by = .(lon, lev, month(time))] %>% 
  indices_for_regr[., on = .NATURAL, allow.cartesian = TRUE] %>% 
  .[, FitLm(hgt_a, asym, sym, se = TRUE),
    by = .(lon, lev, index_level)] %>% 
  rm_intercept() %>% 
  .[, p.val := Pvaluate(estimate, std.error, df, "fdr"), by = .(term, index_level, lev)] %>% 
  periodic(lon = c(0, 360)) %>% 
  .[, term := factor(term, levels = names(lab_sam), ordered = TRUE)] 
```

```{r vertical-regression, fig.cap = "Regression between monthly geopotential height anomalies (meters) averaged betweeen 65\\degree and 40\\degree S and the A\\nobreakdash-SAM index (extracted from a multiple regression which included the S\\nobreakdash-SAM index). (a) With the A\\nobreakdash-SAM in 50~hPa and (b) in 700~hPa for the 1979 -- 2018 period.", fig.width = 4, fig.height=3}
vertical_regr %>% 
  .[index_level %in% c(50, 700)] %>% 
  .[term == "asym"] %>%
  ggplot(aes(lon, lev)) +
  geom_contour_fill(aes(z = estimate, fill = ..level..), breaks = AnchorBreaks(0, 10, 0)) +
  geom_contour_tanaka2(aes(z = estimate),
                      breaks = AnchorBreaks(0, 10, 0),
                      size = 0.3,
                      global.breaks = FALSE) +
  # geom_contour2(aes(z = p.val), breaks = 0.01) +
  scale_fill_divergent_discretised(NULL, guide = guide_colorstrip_bottom(13)) +
  # oob = scales::squish,
  scale_y_level() +
  scale_x_longitude(ticks = 60)  +
  facet_grid(index_level~., labeller = labeller(index_level = lev.lab)) +
  tag_facets(position = "bl") 
```

To analyse the vertical structure of the geopotential height anomalies associated with the A\nobreakdash-SAM index, we show a vertical cross section of regressions of mean geopotential height between 65\degree S and 40\degree S for the 50 hPa A\nobreakdash-SAM index (Figure \@ref(fig:vertical-regression)a) and for the 700 hPa A\nobreakdash-SAM index (Figure \@ref(fig:vertical-regression)b).
The geopotential height anomalies associated with the stratospheric A\nobreakdash-SAM (Figure \@ref(fig:vertical-regression)a) are clearly constrained to the stratosphere, which underscores the uncoupling between the stratospheric and tropospheric A\nobreakdash-SAM.
The vertical structure of this signal tilts about 60\degree to the West between 100 hPa and 1 hPa, suggesting baroclinic processes.
The signal in the stratosphere maximises near 10 hPa despite using the 50 hPa index for the regression.

The tropospheric A\nobreakdash-SAM (Figure \@ref(fig:vertical-regression)b) has significant signals that extend upwards to the uppermost levels considered.
In the troposphere, the wave-3 structure is equivalent barotropic with maximum amplitude at roughly 250 hPa.
The anomalies are larger in the Western hemisphere, where they extend into the stratosphere.
In the Eastern hemisphere the wave-3 signal is smaller and confined to the troposphere while negative anomalies dominate in the stratosphere.
So, while the tropospheric A\nobreakdash-SAM index is associated with stratospheric geopotential anomalies, these do not project strongly onto the stratospheric A\nobreakdash-SAM.
The structures shown in Figure \@ref(fig:vertical-regression) are robust to the choice of index level.
For any stratospheric (above 100 hPa) index, the resulting anomalies are very similar to the wave-1 structure with maximum near 10 hPa in Figure \@ref(fig:vertical-regression)a.
Conversely, for any tropospheric (below 100 hPa) index, the result is very similar to Figure \@ref(fig:vertical-regression)b.
The patterns mainly change in amplitude (not shown).

```{r enso-cor}
oni <- rsoi::download_oni(TRUE, data_path("raw", "oni.csv")) %>% 
  as.data.table() %>% 
  .[, .(time = lubridate::as_datetime(Date), value = ONI)]

mei <- rsoi::download_mei(TRUE, data_path("raw", "mei.csv")) %>% 
  as.data.table() %>% 
  .[, .(time = lubridate::as_datetime(Date), value = MEI)] 


soi <- rsoi::download_soi(TRUE, data_path("raw", "soi.csv")) %>% 
  as.data.table() %>% 
  .[, .(time = lubridate::as_datetime(Date), value = -SOI)] 

enso <- rbindlist(list(oni = oni, soi = soi, mei = mei), idcol = "index")


enso_sam_cor <- enso %>% 
  .[indices, on = "time", allow.cartesian = TRUE] %>% 
  .[lev == 700] %>% 
  .[, with(cor.test(estimate, value), 
           list(cor = estimate, 
                p.value = p.value)), by = .(lev, term, index)] %>% 
  .[, type := "Correlation"] %>% 
  .[, season := "Year"] %>% 
  .[, lev := NULL]

enso_sam_cor_season <- enso %>% 
  .[indices, on = "time", allow.cartesian = TRUE] %>% 
  .[lev == 700] %>% 
  .[, with(cor.test(estimate, value), 
           list(cor = estimate, 
                p.value = p.value)), by = .(lev, term, season(time), index)] %>% 
  .[, type := "Correlation"] %>% 
  .[, lev := NULL]


enso_sam_partial <- enso %>% 
  .[indices_wide[lev == 700], on = "time"] %>% 
  .[, partial_cor(value, asym, sym), by = .(index)] %>% 
  setnames("partial_correlation", "cor") %>% 
  .[, type := "Partial Correlation"] %>% 
  .[, season := "Year"] 


enso_sam_partial_season <- enso %>% 
  .[indices_wide[lev == 700], on = "time"] %>% 
  .[, partial_cor(value, asym, sym), by = .(season(time), index)] %>% 
  setnames("partial_correlation", "cor") %>% 
  .[, type := "Partial Correlation"] 


enso_cors <- rbind(enso_sam_cor, 
      enso_sam_cor_season, 
      enso_sam_partial,
      enso_sam_partial_season, use.names = TRUE) %>% 
  .[type == "Partial Correlation" | term == "full"]

cor_texts <- enso_cors[index == "oni"] %>% 
  .[, p.value := p.adjust(p.value, "fdr")] %>% 
  .[, cor := round(cor, 2)] %>% 
  .[, p.value := report_p(p.value)] 
```

```{r enso-cor-table}
table <- enso_cors %>% 
  .[index == "oni"] %>% 
  .[, p.value := p.adjust(p.value, "fdr")] %>% 
  .[, p.value := paste0("(", scales::pvalue(p.value), ")")] %>% 
  .[, cor_text := scales::number(cor, 0.01)] %>% 
  .[, term := lab_sam[term]] %>% 
  .[] %>% 
  melt(id.vars = c("term", "index", "season" ), measure.vars = c("cor_text", "p.value")) %>% 
  dcast(season + variable ~ term, value.var = "value") %>% 
  .[, variable := NULL] %>% 
  setcolorder(c("season", lab_sam))


table2 <- enso_cors %>% 
  .[index == "oni"] %>% 
  .[, p.value := p.adjust(p.value, "fdr")] %>% 

  .[, term := lab_sam[term]] %>% 
  dcast(season ~ term, value.var = "p.value") %>% 
  setcolorder(c("season",lab_sam))


table %>% 
  kbl(align = "c", 
      caption = "Correlation between SAM indices and the Oceanic Niño Index. p-values corrected for False Detection Rate in parenthesis. In bold, correlations with p-value smaller than 0.05.", 
      col.names = c("", lab_sam), booktabs = TRUE) %>%
  kable_classic(full_width = F) %>%
  column_spec(2, bold = rep(table2[, 2] < 0.05, each = 2)) %>%
  column_spec(3, bold = rep(table2[, 3] < 0.05, each = 2)) %>%
  column_spec(4, bold = rep(table2[, 4] < 0.05, each = 2)) %>%
  collapse_rows(columns = 1:2, valign = "top") %>% 
  add_header_above(c(" " = 1, "Correlation" = 1, 
                     "Partial correlation" = 2)) 
```

The wave-3 pattern from Figure\ \@ref(fig:2d-regr)b.2 is very similar to the PSA Pattern [@mo1987; @kidson1988] which is a teleconnection pattern associated with the ENSO [@karoly1989].
Indeed, @fogt2011 showed that there is a significant relationship between the SAM and the ENSO. 
The correlation between the SAM and the ENSO as measured by the Oceanic Niño Index [ONI, @bamston1997] is shown in Table\ \@ref{tab:enso-cor-table} for each SAM index and for each trimester. 
There is a significant correlation between SAM and ENSO. 
When divided in trimesters, this correlation is important only in DJF and SON. 
This relationship is captured mainly by the A\nobreakdash-SAM, as this index has signifcant partial correlations with ENSO while correlations with S\nobreakdash-SAM are all smaller and non-significant. 
In MAM, ENSO is not significantly correlated with SAM, but it is significantly correlated with A\nobreakdash-SAM in a level comparable with the ENSO-SAM correlation in SON. 
The same analysis was performed using the Multivariate ENSO Index [@wolter2011] and the Southern Oscillation Index [@ropelewski1987], obtaining similar results.
The latter allows us to conclude that these results do not depend on the ENSO index used.

## Impacts {#impacts}

```{r compute-air-regr}
time_subset <- list(time = range(indices$time))

air <- ERA52mt() %>% 
  ReadNetCDF(vars = c("air" = "t2m"), 
             subset = c(time_subset, list(latitude = c(-90, 10)))) %>% 
  normalise_coords()

air_regr <- air %>% 
  # .[, air := Anomaly(air), by = .(lon, lat)] %>%
  .[indices_wide[lev == 700], on = .NATURAL] %>% 
  # mei[., on = .NATURAL] %>% 
  rm_singleton() %>% 
  .[year(time) %between% c(1981, 2018)] %>% 
  .[, lapply(.SD, mean, na.rm = TRUE), by = .(lon, lat, time = seasonally(time))] %>%
  .[, rbind(as.data.table(FitLm(air, asym, sym, se = TRUE)),
            as.data.table(FitLm(air, full, se = TRUE))),
    by = .(lon, lat, season(time))] %>% 
  rm_intercept() %>% 
  .[, term := factor(term, levels = names(lab_sam), ordered = TRUE)] 
```


(ref:regr-air-season-cap) Regression of seasonal mean surface land air and sea temperature anomalies (Kelvin) with SAM, A\nobreakdash-SAM and S\nobreakdash-SAM for the 1979 -- 2018 period. Black contours indicate areas with p-value smaller than 0.05 controlling for False Detection Rate. Note that the colour scale cuts-off at $\pm0.6 \mathrm{K}$ so the areas of very high values in the Antarctic don't wash out detail in the mid-latitudes and tropics. 

```{r regr-air-season, fig.cap = "(ref:regr-air-season-cap)", fig.width = 6, fig.height = 8, fig.env = "figure*", cache = FALSE}

anchor_limits <- function(anchor = 0, binwidth = NULL, exclude = NULL,  bins = 10,
                          range = c(NA, NA)) {
  force(range)
  force(anchor)
  force(binwidth)
  force(exclude)
  force(bins)
  function(x, binwidth2 = NULL) {
    if (!is.null(binwidth)) binwidth2 <- binwidth
    if (is.null(binwidth2)) {
      binwidth2 <- diff(pretty(x, bins))[1]
    }
    
    mult <- ceiling((x[1] - anchor)/binwidth2) - 1L
    start <- anchor + mult*binwidth2
    b <- seq(start, x[2] + binwidth2, binwidth2)
    b <- b[!(b %in% exclude)]
    
    if (!is.na(range[1])) {
      m <- min(b)
      b <- c(b[b >= range[1]], m)
    }
    
    if (!is.na(range[2])) {
      m <- max(b)
      b <- c(b[b <= range[2]], m)
    }
    sort(b)
    
  }
}

discrete_div <- colorRampPalette(c(scales::muted("blue"), "white",
                                   scales::muted("red")))

air_regr %>% 
  copy() %>% 
  .[, p.value := Pvaluate(estimate, std.error, df, "fdr"), by = .(term, season)] %>% 
  periodic(lon = c(0, 360)) %>% 
  ggplot(aes(lon, lat)) +
  geom_contour_fill(aes(z = estimate, fill = ..level..), 
                    breaks = anchor_limits(0, 0.1, 0, range = c(-.6, .6))) +
  geom_contour2(aes(z = p.value), breaks = c(0, 0.05), color = "black", size = 0.3) +
  
  geom_qmap(~.x[lat <= 0]) +
  geom_coords() +
  scale_x_longitude(labels = NULL) +
  scale_y_latitude(labels = NULL, limits = c(NA, 0)) +
  discrete_scale("fill", "name", name = "2-meter air temperature",
                 palette = discrete_div,
                 guide = guide_colorsteps_bottom(show.limits = TRUE)) +
  coord_polar() +
  facet_grid(season ~ term, labeller = labeller(term = lab_sam, lev = lev.lab)) +
  tag_facets("cr", position = list(x = 0.15, y = 0.85)) +
  no_grid +
  theme(panel.spacing = grid::unit(-1, "lines"))
```

To assess differences in the impacts associated with the SAM, A\nobreakdash-SAM and S\nobreakdash-SAM indices we regressed 2-meter air temperature and precipitation onto each of the three SAM indices at 700 hPa.
As shown in previous sections, the three indices are highly coherent in the troposphere, so we select this level to represent the tropospheric circulation for consistency with previous studies.
Regressions were done without detrending either the variables nor the indices, but computing the regressions with detrended values doesn't change the results (not shown).

Figure \@ref(fig:regr-air-season) shows regression coefficients of each index at 700 hPa with surface land air and sea temperature for each trimester.
In Summer, positive values of the SAM index (Figure \@ref(fig:regr-air-season)`r get_tag(season == "DJF" & term == "full")`) are associated with negative temperature anomalies near Antarctica which are surrounded by a ring of positive anomalies in the mid latitudes. 
The ring is not zonally symmetric, as there are four distinctive local maximums around 30\degree W, 120\degree W, 150\degree E and 90\degree E respectively.
In the tropics, there are negative anomalies in the equatorial Pacific, consistent with the negative correlation between SAM and ENSO.
Figure \@ref(fig:regr-air-season)`r combine_words(get_tag(season == "DJF" & term != "full", n = 2))` show temperature anomalies associated with positive values of A\nobreakdash-SAM and S\nobreakdash-SAM, respectively.
Both the local maximums in the ring and the anomalies in the Pacific regions are present mostly on the A\nobreakdash-SAM regression map, while temperature patterns linked to positive S\nobreakdash-SAM show a more zonally consistent ring and less relation to the tropics.
Over Antarctica positive values of the SAM index are associated with negative temperature anomalies, particularly over the Eastern coast. These anomalies are associated only with the S\nobreakdash-SAM. 
On the other hand, temperature anomalies in the Indian ocean, South Africa and Australia are strongly related to A\nobreakdash-SAM and are not present in the regression pattern with the SAM.


In Autumn, Winter and Spring (rows `r combine_words(get_row(season %in% c("MAM", "JJA", "SON"), n = 3))` in Figure \@ref(fig:regr-air-season)) the positive ring is only present through its local maximums in the regression with the SAM, which reflects the more asymmetric nature of the SAM compared to Summer. 
There are also negative anomalies in Southern Australia, and positive anomalies over New Zealand and Southern South America. 
Similar features were observed in station measurements by @jones2019, although using data from 1957 to 2016.
In Spring, the tropical signal of A\nobreakdash-SAM is similar to the one in Summer, again revealing the significance of the ENSO-A\nobreakdash-SAM link. 

The same regressions using temperature data from NOAA's Merged Land Ocean Global Surface Temperature Analysis V4.0.1 [@smith2008; @vose2012], which blends land surface air temperature and sea surface (water) temperature analysis into a monthly global grid are shown in Figure\ \@ref{fig:A10}.
Where data is available, the general patterns are similar, although with reduced magnitude, perhaps due to the fact that sea surface temperatures vary less. 


The pattern of negative anomalies in the pole surrounded by positive anomalies roughly seen in all seasons -- although with varying intensity and small-scale details -- translates to enhanced meridional temperature gradient maximised in the zero line, which is consistent with the intensification and poleward migration of the westerlies commonly linked to the SAM through thermal wind balance.
It's then not surprising to see it more clearly in association with S\nobreakdash-SAM (at least in Summer and Spring).
Temperatures over Eastern Antarctica are most impacted by the S\nobreakdash-SAM, while on Western Antarctica they are more sensitive to the A\nobreakdash-SAM. 
Considering the positive trend in the S\nobreakdash-SAM index, this might be consistent with temperature trends, which show warming in the West and no trend in the East [@nicolas2014].

Figure \@ref(fig:regr-air-season) column b can be partially compared with Figure 11 from @fogt2012.
Although they used station data from 1958 to 2001, main features are reproduced here, such as the strong signal in New Zealand and Australia in Summer and Spring.


```{r calc-indices2d-seasonal}
indices_2d_seasonal <- hgt[lev %in% 700] %>% 
  indices_wide[., on = .NATURAL, allow.cartesian = TRUE] %>% 
  .[, lapply(.SD, mean, na.rm = TRUE), by = .(lon, lat, time = seasonally(time))] %>% 
  .[, combine_lists(FitLm(hgt_a, sym, asym, se = TRUE),
                    FitLm(hgt_a, full, se = TRUE)),
    by = .(lon, lat, season(time))] %>% 
  rm_intercept() %>% 
  .[, p.val := Pvaluate(estimate, std.error, df, "fdr"), by = .(term, season)] %>% 
  periodic(lon = c(0, 360)) %>% 
  .[, term := factor(term, levels = names(lab_sam), ordered = TRUE)] 

indices_2d <- rbind(indices_2d_yearly[lev == 700] %>% .[, lev := NULL], indices_2d_seasonal) %>% 
  .[, season := forcats::fct_relevel(season, "Annual")] 
```

```{r compute-pp-regr}
# pp <- CMAP() %>% 
#   ReadNetCDF(subset = list(lat = c(-90, -20))) %>% 
#   normalise_coords() %>% 
#   .[, precip := Anomaly(precip), by = .(lon, lat)]

continents <- list(africa  = list(lon = c(0, 60),
                                  lat = c(-40, 0)),
                   oceania = list(lon = c(100, 180),
                                  lat = c(-50, -5)),
                   america = list(lon = c(265, 325),
                                  lat = c(-60, -10)))


add_continent <- function(dt) {
  dt[, continent := fcase(lon %between% continents$africa$lon & 
                            lat %between% continents$africa$lat, "africa",
                          lon %between% continents$oceania$lon & 
                            lat %between% continents$oceania$lat, "oceania",
                          lon %between% continents$america$lon &
                            lat %between% continents$america$lat, "america")] %>% 
    .[, continent := factor(continent, levels = c("africa", "oceania", "america"), ordered = TRUE)] %>% 
    .[]
}

pp <- CMAP() %>% 
  ReadNetCDF(subset = list(lat = c(-90, 0),
                           time = range(indices$time))) %>% 
  normalise_coords() %>%
  .[, days := lubridate::days_in_month(time[1]), by = time] 


pp_regr_season <- pp %>% 
  .[indices_wide[lev == 700], on = .NATURAL] %>% 

  .[, precip_a := Anomaly(precip,na.rm = TRUE), by = .(lon, lat, month(time))] %>% 
  .[, lapply(.SD, mean, na.rm = TRUE), by = .(lon, lat, time = seasonally(time))] %>%
  .[, precip_a := Anomaly(precip), by = .(lon, lat, season(time))] %>%
  .[, nas := mean(is.na(precip)), by = .(lon,  lat, season(time))] %>% 
  .[nas >= 0.15, precip := NA] %>% 
  # .[is.finite(precip_a)] %>%
  .[, combine_lists(FitLm(precip_a, asym, sym, se = TRUE),
                    FitLm(precip_a, full, se = TRUE)),
    by = .(lon, lat, season(time))] %>% 
  rm_intercept() %>% 
  .[, term := factor(term, levels = names(lab_sam), ordered = TRUE)] 

pp_regr_annual <- pp %>% 
  .[indices_wide[lev == 700], on = .NATURAL] %>% 
  .[, precip_a := Anomaly(precip, na.rm = TRUE), by = .(lon, lat, month(time))] %>% 
  .[, nas := mean(is.na(precip)), by = .(lon,  lat)] %>%
  .[nas >= 0.15, precip := NA] %>% 
  # .[is.finite(precip_a)] %>%
  .[, combine_lists(FitLm(precip_a, asym, sym, se = TRUE),
                    FitLm(precip_a, full, se = TRUE)),
    by = .(lon, lat)] %>% 
  rm_intercept() %>% 
  .[, term := factor(term, levels = names(lab_sam), ordered = TRUE)] %>% 
  .[, season := "Annual"]


pp_regr <- rbind(pp_regr_season, pp_regr_annual) %>% 
  .[, season := forcats::fct_relevel(season, "Annual")] 
```


(ref:global-pp-cap) Regression of annual and seasonal mean precipitation anomalies (mm per day, shading)  with a) SAM, b) A\\nobreakdash-SAM and c) S\\nobreakdash-SAM for the 1979 -- 2018 period. Thin lines are the Black contours indicate areas with p-value smaller than 0.05 controlling for False Detection Rate. Note that the colour scale cuts-off at $\pm0.25 \mathrm{K}$ so the areas of very high values in the Tropics don't wash out detail in the mid and high-latitudes.

```{r global-pp, fig.cap = "(ref:global-pp-cap)", fig.width=6, fig.height=3.5}
discrete_div_pp <- colorRampPalette(c("#8E521C", "white", "#00665E"))

breaks_pp <- sort(c(seq(-0.25, 0.25, by = 0.05), -0.7, 0.75))
breaks_pp <- breaks_pp[breaks_pp != 0]

lons <- c(0, unique(pp_regr$lon), 360)
pp_regr %>%
  .[season == "Annual"] %>%
  .[, p.value := Pvaluate(estimate, std.error, df, "fdr"), by = .(season, term)] %>% 
  # Need to interpolate 0 and 360 to get closed contours
  qwrap(lon = c(1.25, 360 + 1.25) ~ c(-1.25, 360 + 1.25)) %>% 
  .[, lapply(.SD, function(x) approx(lon, x, xout = lons)$y), by = .(lat, season, term)] %>%
  ggplot(aes(lon, lat)) +
  geom_contour_fill(aes(z = estimate, fill = ..level..), 
                    breaks = breaks_pp) +
  stat_subset(aes(subset = is.na(estimate)), geom = "tile", color = "gray50") +
  geom_contour2(aes(z = p.value), breaks = 0.05, size = 0.2) +
  geom_qmap(~.x[lat <= 0], keep = 0.015, weighting = 0.9) +
  scale_x_longitude(breaks = NULL) +
  scale_y_latitude(breaks = NULL, limits = c(-90, NA)) +
  discrete_scale("fill", "name", name = "Precipitation",
                 palette = discrete_div_pp,
                 guide = guide_colorsteps_bottom(show.limits = TRUE)) +
  scale_linetype(guide = "none") +
  coord_polar() +
  geom_coords() +
  # coord_quickmap(ylim = c(NA, 0)) +
  facet_grid(.~term, labeller = labeller(term = lab_sam)) +
  # tag_facets("panel", position = "tl")  +
  tag_facets("panel", position = list(x = 0.15, y = 0.85)) +
  no_grid +
  theme(panel.spacing = grid::unit(-1, "lines"))
```


Figure\ \@ref(fig:global-pp) shows regression of the SAM indices with precipitation for the Southern Hemisphere. 
The precipitation signal associated with SAM shows generally decreased precipitation at around 45ºS, somewhat increase precipitation around 30ªS (Fig.\ \@ref(fig:global-pp)a) and increased precipitation over Antarctica, a pattern known from other studies [e.g. @hendon2014].
This pattern is mostly unchanged between seasons albeit from varying in intensity. 
Panels b and c in Figure\ \@ref(fig:global-pp) shows that the A\nobreakdash-SAM signal is only in the tropics and mid-latitudes, while the S\nobreakdash-SAM signal is strong in the higher latitudes. 
In particular S\nobreakdash-SAM is associated with the increased precipitation over Antarctica and decrease precipitation around the Southern Ocean. 

To study in more detail the impacts over land, Figures \@ref(fig:pp-regr-oceania) and \@ref(fig:pp-regr-america) show regression of the SAM indices with seasonal mean precipitation and 700 hPa geopotential height for New Zealand and neighbouring islands, and South America respectively.
South Africa is not shown because no significant signal was detected there.


```{r def-plot_pp}
plot_pp <- function(this_continent, data = pp_regr) {
  gh <- indices_2d %>% 
    copy() %>%
    .[, c("u", "v") := GeostrophicWind(estimate, lon, lat, cyclical = TRUE), by = .(term, season)] %>%
    add_continent() %>% 
    .[continent == this_continent] 
  
  
  data %>%
    .[term != "mei"] %>% 
    add_continent() %>% 
    # .[lat <= -10] %>% 
    .[continent == this_continent] %>%
    .[, p.value := Pvaluate(estimate, std.error, df, "fdr"), by = .(season, continent, term)] %>%
    ggplot(aes(lon, lat)) +
    geom_contour_fill(aes(z = estimate), na.fill = 0, breaks = AnchorBreaks(0, 0.1, 0)) +
    stat_subset(aes(subset = is.na(estimate)), geom = "tile", color = "gray50") +
    # geom_raster(aes(fill = estimate/30)) +
    geom_contour2(aes(z = p.value), breaks = 0.05) +
    # geom_contour_fill(aes(z = as.numeric(is.na(estimate))), breaks = 1) +
    # stat_subset(aes(subset = p.value <= 0.05 & is.cross(lon, lat, 2)), size = 0.4, alpha = 0.8) +
    geom_contour2(data = gh, breaks = MakeBreaks(bins = 15, exclude = 0),
                  color = "gray50", size = 0.2, global.breaks = FALSE, 
                  aes(z = estimate, linetype = factor(-sign(..level..)))) +
    geom_text_contour(data = gh, breaks = MakeBreaks(bins = 15, exclude = 0),
                      global.breaks = FALSE,
                      size = 3,
                      stroke = 0.15, stroke.color = "white",
                      aes(z = estimate), rotate = FALSE, skip = 1) +
    geom_qmap(~.x[lat <= 10], keep = 0.015, weighting = 0.9) +
    scale_x_longitude(breaks = NULL) +
    scale_y_latitude(breaks = NULL) +
    scale_fill_divergent("Precipitation", 
                         limits = c(-.8, .8),
                         oob = scales::squish,
                         low = "#8E521C",
                         high = "#00665E",
                         # label = scales::percent_format(),
                         guide = guide_colorstrip_bottom(), 
                         breaks = AnchorBreaks(0, 0.1, 0)) +
    
    scale_linetype(guide = "none") +
    coord_quickmap(xlim = continents[[this_continent]]$lon,
                   ylim = continents[[this_continent]]$lat) +
    facet_grid(season ~ term, labeller = labeller(term = lab_sam, lev = lev.lab)) +
    tag_facets("cr", position = "bl")  +
    no_grid +
    axis_labs_smol
}

```

```{r pp-regr-oceania, dependson="def-plot_pp",  fig.cap = "Regression of (row 1) annual and (rows 2 to 5) seasonal mean precipitation anomalies (mm per day, shading) and 700~hPa geopotential height anomalies (thin lines, positive values as solid lines and negative values as dashed lines) with (column a) SAM, (column (b) A\\nobreakdash-SAM and (column c) S\\nobreakdash-SAM for the 1979 -- 2018 period. Thin lines are the Black contours indicate areas with p-value smaller than 0.05 controlling for False Detection Rate.", fig.width = 6, fig.height = 6.5, fig.env = "figure*"}
plot_pp("oceania") 
```

In Australia, the annual regression shows that the SAM index is associated with positive precipitation anomalies in the Southeastern region (Figure \@ref(fig:pp-regr-oceania)a.1), in agreement with @gillett2006.
The separation between A\nobreakdash-SAM and S\nobreakdash-SAM suggest that this positive anomaly is explained by the S\nobreakdash-SAM only in the East coast (Figure \@ref(fig:pp-regr-oceania)c.1).
Geopotential height anomalies associated with this index (black contours) are indicative of easterly flow from the Tasman Sea, which could explain the positive anomalies in precipitation as found by @hendon2007.
A\nobreakdash-SAM appears related to positive precipitation anomalies in the West coast of Southeastern Australia (Figure \@ref(fig:pp-regr-oceania)b.2), which could similarly be explained by the anomalous westerly circulation transporting moist air to the continent from the Indian Ocean.

The seasonal-based regressions show statistically significant anomalies only in Spring, when positive SAM is associated with positive precipitation anomalies in Eastern Australia (Figure \@ref(fig:pp-regr-oceania)a.5).
In this trimester, S\nobreakdash-SAM seems to be associated with positive precipitation anomalies in a relatively reduced area of the East Coast (Figure \@ref(fig:pp-regr-oceania)c.5) while the positive precipitation anomalies related with positive A\nobreakdash-SAM affect all Eastern Australia (Figure \@ref(fig:pp-regr-oceania)b.5).

In Summer, positive SAM index is associated with positive precipitation anomalies in Western and Eastern Australia, particularly in the North East (Figure \@ref(fig:pp-regr-oceania)a.2).
The Eastern part being dominated by the relationship with S\nobreakdash-SAM and the Western, by A\nobreakdash-SAM.
In Autumn, the regression with SAM shows positive anomalies in the North, similar to Summer, and a broad area of positive anomalies in the North-East to South-West direction.
This structure seems to be associated with the S\nobreakdash-SAM, while the Northern positive values are associated with the A\nobreakdash-SAM.
In Winter we see the same NE to SW aligned anomaly (although with much reduced amplitude) that is also present only in relation with the S\nobreakdash-SAM.
None of these regression coefficients are statistically significant at the 95% level.
The Spring signal is broadly consistent with @hendon2007, but whereas they also detected a strong signal in Summer, Figure \@ref(fig:pp-regr-oceania)a.2 shows no statistically significant association (although the coefficients have the consistent sign).

(ref:pp-rer-america-cap) Same as Figure \@ref(fig:pp-regr-oceania) but for South America.

```{r pp-regr-america, dependson = "def-plot_pp", fig.cap = "(ref:pp-rer-america-cap)", fig.width = 6, fig.height = 7.6, fig.env = "figure*"}
plot_pp("america")
```

In South America (Figure \@ref(fig:pp-regr-america)), regression using all seasons shows that positive SAM is associated with statistically significant negative precipitation anomalies in Southeastern South America (SESA) and Southern Chile, and non-significant positive anomalies in South Brazil, near the South Atlantic Convergence Zone (SACZ) (Figure \@ref(fig:pp-regr-america)a.1).
Figure \@ref(fig:pp-regr-america)b.1 and c.1 show that while the signal over SESA and southern Brazil is associated with A\nobreakdash-SAM, that in southern Chile is related to S\nobreakdash-SAM.

Except Winter, seasonal-based regressions mirror this same pattern.
Even if not statistically significant, they all show negative values in SESA and southern Chile along with positive values in southern Brazil in relation with the SAM.
The separation of these features between A\nobreakdash-SAM and S\nobreakdash-SAM regression maps is also rather consistent.

The anomalous circulation at 700 hPa associated with S\nobreakdash-SAM (Figure \@ref(fig:pp-regr-america)c.1) indicate anomalous easterly flow over Southern Chile. This leads to reduced influx of moist air from the Pacific Ocean which is the main source of precipitable water in that region [e.g. @garreaud2007]. On the other hand, the anomalous circulation associated with positive values of A\nobreakdash-SAM (Figure \@ref(fig:pp-regr-america)b.1) in the Atlantic is anticyclonic in the South and cyclonic in the North. This promotes anomalous South-Easterly flow over SESA, which inhibits the flow of the South America Low-Level Jet to the region [@silvestri2009; @zamboni2010]. This same pattern was found to be associated with increased precipitation in Southern Brazil during SACZ events [@rosso2018].
There is a small area of significant positive precipitation anomalies with the SAM near central Argentina which is also present in the station-based analysis by @gillett2006 that is explained by the A\nobreakdash-SAM.

## Conclusions

In this study we characterise the temporal and spatial variability of the zonally symmetric and asymmetric structure of the SAM.
By projecting monthly geopotential fields at each level with the corresponding asymmetric and symmetric pattern, we created two indices for representing the zonally asymmetric and symmetric contributions of the SAM respectively.

The A\nobreakdash-SAM index correlates strongly with the S\nobreakdash-SAM index.
In the troposphere, this correlation is maximum at zero lag, while in the stratosphere is maximised with the A\nobreakdash-SAM leading the S\nobreakdash-SAM by one month.
Since most indices of the SAM are calculated using surface or near-surface conditions, this result would suggest that they might not be sensitive to the most dramatic changes in SAM variability.

The periodicity of about two years we found in the stratospheric S\nobreakdash-SAM is consistent with the possible link between the SAM and the Quasi Biennial Oscillation as proposed by [@vasconcellos2020]. There is evidence of influence between the QBO and the Northern Annular Mode [e.g. @holton1980; @watson2014; @zhang2020], so it is not unlikely that the SAM would be similarly affected.
Establishing this link would require further research.

We observe a positive trend of SAM in Summer and Autumn, as was documented by previous studies [e.g. @fogt2020 and references therein] for low levels.
We show that these trends maximise at 100 hPa, and are explained by the zonally symmetric component.
We also find a statistically significant positive trend in the Symmetric component of the SAM in the stratosphere that is not evident in the SAM index.
We find some evidence of the SAM becoming more zonally asymmetric during DJF, as there is a slight positive trend in the variance explained by the as the A\nobreakdash-SAM.
This is in contrast to @fogt2012 who made the evaluation for the period 1958 -- 2001.
This discrepancy might be due either due to differences in methodology or analysed period.

In the troposphere, the spatial patterns of geopotential associated with the S\nobreakdash-SAM index are much closer to being fully annular than the patterns associated with the SAM index.
The A\nobreakdash-SAM index, on the other hand, describes a wave-3 pattern with maximum amplitude in the Pacific.
This pattern extends vertically in the troposphere but its maximum is located at 250 hPa, which also could suggest that surface-based indices are not optimal for capturing this variability.
This wave-3 pattern is similar to the Pacific-South American Pattern, linked to ENSO variability.
We found that the significant correlation that exists between the SAM index and the Oceanic Niño Index over this period is captured entirely by the A\nobreakdash-SAM index.
This suggests that ENSO is linked to SAM exclusively through the variability in the latter's asymmetric component and thus, the A\nobreakdash-SAM index could be a useful measure to further study that relationship.

Temperature anomalies associated with the SAM broadly show a pattern of negative anomalies at polar latitudes surrounded by positive anomalies, but with many deviations from symmetry.
The A\nobreakdash-SAM index explains a big portion of these deviations.
In particular, the positive phase of A\nobreakdash-SAM is associated with colder temperatures over Southern Brazil, South Africa and Southern Australia, as well as the negative anomalies in the equatorial Pacific consistent with the ENSO\nobreakdash-SAM relationship.
These negative anomalies are particularly clear in the DJF and SON trimesters, which include the months in which the ENSO teleconnection is more active [e.g. @cai2020a].

In Australia the SAM is associated with positive precipitation anomalies in South East and this is explained by the S\nobreakdash-SAM.
However, the A\nobreakdash-SAM is associated with a small area of positive precipitation anomalies in the Eastern Coast of West Australia, maybe due to advection of moist air from the Indian Ocean.

In South America, precipitation anomalies associated with the SAM are negative both in Southern Chile and Southeastern South America, and positive in Southern Brazil.
These features are cleanly separated between A\nobreakdash-SAM and S\nobreakdash-SAM.
S\nobreakdash-SAM explains the negative anomalies in Southern Chile and A\nobreakdash-SAM, the negative-positive dipole between Southeastern South America and Southern Brazil.
Individual seasons mostly follow this pattern.

Of note, even though the A\nobreakdash-SAM is significantly correlated with ENSO in all trimesters except JJA, precipitation patterns associated with the A\nobreakdash-SAM  are similar to precipitation patterns associated with ENSO only in SON in Australia, but in all trimesters in South America. 
This might indicate that the A\nobreakdash-SAM is closely related to the pathway between ENSO and precipitation patterns in South America but not so much with the pathway between ENSO and precipitation in Australia. 

@silvestri2009 suggest that precipitation impacts linked to the SAM changed strongly before and after 1980. In particular, the negative relationship with precipitation in South America was absent in some areas and switched sign in others in the earlier period. 
The correlation between ENSO and SAM is similarly non-stationary, also changing sign before the 1980s [@fogt2006; @clem2013].
Seeing as both the ENSO\nobreakdash-SAM relationship and most of the precipitation impacts in South America are captured by the A\nobreakdash-SAM, the magnitude and sign these impacts are most likely period-dependent and represent the average signal between 1979 and 2018.
The decadal variations of the A\nobreakdash-SAM should be focus of future studies.

By separating the zonally symmetric and zonally symmetric SAM signals, we show that the asymmetric component of the SAM has its unique variability, trends and impacts.
This is particularly important in the context of a changing climate, as the impact on the SAM of ozone recovery is modelled as highly zonally symmetric, while the impact of increased concentration of greenhouse gases has also a zonally asymmetric component [@arblaster2006].

```{=tex}
\begin{acknowledgements}
NOAA Global Surface Temperature (NOAAGlobalTemp) data provided by the NOAA/OAR/ESRL PSL, Boulder, Colorado, USA, from their Web site at https://psl.noaa.gov/ 
\end{acknowledgements}
```
# Declarations {.unnumbered}

## Funding {.unnumbered}

The research was supported by UBACyT20020170100428BA and the CLIMAX Project funded by Belmont Forum/ANR-15-JCL/-0002-01.
Elio Campitelli was supported by a PhD grant from CONICET, Argentina.

## Conflicts of interest {.unnumbered}

The authors declare that they have no conflict of interest.

## Availability of data and material {.unnumbered}

All data used in this paper is freely available from their respective sources.
ERA5 data can be obtained via the Copernicus Climate Data Store ([\<https://cds.climate.copernicus.eu/cdsapp\#!/dataset/reanalysis-era5-pressure-levels-monthly-means\>](https://cds.climate.copernicus.eu/cdsapp#!/dataset/reanalysis-era5-pressure-levels-monthly-means){.uri}).
CMAP Precipitation data provided by the NOAA/OAR/ESRL PSL, Boulder, Colorado, USA, from their Web site at <https://psl.noaa.gov/data/gridded/data.cmap.html>.
The Oceanic Niño Index is available via NOAA's Climate Prediction Center: <https://www.cpc.ncep.noaa.gov/products/analysis_monitoring/ensostuff/detrend.nino34.ascii.txt>
The SAM, A\nobreakdash-SAM and S\nobreakdash-SAM indices are available at the public repository associated with this paper, at <https://github.com/eliocamp/asymsam/tree/master/analysis/data/derived_data>. 

## Code availability {.unnumbered}

A version-controlled repository of the code used to create this analysis, including the code used to download the data can be found at <https://github.com/eliocamp/asymsam>.

<!-- \bibliography{AsymSAM,packages} -->

\newpage

\appendix

\counterwithin{figure}{section}

# Extra figures

\newpage

```{r A3, fig.cap = "50~hPa geopotential height zonal anomalies (meters) of composites of positive and negative SAM months selected using $\\pm1$ standard deviation as threshhold for the 1979 -- 2018 period. Numbers in the column headers are the spatial correlation between SAM+ and SAM- composites and number of monthly fields used to construct each composite.", apendix = TRUE, fig.height = 5, fig.width = 6}
composites <- hgt[lev %in% c(50, 700)] %>%
  indices_wide[., on = .NATURAL] %>% 
  .[, sign := ifelse(abs(full) > sd(full), sign(full), 0), by = .(lev, month(time))] %>% 
  .[, .(hgt = mean(hgt_a), n = .N), by = .(lon, lat, sign, lev, season(time))] %>% 
  .[, z := Anomaly(hgt), by = .(lat, sign, season, lev)] 


plot_composites <- function(this_lev) {
  composites <- composites[lev == this_lev]
  
  composites_cors <- composites %>% 
    dcast(season + lat + lon  ~ sign, value.var = "z") %>% 
    .[, .(cor = cor(`-1`, `1`)), by = .(season)]
  
  tags <- composites[order(sign, season)][sign != 0, paste0("n: ", unique(n)), by = .(sign, season)]
  if (this_lev == 50) {
    limits <- c(-119, 179) 
  } else {
    limits <- c(-59, 74)
  }
  
  composites %>% 
    .[sign != 0] %>% 
    composites_cors[., on = c("season")] %>% 
    .[order(season)] %>% 
    .[, season_text := paste0(season, "\ncor: ", signif(cor, 2))] %>% 
    .[, season_text := factor(season_text, levels = unique(season_text), ordered = TRUE)] %>% 
    periodic(lon = c(0, 360)) %>% 
    ggplot(aes(lon, lat)) +
    geom_contour_fill(aes(z = z), breaks = AnchorBreaks(0,exclude = 0), global.breaks = FALSE) +
    geom_contour_tanaka2(aes(z = z), breaks = AnchorBreaks(0,exclude = 0), global.breaks = FALSE) +
    
    geom_qmap(~.x[lat <= 0]) +
    geom_coords() +
    scale_x_longitude(labels = NULL) +
    scale_y_latitude(limits = c(NA, -20), labels = NULL) +
    scale_fill_divergent(NULL, guide = guide_colorstrip_bottom(),
                         limits = limits,
                         breaks = AnchorBreaks(0, binwidth = 15, exclude = 0)) +
    coord_polar() +
    axis_labs_smol +
    no_grid +
    facet_grid(sign~season_text, labeller = labeller(sign = c("-1" = "SAM-", "1" = "SAM+"))) +
    tag_facets(tag_pool = tags$V1, tag_suffix = "")
}
plot_composites(50)
```

(ref:a4-cap) Same as \@ref(fig:A3) but for 700 hPa geopotential height.

```{r A4, fig.cap = "(ref:a4-cap)", apendix = TRUE, fig.height = 4.5, fig.width = 6}
plot_composites(700)
```

```{r A5, fig.cap = "Regression coefficients of 50~hPa and 700~hPa geopotential height zonal anomalies (meters) onto the standarised timeseries of the leading EOF computed for each season independently for the 1979 -- 2018 period.",  apendix = TRUE, fig.width=6, fig.height=4.5}
set.seed(42)
SAM_season <- hgt[lat <= -20] %>% 
  .[lev %in% c(700, 50)] %>% 
  .[, hgt := hgt_a*sqrt(cos(lat*pi/180))] %>% 
  .[, season := season(time)] %>% 
  .[, .(eof = list(EOF(hgt ~ time | lon + lat, n = 1, data = .SD))), 
    by = .(season, lev)]


patterns <- SAM_season[, eof[[1]]$left, by = .(lev, season)] %>% 
  copy() %>% 
  setnames("hgt", "EOF") %>% 
  .[, EOF := EOF/sd(EOF), by = .(season, lev)] %>% 
  hgt[., on = c("time", "lev")] %>%
  .[, FitLm(hgt_a, EOF), by = .(lon, lat, lev, season)] %>%
  rm_intercept() %>% 
  .[season == "DJF", estimate := -estimate] %>% 
  .[, estimate_a := Anomaly(estimate), by = .(lat, lev, season)] %>% 
  .[season == "DJF" & lev == 700, estimate_a := -estimate_a]


cors <- patterns %>% 
  .[ , f := as.character(interaction(lon, lat)), by = lev] %>% 
  .[, widyr::pairwise_cor(.SD, season, f, estimate_a, upper = FALSE), by = lev]

plot_patterns <- function(this_lev) {
  limits <- NULL
  breaks <- if (this_lev == 50) AnchorBreaks(0, 20, exclude = 0) else AnchorBreaks(0, 5, exclude = 0)
  patterns %>% 
    .[lev == this_lev] %>% 
    periodic(lon = c(0, 360)) %>% 
    copy() %>% 
    # .[, estimate_a := estimate_a/sd(estimate_a), by = .( lev)] %>% 
    ggplot(aes(lon, lat)) +
    geom_contour_fill(aes(z = estimate_a), breaks = breaks) +
    geom_contour_tanaka2(aes(z = estimate_a), breaks = breaks) +
    geom_qmap(~.x[lat <= 0]) +
    scale_x_longitude(labels = NULL) +
    scale_y_latitude(limits = c(NA, -20), labels = NULL) +
    scale_fill_divergent(NULL,
                         guide = guide_colorstrip_bottom(),
                         limits = limits,
                         breaks = breaks) +
    coord_polar() +
    geom_coords() +
    axis_labs_smol +
    no_grid +
    facet_grid(lev~season, labeller = labeller(lev = lev.lab))
}

plot_patterns(50) +
  plot_patterns(700) +
  plot_layout(ncol = 1) 
```

```{r A6, fig.cap = "Regression of 50~hPa and 700~hPa geopotential height zonal anomalies (meters) onto the standarised timeseries of the leading EOF computed for the periods 1979 -- 1998 and 1999 -- 2018. Spatial correlation between both fields is 0.86 for the 50~hPa fields and 0.76 for the 700~hPa fields.", fig.width=6, fig.height=5}
set.seed(42)
SAM_prepost <- hgt[lat <= -20] %>% 
  .[lev %in% c(700, 50)] %>%
  .[, hgt := hgt_a*sqrt(cos(lat*pi/180))] %>% 
  
  .[, year := year(time)] %>% 
  .[, period := factor(ifelse(year(time) <= 1998, "pre", "post"),
                       levels = c("pre", "post"), ordered = TRUE,
                       labels = c("1979-1998", "1999-2018"))] %>%
  .[, .(eof = list(EOF(hgt ~ time | lon + lat, n = 1, data = .SD))), 
    by = .(period, lev)]

sam_sep <- SAM_prepost[, eof[[1]]$right, by = .(lev, period)] %>% 
  setnames("hgt", "full") %>% 
  .[, c("sym", "asym") := list(mean(full), Anomaly(full)), by = .(lat, period, lev)] 

patterns <- SAM_prepost[, eof[[1]]$left, by = .(period, lev)] %>% 
  copy() %>% 
  setnames("hgt", "EOF") %>% 
  .[, EOF := EOF/sd(EOF), by = .(period, lev)] %>% 
  .[period == "1979-1998" & lev == 50, EOF := -EOF] %>% 
  rm_singleton() %>% 
  hgt[., on = .NATURAL] %>% 
  # .[lev == 700] %>% 
  .[, FitLm(hgt_a, EOF), by = .(lon, lat, period, lev)] %>%
  rm_intercept() %>% 
  # .[season == "DJF", estimate := -estimate] %>% 
  .[, estimate_a := Anomaly(estimate), by = .(lat, period, lev)] 

cor <- patterns %>% 
  dcast(lon + lat + lev ~ period, value.var = "estimate_a") %>% 
  .[, cor(`1979-1998`, `1999-2018`), by = lev]

patterns %>% 
  .[lev == 50 & period == "1999-2018", estimate_a := -estimate_a] %>% 
  periodic(lon = c(0, 360)) %>%
  ggplot(aes(lon, lat)) +
  geom_contour_fill(aes(z = estimate_a), breaks = AnchorBreaks(0, 5, 0)) +
  geom_contour_tanaka2(aes(z = estimate_a), breaks = AnchorBreaks(0, 5, 0)) +
  geom_qmap() +
  scale_x_longitude(labels = NULL) +
  scale_y_latitude(limits = c(NA, -20), labels = NULL) +
  scale_fill_divergent(NULL, 
                       guide = guide_colorstrip_bottom(),
                       breaks = AnchorBreaks(0, 5, exclude = 0)) +
  coord_polar() +
  geom_coords() +
  facet_grid(lev~period, labeller = labeller(lev = lev.lab)) +
  axis_labs_smol +
  no_grid 
```


```{r A1, fig.cap = "Lag-correlation between the A\\nobreakdash-SAM and the S\\nobreakdash-SAM index at each level. Negative lags imply A\\nobreakdash-SAM leading S\\nobreakdash-SAM and vice versa. For the 1979 -- 2018 period.", fig.width = 5, fig.height=5, fig.pos="ht"}
ccf_dt <- function(..., plot = FALSE) {
  stat <- ccf(..., plot = plot)
  list(lag = stat$lag[, 1, 1], 
       acf = stat$acf[, 1, 1])
}

indices_wide %>% 
  .[, ccf_dt(asym, sym, lag.max = 5), by = .(lev)] %>% 
  ggplot(aes(lag, lev)) +
  geom_contour_fill(aes(z = acf), breaks = AnchorBreaks(0, 0.05)) +
  geom_contour_tanaka2(aes(z = acf), breaks = AnchorBreaks(0, 0.05)) +
  geom_vline(xintercept = 0) +
  scale_fill_divergent(NULL,
                       guide = guide_colorstrip_bottom(20),
                       breaks = AnchorBreaks(0, 0.05),
                       limits = c(NA, .59)) +
  scale_x_continuous("Lag (months)\nA-SAM leads S-SAM              S-SAM leads A-SAM", 
                     breaks = seq(-5, 5, 1), 
                     expand = c(0, 0)) +
  scale_y_level()
```

```{r A2, fig.cap = "Fourier spectrum of each timeseries computed as Fourier transform smoothed with modified Daniell smoothers with widths 3 and 5. The shading indicates de 95\\% confidence area derived by computing the spectrum for 5000 simulated samples from a fitted autorregressive model and (95\\% of the simulated sampels had an amplitude equal or lower). The light line indicates the theoretical expected amplitude from the autorregressive model. For the 1979 -- 2018 period.", fig.height=4, fig.width=6}
spec %>%
  # .[term != "full"] %>% 
  ggplot(aes(1/freq/12, spec)) +
  geom_ribbon(aes(ymin = 0, ymax = `95%`), position = "dodge", alpha = 0.1) +
  geom_line(aes(y = ar_spectrum), alpha = 0.15) +
  geom_line() +
  annotation_logticks(sides = "b") +
  scale_color_brewer(NULL, palette = "Dark2", aesthetics = c("color", "fill")) +
  scale_x_log10("Period (years)", sec.axis = sec_axis(~.*12, name = "Period (months)")) +
  scale_y_continuous("Spectrum") +
  facet_grid(lev ~ term,labeller = labeller(lev = lev.lab, term = lab_sam), scales = "free") +
  tag_facets() 
```

```{r compute-air-regr-noaa}
time_subset <- list(time = range(indices$time))
air <- NOAATemp() %>% 
  ReadNetCDF(vars = "air", subset = c(time_subset, list(lat = c(-90, 10)))) %>% 
  normalise_coords()  %>%
  # Interpolate at lon = 0. Otherwise, can't close contours. 
  qwrap(lon = c(0, 360) ~ c(-2.5, 360)) %>% 
  .[ , Interpolate(air ~ lon + lat, x.out = c(0, unique(lon)), y.out = unique(lat)), by = time] %>% 
  .[lon != -2.5]


# air <- ReadNetCDF("~/DATOS/reanalysis/ERA5/mon/era5sl.mon.mean.nc", 
#            vars = c(air = "t2m"), subset = c(time_subset, list(lat = c(-90, 10)))) %>% 
#   normalise_coords()  

air_regr <- air %>% 
  # .[, air := Anomaly(air), by = .(lon, lat)] %>%
  .[indices_wide[lev == 700], on = .NATURAL] %>% 
  # mei[., on = .NATURAL] %>% 
  rm_singleton() %>% 
  .[, lapply(.SD, mean, na.rm = TRUE), by = .(lon, lat, time = seasonally(time))] %>%
  .[, nas := mean(is.na(air)), by = .(lon, lat, season(time))] %>%
  .[nas >= 0.15, air := NA] %>%
  .[, rbind(as.data.table(FitLm(air, asym, sym, se = TRUE)),
            as.data.table(FitLm(air, full, se = TRUE))),
    by = .(lon, lat, season(time))] %>% 
  rm_intercept() %>% 
  .[, term := factor(term, levels = names(lab_sam), ordered = TRUE)] 
```

```{r A10, fig.cap = "Regression of seasonal mean surface land air and sea temperature anomalies (Kelvin) with SAM, A\\nobreakdash-SAM and S\\nobreakdash-SAM for the 1979 -- 2018 period. Black contours indicate areas with p-value smaller than 0.05 controlling for False Detection Rate. Gray areas in Antarctica have more than 15\\% of missing data.", fig.width = 6, fig.height = 8, fig.env = "figure*", cache = FALSE}
air_regr %>% 
  copy() %>% 
  .[, p.value := Pvaluate(estimate, std.error, df, "fdr"), by = .(term, season)] %>% 
  periodic(lon = c(0, 360)) %>% 
  ggplot(aes(lon, lat)) +
  geom_contour_fill(aes(z = estimate), 
                    breaks = AnchorBreaks(0, 0.1, 0)) +
  geom_contour2(aes(z = p.value), breaks = c(0, 0.05), color = "black", size = 0.3) +
  geom_contour_fill(aes(z = as.numeric(is.na(estimate))), breaks = c(0.5, 2), fill = "gray") +
  geom_contour2(aes(z = as.numeric(is.na(estimate))), breaks = c(0.5, 2), color = "gray50") +
  geom_qmap(~.x[lat <= 0]) +
  geom_coords() +
  scale_x_longitude(labels = NULL) +
  scale_y_latitude(labels = NULL, limits = c(NA, 0)) +
  scale_fill_divergent("2-meter air temperature",  
                       limits = c(-0.6, .6), 
                       oob = scales::squish,
                       guide = guide_colorstrip_bottom(), breaks = AnchorBreaks(0, 0.1, 0)) +
  coord_polar() +
  facet_grid(season ~ term, labeller = labeller(term = lab_sam, lev = lev.lab)) +
  tag_facets("cr", tag_suffix = "") +
  no_grid 
```


\newpage
